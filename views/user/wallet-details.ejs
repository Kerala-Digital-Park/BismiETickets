<%- include('./partials/header') %>
    <%- include('./partials/userHeader') %>

        <!-- **************** MAIN CONTENT START **************** -->
        <main>

            <!-- =======================
    Content START -->
            <section class="pt-3">
                <div class="container">
                    <div class="row g-2 g-lg-4">

                        <!-- Sidebar START -->
                        <%- include('./partials/userSidebar') %>
                            <!-- Sidebar END -->

                            <!-- Main content START -->
                            <div class="col-lg-8 col-xl-9 ps-xl-5">

                                <!-- Offcanvas menu button -->
                                <div class="d-grid mb-0 d-lg-none w-100">
                                    <button class="btn btn-primary mb-4" type="button" data-bs-toggle="offcanvas"
                                        data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                                        <i class="fas fa-sliders-h"></i> Menu
                                    </button>
                                </div>

                                <!-- Payment detail START -->
                                <div class="card bg-transparent ">
                                    <!-- Card header -->

                                    <!-- Card body START -->
                                    <div class="card-body p-2 p-sm-4">
                                        <div class="row g-4">
                                            <div class="col-md-6 ">
                                                <!-- Visa card -->
                                                <div class="card card-body shadow p-4">
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <!-- Number -->
                                                        <div class="me-2">
                                                            <span>Wallet Balance</span>
                                                            <h3 class="mb-0 mt-2">₹ <%=walletBalance ? walletBalance.toFixed(2) : "0.00"%>
                                                            </h3>
                                                        </div>
                                                        <!-- Icon -->
                                                        <div
                                                            class="icon-lg rounded-circle flex-shrink-0 bg-primary bg-opacity-10 text-primary mb-0">
                                                            <i class="bi bi-wallet2"></i>
                                                        </div>
                                                    </div>
                                                    <!-- Progress bar -->
                                                    <div class="progress progress-xs bg-primary bg-opacity-10 mb-2">
                                                        <div class="progress-bar bg-primary" role="progressbar"
                                                            style="width: <%=walletBalance%>%"
                                                            title="used on this month"
                                                            aria-valuenow="<%=walletBalance%>" aria-valuemin="0"
                                                            aria-valuemax="<%=walletLimit%>">
                                                        </div>
                                                    </div>
                                                    <span><span class="text-primary">₹ <%=walletLimit%></span> Your
                                                        Limit</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6 ">
                                                <div class="card card-body shadow p-4">
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <!-- Number -->
                                                        <div class="me-2">
                                                            <span>Rewards</span>
                                                            <h3 class="mb-0 mt-2">₹ <%=rewardBalance ? rewardBalance.toFixed(2) : "0.00"%>
                                                            </h3>
                                                        </div>
                                                        <!-- Icon -->
                                                        <div
                                                            class="icon-lg rounded-circle flex-shrink-0 bg-orange bg-opacity-10 text-orange mb-0">
                                                            <i class="bi bi-cash-stack"></i>
                                                        </div>
                                                    </div>
                                                    <!-- Progress bar -->
                                                    <div class="progress progress-xs bg-orange bg-opacity-10 mb-2">
                                                        <div class="progress-bar bg-orange" role="progressbar"
                                                            title="Used on this month" style="width: 100%"
                                                            aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
                                                        </div>
                                                    </div>
                                                    <span>
                                                        <%=rewardExpiryStatus%>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Tabs for Wallet / Reward History -->
                                    <ul class="nav nav-tabs mb-3" id="walletRewardTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="wallet-tab" data-bs-toggle="tab"
                                                data-bs-target="#walletHistory" type="button" role="tab">
                                                Wallet History
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="reward-tab" data-bs-toggle="tab"
                                                data-bs-target="#rewardHistory" type="button" role="tab">
                                                Reward History
                                            </button>
                                        </li>
                                    </ul>

                                    <div class="tab-content" id="walletRewardTabsContent">
                                        <!-- Wallet History Tab -->
                                        <div class="tab-pane fade show active" id="walletHistory" role="tabpanel"
                                            aria-labelledby="wallet-tab">
                                            <div class="card border">
                                                <div class="card-header border-bottom d-flex justify-content-between">
                                                    <h5 class="card-title mb-0">Wallet History</h5>
                                                    <button class="btn  btn-primary-soft mb-0 ms-auto flex-shrink-0"
                                                        data-bs-toggle="modal" data-bs-target="#load">
                                                        <i class="bi bi-plus-lg me-2"></i>Load Cash
                                                    </button>
                                                </div>
                                                <div class="card-body">
                                                    <div class="table responsive">

                                                        <table
                                                            class="table align-middle p-4 mb-0 table-hover table-shrink">
                                                            <!-- Table head -->
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th scope="col" class="border-0 rounded-start">
                                                                        Invoice ID</th>
                                                                    <th scope="col" class="border-0">Date</th>
                                                                    <th scope="col" class="border-0">Amount</th>
                                                                    <th scope="col" class="border-0">Status</th>
                                                                    <th scope="col" class="border-0 rounded-end">Purpose
                                                                    </th>
                                                                </tr>
                                                            </thead>

                                                            <!-- Table body START -->
                                                            <tbody class="border-top-0">
                                                                <%if(walletHistory.length>0) {%>
                                                                    <%walletHistory.forEach((trs)=>{%>
                                                                        <% let statusClass; if(trs.status==="Paid" ){
                                                                            statusClass="bg-success bg-opacity-10 text-success"
                                                                            } else if(trs.status==="Cancelled" ) {
                                                                            statusClass="bg-danger bg-opacity-10 text-danger"
                                                                            } else if(trs.status==="Loaded" ){
                                                                            statusClass="bg-success bg-opacity-10 text-success"
                                                                            } else {
                                                                            statusClass="bg-orange bg-opacity-10 text-orange"
                                                                            } %>
                                                                            <!-- Table item -->
                                                                            <tr>
                                                                                <td>
                                                                                    <%=trs.transactionId%>
                                                                                </td>
                                                                                <td>
                                                                                    <%= new
                                                                                        Date(trs.createdAt).toLocaleDateString("en-GB",
                                                                                        { day: "2-digit" ,
                                                                                        month: "short" , year: "numeric"
                                                                                        }) %>
                                                                                </td>

                                                                                <td>
                                                                                    <%=trs.amount%>
                                                                                </td>
                                                                                <td>
                                                                                    <div class="badge <%=statusClass%>">
                                                                                        <%=trs.status%>
                                                                                    </div>
                                                                                </td>
                                                                                <td>
                                                                                    <%=trs.purpose%>
                                                                                </td>
                                                                            </tr>
                                                                            <%})%>
                                                                                <%} else { %>
                                                                                    <tr>
                                                                                        <td colspan="5"
                                                                                            class="text-center">No
                                                                                            wallet history</td>
                                                                                    </tr>
                                                                                    <%}%>
                                                            </tbody>
                                                            <!-- Table body END -->
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Add new card END -->
                                        </div>

                                        <!-- Reward History Tab -->
                                        <div class="tab-pane fade" id="rewardHistory" role="tabpanel"
                                            aria-labelledby="reward-tab">
                                            <div class="card border">
                                                <div class="card-header border-bottom">
                                                    <h5 class="card-title mb-0">Reward History</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="table responsive">
                                                        <table
                                                            class="table align-middle p-4 mb-0 table-hover table-shrink">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Title</th>
                                                                    <th>BookingID</th>
                                                                    <th>Points</th>
                                                                    <th>Status</th>
                                                                    <th>Expiry Date</th>
                                                                    <th>Action</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <% if(rewardHistory.length> 0) { %>
                                                                    <% rewardHistory.forEach(rw=> { %>
                                                                        <tr>
                                                                            <td>
                                                                                <%= rw.title %>
                                                                            </td>
                                                                            <td>
                                                                                <%= rw.description.replace("Reward for booking #", "") %>
                                                                            </td>
                                                                            <td>
                                                                                <%= rw.points %>
                                                                            </td>
                                                                            <td>
                                                                                <% let rClass; 
                                                                                if(rw.status==="redeemed"){
                                                                                    rClass="bg-success bg-opacity-10 text-success"
                                                                                    } else if(rw.status==="expired" ){
                                                                                    rClass="bg-danger bg-opacity-10 text-danger"
                                                                                    } else {
                                                                                    rClass="bg-orange bg-opacity-10 text-orange"
                                                                                    } %>
                                                                                    <div class="badge <%=rClass%>">
                                                                                        <%=rw.status%>
                                                                                    </div>
                                                                            </td>
                                                                            <td>
                                                                                <%= rw.expiryDate ? new
                                                                                    Date(rw.expiryDate).toLocaleDateString("en-GB",{
                                                                                    day:"2-digit", month:"short",
                                                                                    year:"numeric"}) : "-" %>
                                                                            </td>
<td>
  <% if (rw.status === "active") { %>
    <button class="btn btn-sm btn-primary"
      onclick="redeemReward('<%= rw._id %>')">
      Redeem
    </button>
  <% } else if (rw.status === "redeemed") { %>
    <button class="btn btn-sm btn-success" disabled>
      Redeemed
    </button>
  <% } else if (rw.status === "expired") { %>
    <button class="btn btn-sm btn-secondary" disabled>
      Expired
    </button>
  <% } %>
</td>

                                                                        </tr>
                                                                        <% }) %>
                                                                            <% } else { %>
                                                                                <tr>
                                                                                    <td colspan="6" class="text-center">
                                                                                        No reward history</td>
                                                                                </tr>
                                                                                <% } %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <!-- Payment detail END -->

                                </div>
                            </div>
                            <!-- Main content END -->
                    </div>
                </div>
            </section>
            <!-- =======================
    Content END -->

            <!-- load cash modal START -->
            <div class="modal fade" id="load" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <!-- Title -->
                        <div class="modal-header">
                            <h5 class="modal-title">Load Cash</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <!-- Body -->
                        <div class="modal-body p-3">
                            <div class="row g-4 mb-5">
                                <div class="col-sm-6 form-group"> <label class="form-label h6 fw-normal mb-1"><i
                                            class="bi bi-cash text-primary me-1"></i> Amount</label>
                                    <div class="form-border-bottom form-control-transparent form-fs-lg mt-2">
                                        <input type="number" id="loadAmount" class="form-control" maxlength="4"
                                            placeholder="Type amount">
                                    </div>
                                </div>
                                <div class="col-sm-6 form-group">
                                    <label class="form-label h6 fw-normal mb-1"><i
                                            class="bi bi-passport text-primary me-1"></i>Pay Method</label>
                                    <div class="form-border-bottom form-control-transparent form-fs-lg mt-2">
                                        <select id="paymentMethod" class="form-control" required>
                                            <option class="opt" value="">--Select Method--</option>
                                            <option class="opt" value="Credit Card">Credit Card</option>
                                            <option class="opt" value="Debit Card">Debit Card</option>
                                            <option class="opt" value="Rupay Debit Card">Rupay Debit Card</option>
                                            <option class="opt" value="Upi">Upi</option>
                                            <option class="opt" value="Wallet">Wallet</option>

                                        </select>
                                    </div>
                                </div>

                            </div>
                            <div class="modal-footer bg-light mb-2">
                                <button type="button" id="submitLoadCash" class="btn btn-sm btn-outline-primary mb-0">
                                    Submit
                                </button>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
            <!-- load cash modal END -->

<script>
function redeemReward(rewardId) {
    Swal.fire({
      title: "Are you sure?",
      text: "Do you want to redeem this reward?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, redeem it!",
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/rewards/redeem/${rewardId}`, { method: "POST" })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              Swal.fire({
                icon: "success",
                title: "Redeemed!",
                text: "Reward redeemed successfully.",
                timer: 1500,
                showConfirmButton: false,
              }).then(() => {
                location.reload();
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "Failed",
                text: data.message || "Failed to redeem reward.",
              });
            }
          })
          .catch((err) => {
            console.error(err);
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Error redeeming reward.",
            });
          });
      }
    });
  }
</script>
            <script>
                document.getElementById("submitLoadCash").addEventListener("click", () => {
                    const amount = document.getElementById("loadAmount").value.trim();
                    const method = document.getElementById("paymentMethod").value;

if (!amount || !method) {
  Swal.fire({
    icon: "warning",
    title: "Missing Details",
    text: "Please enter an amount and select a payment method.",
    confirmButtonText: "OK"
  });
  return;
} 

                    // Create a hidden form and submit it
                    const form = document.createElement("form");
                    form.method = "POST";
                    form.action = "/payment/initiate-load-wallet";

                    const amtInput = document.createElement("input");
                    amtInput.type = "hidden";
                    amtInput.name = "amount";
                    amtInput.value = amount;
                    form.appendChild(amtInput);

                    const methodInput = document.createElement("input");
                    methodInput.type = "hidden";
                    methodInput.name = "method";
                    methodInput.value = method;
                    form.appendChild(methodInput);

                    document.body.appendChild(form);
                    form.submit(); // browser follows the 302 and goes to HDFC
                });

            </script>
        </main>
        <!-- **************** MAIN CONTENT END **************** -->

        <%- include('./partials/footer') %>