<%- include('./partials/header') %>
    <%- include('./partials/userHeader') %>

        <!-- **************** MAIN CONTENT START **************** -->
        <main>

            <!-- ======================= Content START -->
            <section class="pt-3">
                <div class="container">
                    <div class="row">

                        <%- include('./partials/userSidebar') %>

                            <!-- Main content START -->
                            <div class="col-lg-8 col-xl-9">

                                <!-- Offcanvas menu button -->
                                <div class="d-grid mb-0 d-lg-none w-100">
                                    <button class="btn btn-primary mb-4" type="button" data-bs-toggle="offcanvas"
                                        data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                                        <i class="fas fa-sliders-h"></i> Menu
                                    </button>
                                </div>
                                <!-- Offcanvas menu button END -->

                                <div class="row g-4">
                                    <div class="d-flex flex-wrap justify-content-between">
                                        <div class="header">
                                            <h4>My Subscriptions</h4>
                                            <p>Here is list of package/product that you have subscribed.</p>
                                        </div>
                                        <div class="mt-4">
                                            <div class="col-md-auto ms-auto text-center">
                                                <% if(userDetails.userRole === "User") { %>
                                                    <a href="/subscription" class="btn btn-primary">Change Plan</a>
                                                <% } else { %>
                                                    <a href="/join-us" class="btn btn-primary">Change Plan</a>
                                                <% } %>

                                            </div>
                                        </div>
                                    </div>
                                    <% if(userDetails) { %>
                                    <div class="card border-1 rounded-0 d-flex flex-row p-0">
                                        <div class="col-lg-8 p-2">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div>
                                                    <h5><%= userDetails.subscription.subscription %> Plan 
                                                        <% 
                                                            const today = new Date();
                                                            const expiryDate = new Date(userDetails.expiryDate); 
                                                            if (expiryDate < today) { 
                                                        %>
                                                        <span class="badge bg-danger rounded-3" style="font-size: x-small;">Expired</span>
                                                        <% } else { %>
                                                            <span class="badge bg-success rounded-3" style="font-size: x-small;">Active</span>
                                                    <% } %></h5>
                                                    <!-- <small class="mb-0">Subscription ID: 100394949</small> -->
                                                </div>
                                               
                                            </div>
                                            <div class="row d-flex justify-content-between align-items-center">
                                                <div class="col-md-auto mb-3 mb-md-0 d-flex flex-column">
                                                    <p>Started On</p>
                                                    <% 
                                                        const date = new Date(userDetails.subscriptionDate);
                                                        const options = { month: 'short', day: 'numeric', year: 'numeric' };
                                                        const formattedDate = date.toLocaleDateString('en-US', options);
                                                    %>
                                                    <%= formattedDate %> 
                                                </div>
                                                
                                                <div class="col-md-auto mb-3 mb-md-0">
                                                    <p>Price</p>
                                                    â‚¹ <%= userDetails.subscription.price %>
                                                </div>
                                                <div class="col-md-auto mb-3 mb-md-0">
                                                    <p>Access</p>
                                                    <% if(userDetails.subscription.subscription === "Enterprise") { %>
                                                    <span>Unlimited</span>
                                                    <% } else if(userDetails.subscription.subscription === "Pro" || "Base") { %>
                                                    <span>Limited</span>
                                                    <% } else { %>
                                                    <span>No Access</span>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4 bg-light p-2 ">
                                            
                                            <%
                                            const expiry = new Date(userDetails.expiryDate);
                                            const now = new Date();
                                          %>
                                          
                                          <div class="col-md-auto ms-auto text-center align-items-center">
                                            <% if (userDetails.subscription.subscription === "Starter" ) { %>
                                                <% if (expiry >= now) { %>
                                                    <button class="btn btn-border border-primary" disabled>Renew Plan</button>
                                                  <% } else { %>
                                                    <button onclick="renewFreeBtn()" class="btn btn-border border-primary">Renew Plan</button>
                                                  <% } %>
                                            <% } else { %>
                                              <button id="renewBtn" class="btn btn-border border-primary">Renew Plan</button>
                                            <% } %>
                                          </div>
                                          
                                            <div class="mt-3 text-center">
                                                <small>
                                                    <% 
                                                        const expiryOptions = { month: 'short', day: 'numeric', year: 'numeric' };
                                                        const formattedExpiryDate = expiry.toLocaleDateString('en-US', expiryOptions);
                                                    %>
                                                    Next Billing on <%= formattedExpiryDate %> </small>
                                            </div>
                                        </div>
                                    </div>
                                    <% } else { %>
                                    <div class="card border-1 rounded-0 d-flex flex-row p-0">
                                        <div class="col-lg-8 p-2">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div>
                                                    <h5>No Subscription Found</h5>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4 bg-light p-2 ">
                                            <div class="col-md-auto ms-auto text-center">
                                                <a href="/subscription" class="btn btn-primary">Subscribe Now</a>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>                                            
                                </div>
                                

                            </div>
                            <!-- Main content END -->
                    </div>
                </div>
            </section>
            <!-- ======================= Content END -->

<!-- Hidden Renewal Payment Form -->
<form id="hdfcRenewalForm" method="POST" action="/payment/initiate-renewal" style="display: none;">
  <input type="hidden" name="email" />
  <input type="hidden" name="price" />
  <input type="hidden" name="subscription" />
  <input type="hidden" name="role" />
</form>

<script>
  async function renewFreeBtn() {
    const subscription = "Starter";
    try {
      const response = await fetch("/renewal-free", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ subscription })
      });

      if (!response.ok) {
        await Swal.fire({
          icon: 'error',
          title: 'Fetch Failed',
          text: 'Failed to fetch subscription details'
        });
        return;
      }

      const data = await response.json();
      if (data.message) {
        await Swal.fire({
          icon: 'info',
          title: 'Notice',
          text: data.message
        });
      }
      window.location.href = data.redirectUrl;
    } catch (error) {
      window.location.href = "/sign-in";
      console.error("Error:", error);
    }
  }

  // Renewal for paid subscriptions
  document.getElementById("renewBtn")?.addEventListener("click", function () {
    const email = "<%= userDetails.email %>";
    const subscription = "<%= userDetails.subscription.subscription %>";
    const role = "<%= userDetails.subscription.role %>";
    const amount = "<%= userDetails.subscription.price %>";

    const form = document.getElementById("hdfcRenewalForm");
    form.email.value = email;
    form.price.value = amount;
    form.subscription.value = subscription;
    form.role.value = role;
    form.submit();
  });
</script>

        </main>
        <!-- **************** MAIN CONTENT END **************** -->

        <%- include('./partials/footer') %>