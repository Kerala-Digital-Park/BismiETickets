<%- include('./partials/header') %>
<main>
  <%- include('./partials/sideBar') %>
  <div class="page-content">
    <%- include('./partials/topBar') %>

    <div class="page-content-wrapper p-xxl-4">
      <div class="row">
        <div class="col-12 mb-4 mb-sm-5">
          <div class="d-sm-flex justify-content-between align-items-center">
            <div class="card-body text-dark">
              <h1 class="h4 mb-3 mb-sm-0">Manage Subscriptions</h1>
            </div>
            <div class="d-grid">
              <a href="/admin/add-subscriptions?role=<%= role %>"
                 class="btn btn-primary-soft mb-0 me-2">
                <i class="bi bi-plus-lg fa-fw"></i>Add New Subscription
              </a>
            </div>
          </div>
        </div>
      </div>

      <h6 class="text-primary mt-3 text-center">
        <%= role === "User" ? "Customer Pricing" : "Seller Pricing" %>
      </h6>

      <%
// Map plan names to icon file names
const iconMap = {
  "Starter": "/assets/images/element/plan-s1.svg",
  "Base": "/assets/images/element/plan-s2.svg",
  "Pro": "/assets/images/element/plan-s2.svg",
  "Enterprise": "/assets/images/element/plan-s3.svg",
};
%>

      <div class="row g-4 justify-content-center mt-1">
        <% subscriptions.forEach(plan => { %>
          <div class="col-md-6 col-lg-4">
            <div class="card border">

              <!-- Card header -->
              <div class="card-header d-flex justify-content-between align-items-center border-bottom p-4">
                <div>
                  <h6 class="mb-0"><%= plan.subscription %> Plan</h6>
                  <div class="hstack gap-2">
                    <span class="h3 plan-price mb-0">₹<%= plan.price %></span>
                    <span class="h6 fw-light mb-0">/ per user</span>
                  </div>
                  <i class="bi bi-person-circle me-2"></i> <%= plan.noOfPurchases %> Accounts Purchased
                </div>
                <span class="icon-lg rounded-circle">
                  <img src="<%= iconMap[plan.subscription] || '/assets/images/element/plan-s1.svg' %>"
                       alt="<%= plan.subscription %> Plan"
                       class="img-fluid" style="max-width: 100px;">
                </span>
              </div>

              <% 
  let featureList = [];
  if (Array.isArray(plan.features)) {
    // If it's ["f1, f2, f3"] → split the first string
    if (plan.features.length === 1) {
      featureList = plan.features[0].split(",");
    } else {
      featureList = plan.features; // already split properly
    }
  }
%>

              <!-- Card body -->
              <div class="card-body p-4">
                <ul class="list-unstyled mb-0">
                      <% featureList.forEach(f => { 
         const featureText = (f || '').trim(); 
         const lowerText = featureText.toLowerCase(); 
    %>
      <li class="nav-item <%= (lowerText.startsWith('no ') || lowerText.startsWith('limited')) ? 'text-danger' : 'text-success' %>">
        <i class="bi bi-patch-check-fill me-2"></i>
        <%= featureText %>
      </li>
    <% }) %>
                </ul>
              </div>

              <!-- Card footer -->
              <div class="card-footer d-md-flex justify-content-md-between p-4 pt-0">
                <a href="/admin/edit-subscription/<%= plan._id %>"
                   class="btn btn-primary-soft mb-0 w-100 me-2">Edit</a>
                <% if (plan.status === "Archive") { %>
                  <button onclick="reactivatePlan('<%= plan._id %>', '<%=role%>')"
                     class="btn btn-info-soft mb-0 w-100 me-2">Reactivate</button>
                <% } else { %>
                    <button onclick= "archivePlan('<%= plan._id %>', '<%=role%>')"
                     class="btn btn-danger-soft mb-0 w-100 me-2">Archive</a>
                <% } %>
              </div>

            </div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>

  <script>
  async function reactivatePlan(planId, role) {
    const status = "Reactivate";
    try {
      const res = await fetch(`/admin/reactivate-subscription/${planId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role, status })
      });

              const data = await res.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: data.message,
                timer: 3000,
                showConfirmButton: false
            }).then(() => {
                window.location.href = data.redirectUrl;
            });
      } else {
        Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: data.message || 'Something went wrong!'
            });
      }
    } catch (err) {
      Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Request failed!'
        });
    }
  }

  async function archivePlan(planId, role) {
    const status = "Archive";
    try {
      const res = await fetch(`/admin/archive-subscription/${planId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role, status })
      });

        const data = await res.json();

        if (data.success) {
         Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: data.message,
                timer: 3000,
                showConfirmButton: false
            }).then(() => {
                window.location.href = data.redirectUrl;
            });
        location.reload();
      } else {
        Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: data.message || 'Something went wrong!'
            });
      }
    } catch (err) {
      Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Request failed!'
        });
    }
  }
</script>

</main>
<%- include('./partials/footer') %>
