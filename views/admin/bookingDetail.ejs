<%- include('./partials/header') %>

<!-- **************** MAIN CONTENT START **************** -->
<main>
	
	<!-- Sidebar START -->
	<%- include('./partials/sideBar') %>
	<!-- Sidebar END -->
	
	<!-- Page content START -->
	<div class="page-content">
        
		<!-- Top bar START -->
		<%- include('./partials/topBar') %>
		<!-- Top bar END -->
	
		<!-- Page main content START -->
		<div class="page-content-wrapper p-xxl-4">
	
			<!-- Title -->
			 	<div class="row">
                    <div class="col-12 mb-4 mb-sm-5">
                        <div class="d-sm-flex justify-content-between align-items-center">
                            <div class="card-body text-dark">
                                <!-- Title -->
                                <h1 class="m-0 h3 card-title"><%= booking.flight.from %> ➝ <%= booking.flight.to %> on   <%= new Date(booking.flight.departureDate).toLocaleDateString("en-GB", { 
        weekday: "short", 
        day: "2-digit", 
        month: "short", 
        year: "numeric" 
      }) 
  %></h1>
                                <!-- Breadcrumb -->
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb breadcrumb-dots mb-0">
                                        <li class="breadcrumb-item"><%=booking.userId.userId%></li>
                                        <li class="breadcrumb-item">Booked At:   <%= new Date(booking.createdAt).toLocaleString("en-GB", {
        day: "2-digit",
        month: "short",
        weekday: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      })
      // rearrange format
      .replace(/(\d{2}) (\w{3}) (\d{4}), (\w{3})/, "$1 $2, $4 $3") 
  %></li>
<% if (new Date(booking.flight.departureDate) > new Date()) { %>
  <li class="breadcrumb-item active text-success">Confirmed</li>
<% } else { %>
  <li class="breadcrumb-item active text-info">Completed</li>
<% } %>
                                    </ol>
                                </nav>
                            </div>
                            <a href="https://www.google.com/search?q=<%= booking.flight.stops[0].airlineCode %>-<%= booking.flight.stops[0].flightNumber %> airline" class="btn btn-info-soft text-nowrap mb-0 me-2"
                                title="airline website link" target="_blank"><i class="bi bi-airplane-fill"></i></a>
                            <a href="/admin/notifications/<%=booking.flight._id%>" class="btn btn-dark-soft text-nowrap mb-0 me-2" title="Remainder"><i
                                    class="bi bi-bell"></i></a>
                            <a href="#" 
   class="btn btn-info-soft text-nowrap mb-0 me-2 clipboard-init"
   title="Copy Pnr to clipboard"
   data-clipboard-text="<%= booking.flight.inventoryDates[0].pnr %>">
   <i class="bi bi-copy"></i>
</a>


                            <a href="/admin/booking/download-eticket/<%=booking._id%>" class="btn btn-success-soft text-nowrap mb-0 me-2"
                                title="Ticket copy Download"><i class="bi bi-download"></i> Download </a>

                            <a href="#" class="btn btn-primary-soft text-nowrap mb-0 me-2" role="button"
                                id="dropdownAction2" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-plus-square"></i>
                            </a>
                            <!-- dropdown button -->
                            <ul class="dropdown-menu dropdown-menu-end min-w-auto shadow rounded"
                                aria-labelledby="dropdownAction2">
                                <li><a class="dropdown-item" title="Cancellation Request" data-bs-toggle="modal"
                                        data-bs-target="#cancellation"> <i class="bi bi-x-circle-fill"></i>
                                        Cancellation
                                        Request </a></li>
                                <li><a class="dropdown-item" title="Email Request" data-bs-toggle="modal"
                                        data-bs-target="#email"> <i class="bi bi-envelope-check-fill"></i> Share Copy
                                        to Email </a></li>
                                <li><a class="dropdown-item" title="Invoice Request" data-bs-toggle="modal"
                                        data-bs-target="#invoice"> <i class="bi bi-receipt-cutoff"></i> Share
                                        Invoice to Email </a></li>

                            </ul>
                        </div>
                    </div>
                </div>


<% if (success) { %>
  <div class="d-flex justify-content-center mt-1">
    <div class="alert alert-success text-center alert-dismissible fade show" style="width: 100%;" role="alert">
      <%= success %>
      <!-- Close button -->
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  </div>
<% } %>

<% if (error) { %>
  <div class="d-flex justify-content-center mt-1">
    <div class="alert alert-danger text-center alert-dismissible fade show" style="width: 100%;" role="alert">
      <%= error %>
      <!-- Close button -->
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  </div>
<% } %>

<% if (payment) { %>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const payment = "<%= payment %>"; // inject EJS into JS

      if (payment === "success") {
        Swal.fire({
          icon: "success",
          title: "Payment Successful",
          text: "Your payment has been completed successfully!",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
      } else if (payment === "error") {
        Swal.fire({
          icon: "error",
          title: "Payment Failed",
          text: "Unfortunately, your payment could not be processed. Please try again.",
          confirmButtonColor: "#d33",
          confirmButtonText: "Retry"
        });
      }
    });
  </script>
<% } %>

			<!-- Booking detail START -->
			 <div class="row g-3 g-xl-4">
                    <!-- Image -->
                    <!-- Content -->
                    <div class="col-xxl-9">
                        <!-- Flight information START -->
                        <div class="card border">
                            <!-- Card body START -->
                            <div class="card-body p-2">
                                <!-- Card list START -->
                                <!-- Card header -->
                                <div class="card-header">
                                    <div class="d-sm-flex justify-content-sm-between align-items-center">
                                        <!-- Airline Name -->
                                        <div class="d-flex mb-2 mb-sm-0">
                                            <img src="<%= booking.flight.stops[0].airlineLogo %>" class="w-40px me-2"
                                                alt="">
                                            <h6 class="fw-normal mb-0"><%= booking.flight.stops[0].airline %> (<%= booking.flight.stops[0].airlineCode %> - <%= booking.flight.stops[0].flightNumber %>)
                                            </h6>
                                        </div>
                                        <h6 class="fw-normal mb-0"><span class="text-body">Booking
                                                PNR:</span><span  id="pnr-copy"><%= booking.flight.inventoryDates[0].pnr.toUpperCase() %></span></h6>
                                    </div>
                                </div>

                                <!-- Card body START -->
                                <div class="card-body p-4">
                                    <!-- Ticket item START -->
                                    <div class="row g-4">
                                        <!-- Airport detail -->
                                        <div class="col-sm-4">
                                            <!-- Title -->
                                            <h4><%= booking.flight.from %></h4>
                                            <h6 class="mb-0"><%= booking.flight.departureTime %></h6>
                                            <p class="mb-0"><%= booking.flight.departureName %>, <%= booking.flight.fromCountry %></p>
                                        </div>

                                        <!-- Time -->
                                        <div class="col-sm-4 my-sm-auto text-center">
                                            <!-- Time -->
                                            <h5><%= booking.flight.duration %></h5>

                                            <div class="position-relative my-4">
                                                <!-- Line -->
                                                <hr class="bg-primary opacity-5 position-relative">
                                                <!-- Icon -->
                                                <div
                                                    class="icon-md bg-primary text-white rounded-circle position-absolute top-50 start-50 translate-middle">
                                                    <i class="fa-solid fa-fw fa-plane rtl-flip"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Airport detail -->
                                        <div class="col-sm-4">
                                            <!-- Title -->
                                            <h4><%= booking.flight.to %></h4>
                                            <h6 class="mb-0"><%= booking.flight.arrivalTime %></h6>
                                            <p class="mb-0"><%= booking.flight.arrivalName %>, <%= booking.flight.toCountry %></p>
                                        </div>
                                    </div>
                                    <!-- Ticket item END -->

                                </div>
                                <!-- Card body END -->
                                <!-- Card footer -->
                                <div class="card-footer pt-4">
                                    <ul
                                        class="list-inline bg-light rounded-2 d-sm-flex text-center justify-content-sm-between mb-0 px-4 py-2">

                                        <li class="list-inline-item text-dark">Checked baggage : <%= booking.flight.baggage.adult.checkIn.weightPerPiece %> kg
                                        </li>
                                        <li class="list-inline-item text-dark">Carry-on baggage : <%= booking.flight.baggage.adult.cabin.weightPerPiece %> Kg
                                        </li>

                                    </ul>
                                </div>

                                <!-- Card body -->
                            </div>
                            <!-- Card body END -->
                        </div>

                        <!-- Flight information END -->
                    </div>
                    <div class="col-xxl-3">
                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-2 me-3">
                            <label class="form-check-label ps-0 pe-4" for="checkPrivacy1">Booking Number</label>
                            <%=booking.bookingId%>
                        </div>

                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="checkPrivacy1">Booking User</label>
                            <%=booking.userId.name%>
                        </div>
                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="checkPrivacy1">Booking User ID</label>
                            <%=booking.userId.userId%>
                        </div>
                         <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="checkPrivacy1">Total Seats</label>
                            <%= booking.flight.inventoryDates[0].seats %>
                        </div>

                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-2 me-3">
                            <label class="form-check-label ps-0 pe-4" for="checkPrivacy1">Inventory Number</label>
                            <%= booking.flight.inventoryId %>
                        </div>

                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="checkPrivacy1">Inventory User</label>
                            <%= seller.name %>
                        </div>


                    </div>
                    <!-- Booking detail END -->


                    <ul class="nav nav-tabs nav-justified mb-3">
                        <li class="nav-item "> <a class="nav-link text-primary mb-0 active" data-bs-toggle="tab"
                                href="#tab-1"><i class="bi bi-bookmark-heart fa-fw me-1"></i> Booking
                                Details</a> </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab"
                                href="#tab-2"><i class="bi bi-receipt"></i>
                                Transactions</a> </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab"
                                href="#tab-5"><i class="bi bi-paypal"></i>
                                Payments</a> </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab"
                                href="#tab-4"><i class="bi bi-card-checklist"></i> Booking Activities</a>
                        </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab"
                                href="#tab-3"><i class="bi bi-patch-question"></i> Help Desk</a> </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-primary" href="#" id="dropdoanMenu"
                                title="Please inactive Inventory For Edit options" data-bs-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">
                                <i class="bi bi-list-ul fa-fw me-1"></i>Booking Actions
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="dropdoanMenu">
                                <!-- Dropdown menu -->
                                <li> <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#otp"><i
                                            class="bi bi-passport"></i> OTB Request</a>
                                </li>
                                <li> <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#namecorrect">
                                        <i class="bi bi-person-badge"></i> Name correction</a></li>
                                <li> <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#Wheelchair"><i
                                            class="bi bi-person-wheelchair"></i>
                                        Wheelchair</a></li>
                                <li> <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#seats"><i
                                            class="fas fa-chair"></i>
                                        Request Seats</a>
                                </li>
                                <li> <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#meals"><i
                                            class="fas fa-utensils"></i>
                                        Request Meals </a>
                                </li>
                                <li> <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addbag"><i
                                            class="bi bi-suitcase"></i>
                                        Additional Bag </a>
                                </li>
                            </ul>
                        </li>

                    </ul>

                    <div class="tab-content">
                        <!-- Tab content 1 START -->
                        <div class="tab-pane show active" id="tab-1">
                            <div class="row g-3 ">
                                <div class="col-12"> <!-- Booking table START -->
                                    <div class="card border">
                                        <!-- Card header START -->
                                        <div class="card-header border-bottom d-md-flex justify-content-md-between">
                                            <h5 class="card-header-title"><i class="bi bi-passport"></i> Passengers
                                            </h5>
                                            <button   class="btn btn-outline-info waves-effect waves-light "
                                                                    title="Edit Passport Details"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#paxupdate"><i
                                                                        class="bi bi-pencil-square"></i> Edit Passengers</button>   
                                        </div>
                                        <!-- Card header END -->
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <!-- Table head -->
                                            <div class="table-responsive">
                                                <table class="datatable-init-export table"
                                                    data-export-title="Export">

                                                    <thead>

                                                        <tr>

                                                            <th>No.</th>

                                                            <th>Title</th>

                                                            <th>Type</th>

                                                            <th>Given Name</th>

                                                            <th>Surname</th>

                                                            <th>Birth</th>

                                                            <th>Passport No</th>

                                                            <th>Expiry</th>

                                                            <th >Status</th>

                                                        </tr>

                                                    </thead>

                                                    <tbody>
														<% booking.travelers.forEach((traveler, i) => { %>
                                                        <tr>

                                                            <td><%= i+1 %></td>

                                                            <td scope="row">

                                                                <%= traveler.title.toUpperCase() %>

                                                            </td>

                                                            <td> <%= traveler.type.toUpperCase() %></td>

                                                            <td class="text-uppercase">

                                                                <%= traveler.first_name.toUpperCase() %>

                                                            </td>

                                                            <td class="text-uppercase">

                                                                <%= traveler.last_name.toUpperCase() %>

                                                            </td>

                                                            <td> <%= new Date(traveler.dob).toLocaleDateString('en-GB') %> </td>

                                                            <td><%= traveler.passport_number %></td>

                                                            <td><%= new Date(traveler.passport_expiry).toLocaleDateString('en-GB') %></td>

                                                            
                                                            <td>TKT USED / Active</td>


                                                        </tr>
														<% }) %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- Card body END -->


                                    </div>
                                </div>
                                <div class="col-12"> <!-- Booking table START -->
                                    <div class="card border">
                                        <!-- Card header START -->
                                        <div class="card-header border-bottom d-md-flex justify-content-md-between">
                                            <h5 class="card-header-title"><i class="bi bi-passport"></i> Reservations
                                            </h5>
                                             <button   class="btn btn-outline-info waves-effect waves-light "
                                                                    title="Edit Passport Details"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#reservations"><i
                                                                        class="bi bi-pencil-square"></i> Edit Reservations</button>   
                                        </div>
                                        <!-- Card header END -->
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <!-- Table head -->
                                            <div class="table-responsive">
                                                <table class="datatable-init-export nowrap table"
                                                    data-export-title="Export">

                                                    <thead>

                                                        <tr>

                                                            <th>No</th>

                                                            <th>PNR</th>

                                                            <th>E-Ticket Number</th>

                                                            <th>Seat</th>

                                                            <th>Checkin</th>

                                                            <th>Cab</th>

                                                            <th>Status</th>
 

                                                        </tr>
                                                    </thead>

                                                    <tbody>

														<% booking.travelers.forEach((traveler, i) => { %>
                                                        <tr>

                                                            <td><%=i+1%></td>
                                                            <td>
                                                                <%=booking.flight.inventoryDates[0].pnr%>
                                                            </td>
                                                            <td>Not Issued </td>
                                                            <td>- </td>
															<% let cab;
															let checkin;
															if(booking.flight.baggage.adult.cabin.weightPerPiece!==0){
																cab=booking.flight.baggage.adult.cabin.weightPerPiece + "KG";	
															}else{
																cab="Not available";
															}
															if(booking.flight.baggage.adult.checkIn.weightPerPiece!==0){
																checkin=booking.flight.baggage.adult.checkIn.weightPerPiece + "KG";	
															}else{
																checkin="Not available";
															}
															%>
                                                            <td><%=checkin%></td>
                                                            <td><%=cab%></td>
                                                            <td>active </td>

                                                        <% }) %>

                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- Card body END -->


                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header START -->
                                        <div class="card-header border-bottom d-md-flex justify-content-md-between">
                                            <h5 class="card-header-title"><i class="bi bi-passport"></i> Add Services
                                            </h5>
                                            <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                                data-bs-target="#newaddon" title="New addon">
                                                <i class="bi bi-plus-circle"></i> New
                                                Services</button>
                                        </div>
                                        <!-- Card header END -->
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <table class="table table-ulogs">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>No</th>
                                                        <th>Service</th>
                                                        <th>Details</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
													<% if(requests.length > 0) { %>
													<% requests.forEach((request, i) => { %>
                                                    <tr>
                                                        <td><%=i+1%></td>
                                                        <td><%=request.subject%></td>
                                                        <td>
                                                            <Strong> <%=request.passengerName%></Strong> 
															<% booking.flight.stops.forEach((stop) => { %>
																<span class="badge bg-info"><%=stop.airlineCode%>-<%=stop.flightNumber%></span>
															<% })%>
                                                            <br>
                                                            <%=request.request%>
                                                        </td>
                                                        <td>active </td>
                                                        <td>
                                                            <button type="button"
                                                                class="btn btn-outline-info waves-effect waves-light "
                                                                data-bs-toggle="modal" data-bs-target="#newaddon"><i
                                                                    class="bi bi-pencil-square"></i></button>

                                                            <button 
  class="btn btn-outline-danger waves-effect waves-light delete-request"
  data-id="<%= request._id %>">
  <i class="bi bi-trash-fill"></i>
</button>

                                                        </td>
                                                    </tr>
                                                    
													<% }) %>
													<% } else { %>
                                                        <tr>
                                                            <td colspan="10" class="text-center">No requests found.</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div> <!-- Booking table END -->

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".delete-request").forEach(button => {
      button.addEventListener("click", async (e) => {
        e.preventDefault();

        const id = button.getAttribute("data-id");
        const row = button.closest("tr"); // get the table row

        Swal.fire({
          title: "Are you sure?",
          text: "This action cannot be undone!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, delete it!",
          cancelButtonText: "Cancel"
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const res = await fetch(`/admin/service-request/delete/${id}`, {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json"
                }
              });

              if (res.ok) {
                // remove row visually
                row.remove();

                Swal.fire({
                  title: "Deleted!",
                  text: "Service request has been deleted.",
                  icon: "success",
                  timer: 2000,
                  showConfirmButton: false
                });
              } else {
                Swal.fire("Error", "Failed to delete. Try again.", "error");
              }
            } catch (error) {
              Swal.fire("Error", "Something went wrong.", "error");
              console.error(error);
            }
          }
        });
      });
    });
  });
</script>
                        </div>
                        <!-- Tab content 2 START -->
                        <div class="tab-pane show" id="tab-2">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header -->
                                        <div class="card-header border-bottom d-md-flex justify-content-md-between">
                                            <h5 class="card-header-title">Booking Transactions</h5>
                                            <button type="button" class="btn btn-outline-danger btn-md"
                                                data-bs-toggle="modal" data-bs-target="#intrefundtrs" title="Refund">
                                                <i class="bi bi-dash-circle"></i> New
                                                Refund</button>
                                            
                                        </div>
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <table class="table">

                                                <thead>

                                                    <tr>
                                                        <th>Transaction Id</th>
                                                        <th>Booking date</th>
                                                        <th>Particulars</th>
                                                        <th>Booking Amount</th>
                                                        <th>C.Fee</th>
                                                        <th>Paid Amount</th>
                                                        <th>Pay Status</th>
                                                        <th>Actions</th>
                                                    </tr>

                                                </thead>

                                                <tbody>
													<% if(transactions.length > 0) { %>
													<%transactions.forEach((transaction) => { %>
                                                    <tr>
                                                        <td scope="1"> <%=transaction.transactionId%> </td>
                                                        <td> <%= new Date(booking.createdAt).toLocaleDateString("en-GB", {
        													day: "2-digit",
        													month: "short",
    														year: "numeric"
          													}).replace(/ /g, "-") %> 
														</td>
	  													<% let stop;
														if(booking.flight.stops.length>1){
															stop=booking.flight.stops.length-1 + " Stops";
														} else {%>
															stop="Non Stop"
														<%}%>
                                                        <td>
                                                            (<%=booking.flight.inventoryDates[0].pnr.toUpperCase()%>): <%=booking.flight.departureDate%> <%=booking.flight.from%> <%=booking.flight.to%> <br> <%=booking.flight.stops[0].airlineCode%>- <%=booking.flight.stops[0].flightNumber%> <%=stop%>
                                                        </td>
                                                        <td>₹ <%=transaction.totalAmount%></td>
                                                        <td>₹ <%=transaction.discount%></td>
                                                        <td>₹ <%=transaction.totalAmount%></td>
                                                        <td><%=transaction.paymentStatus%></td>
                                                        <td><a href="/admin/booking-detail/<%= transaction.bookingId._id %>"
                                                                class="btn btn-outline-warning waves-effect waves-light "
                                                                title="Booking Details"><i
                                                                    class="bi bi-eye-fill"></i></a>
                                                            <a href="/admin/withdrawal/<%= booking.flight._id %>/<%= booking.flight.sellerId %>"
                                                                class="btn btn-outline-info waves-effect waves-light "
                                                                title="Supplier Transfer"><i
                                                                    class="bi bi-paypal"></i></a>
                                                        </td>
                                                    </tr>
													<%})%>
													<% } else { %>
                                                        <tr>
                                                            <td colspan="10" class="text-center">No transactions found.</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tab content 2 START -->
                        <div class="tab-pane show  " id="tab-5">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header --> <div class="card-header border-bottom d-md-flex justify-content-md-between">
                                              <h5 class="card-header-title">Booking Payments</h5>
                                         
                                            <button type="button" class="btn btn-outline-success btn-md"
                                                data-bs-toggle="modal" data-bs-target="#datechange" title="Refund">
                                                <i class="bi bi-plus-circle"></i> Add
                                                Charge</button>
                                        </div>
                                        
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <table class="table">

                                                <thead>

                                                    <tr>

                                                        <th> Transaction Id</th>
                                                        <th> Type</th>
                                                        <th> Booking ID</th>
                                                        <th>Booking date</th>
                                                        <th> Amount</th>
                                                        <th>Gateway</th>
                                                        <th>Method</th>
                                                        <th>Charges</th>
                                                        <th>Pay Status</th>
                                                        <th>Actions</th>

                                                    </tr>

                                                </thead>

                                                <tbody>
                                                    <% if(transactions.length > 0) { %>
													<%transactions.forEach((transaction) => { %>
													<tr>

                                                        <td scope="1"> <%=transaction.transactionId%> </td>
                                                        <td><%=transaction.bookingId.bookingId%> </td>
                                                        <td><%=transaction.type%> </td>
                                                        <td><%= new Date(booking.createdAt).toLocaleDateString("en-GB", {
        													day: "2-digit",
        													month: "short",
    														year: "numeric"
          													}).replace(/ /g, "-") %> </td>
                                                        <td>₹ <%=transaction.totalAmount%></td>
                                                        <td>HDFC BANK</td>
                                                        <td>UPI</td>
														<%
                                                            const totalAmount = transaction.totalAmount;
                                                            const taxAmount = transaction.tax;
                                                            const discountAmount = transaction.discount;
                                                            const taxPercentage = Math.floor(((taxAmount / totalAmount) * 100).toFixed(2));

                                                        %>
                                                        <td><%= taxPercentage %>% (₹<%= taxAmount %>)</td>
                                                        <td><%= transaction.paymentStatus %></td>
                                                        <td>
															<a href="/admin/booking-detail/<%= transaction.bookingId._id %>" class="btn btn-sm btn-outline-warning mb-0 me-2"
                                                                title="Booking Details"><i
                                                                    class="bi bi-eye-fill"></i></a>
                                                        </td>

                                                    </tr>
													<%})%>
													<% } else { %>
                                                        <tr>
                                                            <td colspan="10" class="text-center">No payments found.</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tab content 3 START -->
                        <div class="tab-pane show  " id="tab-3">
                            <div class="row">
                                <div class="col-12 mx-auto">
                                    <div class="accordion accordion-icon accordion-bg-light" id="accordionExample2">
                                        <!-- Item -->
                                        <% if (requests && requests.length > 0) { %>
          <% requests.forEach((req, index) => { %>
            <div class="accordion-item mb-3">
              <h6 class="accordion-header font-base" id="heading-<%= index %>">
                <button class="accordion-button fw-bold rounded d-inline-block collapsed"
                  type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= index %>"
                  aria-expanded="false" aria-controls="collapse-<%= index %>">
                  Support Request Number : <%= req.requestId %>
                </button>
              </h6>
              <div id="collapse-<%= index %>" class="accordion-collapse collapse"
                aria-labelledby="heading-<%= index %>" data-bs-parent="#accordionExample2">
                <div class="accordion-body mt-3">
                  <div class="card shadow">
                    <div class="card-header border-bottom p-4">
                      <h6 class="mb-0"><%= req.subject %></h6>
                      <ul class="nav nav-divider">
                        <li class="nav-item">Last updated: <%= req.updatedAt.toLocaleDateString("en-GB") %></li>
                      </ul>
                    </div>
                    <div class="card-body p-4">
                      <div class="alert alert-warning text-right" role="alert">
                        <%= req.passengerName %> - <%= req.request %>
                      </div>
                    
                      <div class="replies mb-3 ">
                        <% if (req.reply && req.reply.length > 0) { %>
                          <% req.reply.forEach(r => { %>
                            <div class="border rounded mb-3">
                              <p><strong><%= r.sender %>:</strong> <%= r.message %></p>
                              <% if (r.amount) { %>
                                <div class="d-flex align-items-center gap-2">
                                  <span class="badge bg-info">Amount: ₹<%= r.amount %></span>
                                  <span class="badge <%= r.paymentStatus === 'Paid' ? 'bg-success' : 'bg-warning' %>">
                                    <%= r.paymentStatus || "Unpaid" %>
                                  </span>
                                </div>
                              <% } %>
                              <small class="text-muted"><%= r.date.toLocaleString("en-GB") %></small>
                            </div>
                          <% }) %>
                        <% } %>
                      </div>

                      <form class="send-reply-form" data-id="<%= req._id %>">
                        <div class="mb-2">
                          <textarea name="message" class="form-control" placeholder="Enter message" required></textarea>
                        </div>
                        <div class="mb-2">
                          <input type="number" name="amount" class="form-control" placeholder="Enter amount (optional)">
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">Send</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="border p-3 rounded d-lg-flex align-items-center justify-content-between text-center">
            <small class="py-3 py-lg-0 d-block">No Request Found</small>
          </div>
        <% } %>
                                        <!-- Item -->
                                    </div>
                                </div>
                                <!-- Accordion END -->

                            </div>
                        </div>

<script>
document.querySelectorAll(".send-reply-form").forEach(form => {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const requestId = form.dataset.id;
    const message = form.querySelector("[name='message']").value.trim();
    const amount = form.querySelector("[name='amount']").value;

    try {
      const res = await fetch(`/admin/send-reply/${requestId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, amount })
      });
      const data = await res.json();

      if (data.success) {
        Swal.fire("Success", data.message, "success");

        // append new reply above form
        const repliesDiv = form.closest(".accordion-body").querySelector(".replies");
        const newReply = document.createElement("div");
        newReply.className = "border rounded p-2 mb-2";
        newReply.innerHTML = `
          <p><strong>admin:</strong> ${data.reply.message}</p>
          ${data.reply.amount ? `
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-info">Amount: ₹${data.reply.amount}</span>
              <span class="badge ${data.reply.paymentStatus === "Paid" ? "bg-success" : "bg-warning"}">
                ${data.reply.paymentStatus}
              </span>
            </div>` : ""}
          <small class="text-muted">${new Date(data.reply.date).toLocaleString("en-GB")}</small>
        `;
        repliesDiv.appendChild(newReply);

        // reset form
        form.reset();
      } else {
        Swal.fire("Error", data.message, "error");
      }
    } catch (err) {
      Swal.fire("Error", "Something went wrong!", "error");
    }
  });
});
</script>
                        <!-- Tab content 4 START -->
                        <div class="tab-pane show  " id="tab-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header -->
                                        <div class="card-header border-bottom">
                                            <h5 class="card-header-title">All Activities</h5>
                                        </div>
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <table class="table table-ulogs">

                                                <thead class="thead-light">

                                                    <tr>

                                                        <th>Date</th>

                                                        <th>ID</th>

                                                        <th>Content</th>

                                                        <th>User</th>

                                                    </tr>

                                                </thead>

                                                <tbody>

                                                    <%
                                                    if(userActivities.length === 0) { %>
                                                        <tr>
                                                            <td colspan="4" class="text-center">No activities found.</td>
                                                        </tr>
                                                    <% } else { %>
                                                        <% userActivities.forEach((activity) => { %>
                                                            <tr>
                                                        <td><%= moment(activity.createdAt).format("DD-MMM-YYYY HH:mm") %></td>

                                                        <td><%= booking.bookingId %></td>

                                                        <td><%= activity.content %></td>


                                                        <td><%= seller.name.toUpperCase() %></td>

                                                    </tr>
                                                        <% }) %>
                                                    <% } %>
                                                    %>
                                                    
                                                </tbody>
                                            </table>
                                        </div>
                                        <!-- Card body END -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

			<!-- Booking detail END -->

		</div>
		<!-- Page main content END -->
	</div>
	<!-- Page content END -->
	
    <!-- select email modal -->
    <div class="modal fade" tabindex="-1" role="dialog" id="invoice" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="title m-4">Share Invoice Copy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>


                <form id="invoiceForm" class="form-validate is-alter">
                    <div class="modal-body bg-white">
                        <div class="form-group">
                            <label class="form-label" for="email-address">Email address</label>
                            <div class="form-control-wrap">
                                <input type="text" class="form-control" name="email" id="emailId" required>
                            </div>
                        </div>
                    </div>  
                    <div class="modal-footer bg-light">
                        <a href="#" class="btn btn-danger waves-effect waves-light" data-bs-dismiss="modal"
                        data-dismiss="modal" aria-label="Close">Close</a>
                        <button type="submit" class="btn btn-primary waves-effect waves-light">Confirm</button>
                    </div>
                </form>

            </div><!-- modal-content -->
        </div><!-- .modal-dialog -->
    </div><!-- .modal -->

<script>
document.addEventListener("DOMContentLoaded", () => {
  const invoiceForm = document.getElementById("invoiceForm");

  if (invoiceForm) {
    invoiceForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const email = document.getElementById("emailId").value;
      const bookingId = "<%= booking._id %>"; // dynamically inserted

      try {
        const res = await fetch(`/admin/booking/email-invoice/${bookingId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email })
        });

        if (res.ok) {
          Swal.fire({
            icon: "success",
            title: "Email sent!",
            text: "The invoice was shared successfully.",
            timer: 2000,
            showConfirmButton: false
          });

          // close modal
          const modalEl = document.getElementById("invoice");
          const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
          modal.hide();
        } else {
          Swal.fire({
            icon: "error",
            title: "Failed",
            text: "Something went wrong while sending the invoice."
          });
        }
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Network or server error."
        });
      }
    });
  }
});
</script>

    <!-- select email modal -->
    <div class="modal fade" tabindex="-1" role="dialog" id="email" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered " role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="title m-4">Share Ticket Copy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>


                <form  id="emailForm" class="form-validate is-alter">
                    <div class="modal-body bg-white">
                        <div class="form-group">
                            <label class="form-label" for="email-address">Email address</label>
                            <div class="form-control-wrap">
                                <input type="text" class="form-control" id="emailInput" name="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <a href="#" class="btn btn-danger waves-effect waves-light" data-bs-dismiss="modal"
                        data-dismiss="modal" aria-label="Close">Close</a>
                        <button type="submit" class="btn btn-primary waves-effect waves-light">Confirm</button>
                    </div>
                </form>

            </div><!-- .modal-content -->
        </div><!-- .modla-dialog -->
    </div><!-- .modal -->

    <script>
  document.getElementById("emailForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const email = document.getElementById("emailInput").value;
    const bookingId = "<%= booking._id %>";  // dynamically inserted
    try {
      const res = await fetch(`/admin/booking/email-eticket/${bookingId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ email })
      });

      if (res.ok) {
        // success alert
        Swal.fire({
          icon: "success",
          title: "Email sent!",
          text: "The e-ticket was shared successfully.",
          timer: 2000,
          showConfirmButton: false
        });
        // close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("email"));
        modal.hide();
      } else {
        Swal.fire({
          icon: "error",
          title: "Failed",
          text: "Something went wrong while sending the e-ticket."
        });
      }
    } catch (err) {
      console.error(err);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Network or server error."
      });
    }
  });
</script>

    <!-- select cancellation modal -->
    <div class="modal fade" tabindex="-1" role="dialog" id="cancellation" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="title m-4">Request For Cancellation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="cancelForm">
                <div class="modal-body bg-white">
                    <div class="row">

                        <div class="col-md-9 mb-3">
                            <label class="form-label">Reason of Cancellation</label>
                            <input autocomplete="off" list="issuedfrom" type="text" class="form-control"
                                name="reason" placeholder="Cancellation Remarks" required>
                            <datalist id="issuedfrom">
                                <option value="Passengers wish to cancel this ticket with applicable charges">
                                <option value="Passengers not traveled and looking Noshow Tax Refund">
                                <option value="Passenger Offloaded and wish to cancel with applicable charges.">
                                <option
                                    value="The flight was rescheduled, the passenger refused to travel and requested a full refund">
                                <option value="flight was non-operational and you didn't take an alternate flight ">
                                <option value="Passenger cancelled their flight directly with airline.">
                                <option value="Partial journey Cancellation.">
                                <option value="Cancellation by Provider Mistake.">
                            </datalist>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Estimated Charge</label>
                            <input autocomplete="off" type="number" name="charges" required class="form-control"
                                placeholder="Estimated Charge">

                        </div>

                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <a href="#" class="btn btn-danger waves-effect waves-light" data-bs-dismiss="modal"
                        data-dismiss="modal" aria-label="Close">Close</a>
                    <button type="submit" class="btn btn-primary waves-effect waves-light">Confirm</button>
                </div>
                </form>

            </div><!-- .modal-content -->
        </div><!-- .modla-dialog -->
    </div><!-- modal -->

    <script>
document.getElementById("cancelForm").addEventListener("submit", async (e) => {
  e.preventDefault(); // prevent default form submit

  const formData = new FormData(e.target);
  const bookingId = "<%= booking._id %>"; 

  try {
    const response = await fetch(`/admin/request-cancellation/${bookingId}`, {
      method: "POST",
      body: new URLSearchParams(formData), // converts formData to URL-encoded
      headers: { "Content-Type": "application/x-www-form-urlencoded" }
    });

    const result = await response.json();

    if (result.success) {
      Swal.fire({
        icon: "success",
        title: "Request Submitted",
        text: result.message,
      }).then(() => {
        location.reload(); // or redirect somewhere
      });
    } else {
      Swal.fire("Error", result.message, "error");
    }
  } catch (err) {
    Swal.fire("Error", "Something went wrong.", "error");
  }
});
</script>
  
    <!-- select Passenger Update modal -->
 
    <!-- Passenger Edit Modal -->
<!-- Passenger Edit Modal -->
<div class="modal fade" tabindex="-1" id="paxupdate" data-bs-backdrop="static" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title">Edit Passenger Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body bg-white">
        <p class="text-muted mb-3">
          Please select a passenger from the dropdown below to edit their details.
        </p>

        <!-- Passenger Selector -->
        <div class="mb-4">
          <label class="form-label fw-bold">Select Passenger</label>
          <select id="passengerSelect" class="form-select">
            <!-- Populated dynamically -->
          </select>
        </div>

        <!-- Passenger Form -->
        <form id="passengerForm" method="POST" action="/admin/edit-passengers/<%= booking._id %>">
          <!-- Hidden fields to identify passenger -->
          <input type="hidden" name="first_name" id="hiddenFirstName">
          <input type="hidden" name="last_name" id="hiddenLastName">

          <div class="row">
            <div class="col-md-2 mb-3">
              <label class="form-label">Title</label>
              <input type="text" name="title" id="paxTitle" class="form-control"
                placeholder="Title" onkeyup="this.value=this.value.toUpperCase()">
            </div>

            <div class="col-md-2 mb-3">
              <label class="form-label">Type</label>
              <select name="type" id="paxType" class="form-control" required>
                <option value="Adult">Adult</option>
                <option value="Child">Child</option>
                <option value="Infant">Infant</option>
              </select>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Given Name</label>
              <input type="text" name="given_name" id="paxGiven" class="form-control" placeholder="Given Name">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Surname</label>
              <input type="text" name="surname" id="paxSurname" class="form-control" placeholder="Surname">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Date of Birth</label>
              <input type="date" name="dob" id="paxBirth" class="form-control">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Passport Number</label>
              <input type="text" name="passport_number" id="paxPassport" class="form-control"
                onkeyup="this.value=this.value.toUpperCase()" placeholder="Passport Number">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Passport Expiry</label>
              <input type="date" name="passport_expiry" id="paxExpiry" class="form-control">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Booking ID</label>
              <input type="text" class="form-control" value="<%= booking.bookingId %>" readonly>
            </div>

            <div class="col-md-8 mb-3">
              <label class="form-label">Remarks or Reason for Update</label>
              <input type="text" name="remarks" id="paxRemarks" class="form-control"
                placeholder="Remarks about update">
            </div>
          </div>
        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        <button type="submit" form="passengerForm" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Passengers injected dynamically -->
<script id="passenger-data">
  const travelers = <%- JSON.stringify(booking.travelers) %>;
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const passengerSelect = document.getElementById("passengerSelect");

    // Populate dropdown
    travelers.forEach((t, i) => {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = `${t.first_name} ${t.last_name}`;
      passengerSelect.appendChild(option);
    });

    function loadPassenger(index) {
      const pax = travelers[index];
      if (!pax) return;

      // Hidden identifiers
      document.getElementById("hiddenFirstName").value = pax.first_name;
      document.getElementById("hiddenLastName").value = pax.last_name;

      // Form fields
      document.getElementById("paxTitle").value = pax.title || "";
      document.getElementById("paxType").value = pax.type || "Adult";
      document.getElementById("paxGiven").value = pax.first_name || "";
      document.getElementById("paxSurname").value = pax.last_name || "";
      document.getElementById("paxBirth").value = pax.dob ? pax.dob.split("T")[0] : "";
      document.getElementById("paxPassport").value = pax.passport_number || "";
      document.getElementById("paxExpiry").value = pax.passport_expiry ? pax.passport_expiry.split("T")[0] : "";
      document.getElementById("paxRemarks").value = pax.remarks || "";
    }

    passengerSelect.addEventListener("change", e => loadPassenger(e.target.value));

    if (travelers.length > 0) {
      passengerSelect.value = 0;
      loadPassenger(0);
    }
  });
</script>

        <!-- select Update Reservation  modal -->
    <!-- <div class="modal fade" tabindex="-1" role="dialog" data-bs-backdrop="static" id="reservations">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="title m-4">JAMSHEED Reservations Informations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-white">
                    <div class="row">

                        <div class="col-md-4 mb-3">
                            <label class="form-label">PNR</label>
                            <input autocomplete="off" type="text" class="form-control"
                                onkeyup="this.value = this.value.toUpperCase();" value="QYHWVM" name="pnr"
                                placeholder="PNR">

                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">E-Ticket Number</label>
                            <input autocomplete="off" type="text" class="form-control"
                                onkeyup="this.value = this.value.toUpperCase();" name="eticket" value="QYHWVM"
                                placeholder="E-Ticket Number">

                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Seat</label>
                            <input autocomplete="off" type="text" class="form-control" name="seat"
                                value="Not Specify" placeholder="Seat">

                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Checkin</label>
                            <input autocomplete="off" type="text" class="form-control" name="checkin"
                                value="20 KG" placeholder="Checkin">

                        </div>
                        <input autocomplete="off" type="hidden" name="ppid" value="10524" />
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Cab</label>
                            <input autocomplete="off" type="text" class="form-control" name="cab"
                                value="7 KG" placeholder="Cab">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Status</label>
                            <input autocomplete="off" type="text" class="form-control" name="status"
                                value="active" placeholder="PNR STATUS">
                        </div>

                        <div class="col-md-12 mb-3">
                            <label class="form-label">Remarks Or Reason For the Update</label>
                            <input autocomplete="off" type="text" name="remarks" class="form-control"
                                value="" placeholder="Remarks or Reason for update">

                        </div>

                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <a href="#" class="btn btn-danger waves-effect waves-light" data-bs-dismiss="modal"
                        data-dismiss="modal" aria-label="Close">Close</a>
                    <button type="submit" class="btn btn-primary waves-effect waves-light">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    -->

<!-- Update Reservation Modal -->
<div class="modal fade" tabindex="-1" id="reservations" data-bs-backdrop="static" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title">Edit Reservation Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body bg-white">
        <p class="text-muted mb-3">
          Please select a passenger from the dropdown below to edit their reservation details.
        </p>

        <!-- Passenger Selector -->
        <div class="mb-4">
          <label class="form-label fw-bold">Select Passenger</label>
          <select id="reservationPassengerSelect" class="form-select">
            <!-- Populated dynamically -->
          </select>
        </div>

        <!-- Reservation Form -->
        <form id="reservationForm" method="POST" action="/admin/edit-reservations/<%= booking._id %>">
          <!-- Hidden fields to identify passenger -->
          <input type="hidden" name="first_name" id="resHiddenFirstName">
          <input type="hidden" name="last_name" id="resHiddenLastName">

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">PNR</label>
              <input type="text" class="form-control" name="pnr" id="resPnr"
                onkeyup="this.value=this.value.toUpperCase()" placeholder="PNR" value="<%= booking.flight.inventoryDates[0].pnr %>" readonly>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">E-Ticket Number</label>
              <input type="text" class="form-control" name="eticket" id="resEticket"
                onkeyup="this.value=this.value.toUpperCase()" placeholder="E-Ticket Number">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Seat</label>
              <input type="text" class="form-control" name="seat" id="resSeat" placeholder="Seat">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Checkin</label>
              <input type="text" class="form-control" name="checkin" id="resCheckin" placeholder="Checkin"  value="<%= booking.flight.baggage.adult.checkIn.weightPerPiece %>" readonly>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Cab</label>
              <input type="text" class="form-control" name="cab" id="resCab" placeholder="Cab"  value="<%= booking.flight.baggage.adult.cabin.weightPerPiece %>" readonly>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Status</label>
              <input type="text" class="form-control" name="status" id="resStatus" placeholder="PNR Status"  value="<%= booking.flight.isActive? 'Active':'Inactive' %>" readonly>
            </div>

            <div class="col-md-12 mb-3">
              <label class="form-label">Remarks or Reason for Update</label>
              <input type="text" name="remarks" id="resRemarks" class="form-control" placeholder="Remarks">
            </div>
          </div>
        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        <button type="submit" form="reservationForm" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const resSelect = document.getElementById("reservationPassengerSelect");

    // Populate dropdown
    travelers.forEach((t, i) => {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = `${t.first_name} ${t.last_name}`;
      resSelect.appendChild(option);
    });

    function loadReservation(index) {
      const pax = travelers[index];
      if (!pax) return;

      // Hidden identifiers
      document.getElementById("resHiddenFirstName").value = pax.first_name;
      document.getElementById("resHiddenLastName").value = pax.last_name;

      // Reservation fields
      document.getElementById("resEticket").value = pax.eticket_no || "";
      document.getElementById("resSeat").value = pax.seat_no || "";
      document.getElementById("resRemarks").value = pax.remarks || "";
    }

    // On change
    resSelect.addEventListener("change", e => loadReservation(e.target.value));

    // Load first passenger by default
    if (travelers.length > 0) {
      resSelect.value = 0;
      loadReservation(0);
    }
  });
</script>

    <!-- newaddon modal START -->
    <div class="modal fade" id="newaddon" data-bs-backdrop="static" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <!-- Title -->
                <div class="modal-header">
                    <h5 class="modal-title">Create Special service Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <!-- Body -->
                <div class="modal-body p-3">
                    <p>Book a wheelchair at least 48 hours prior to departure for a hassle-free travel.</p>
                    <form id="splreqForm" action="/admin/service-request/<%= booking._id%>" method="post">
                    <div class="row g-4 mb-3">
                        <div class="col-sm-4 form-group"><label class="form-label" for="pax">Passenger
                                Name</label>
                            <select class="form-control passenger-select" name="passengerName" id="passengerName" required>
  								<option value="">--Select Passenger--</option>
                            </select>
                        </div>
                        <div class="col-sm-4 form-group"><label class="form-label" for="pax">Flight
                            </label>
                              <select id="flight" class="form-control" required>
    <option class="opt" value="">--Select Flight Code--</option>

    <% if (booking.flight && booking.flight.stops && booking.flight.stops.length > 0) { %>
      <% booking.flight.stops.forEach(stop => { %>
        <option class="opt" value="<%= stop.airlineCode %>-<%= stop.flightNumber %>">
          <%= stop.airlineCode %>-<%= stop.flightNumber %>
        </option>
      <% }) %>
    <% } %>
  </select>
                        </div>
                        <div class="col-sm-4 form-group"><label class="form-label" for="pax">Service
                            </label>
                            <input autocomplete="off" list="sa" type="text" name="service" id="service" required
                                class="form-control" value="" placeholder="Special Service">
                            <datalist id="sa">
                                <option class="opt">Regular Information</option>
                                <option class="opt">Wheelchair Request</option>
                                <option class="opt">Meals Request</option>
                                <option class="opt">Seat Request</option>
                                <option class="opt">Addon Bag Request</option>
                            </datalist>

                            </select>
                        </div>

                        <input type="hidden" name="subject" id="requestFor">

                        <div class="col-sm-12 form-group"><label class="form-label" for="country">Reason
                                For Apply</label>
                            <input autocomplete="off" list="for" type="text" name="reqContent" required
                                class="form-control" value="" placeholder="Special Service">
                            <datalist id="for">
                                <option>Added Wheelchair Assistance
                                <option>Add Meals:
                                <option>Add Additional Bag:
                                <option>The full name of these passengers exceeds 27 characters. We have
                                    abbreviated
                                    the passenger name as per passenger name guidelines.
                                <option> The total length of the first and middle names of adults and infants
                                    not
                                    exceed 27 characters. We have abbreviated the passenger name as per
                                    passenger
                                    name guidelines.
                            </datalist>
                        </div>

                    </div>
                    <div class="modal-footer bg-light mb-2"> <button type="submit"
                            class="btn btn-sm btn-outline-primary mb-0">Submit
                            request</button> </div>
                    </form>

                </div>

            </div>
        </div>
    </div>
    <!-- newaddon modal END -->

    <script>
  document.addEventListener("DOMContentLoaded", () => {
    const serviceInput = document.getElementById("service");
    const flightSelect = document.getElementById("flight");
    const requestForInput = document.getElementById("requestFor");

    function updateRequestFor() {
      const service = serviceInput.value.trim();
      const flight = flightSelect.value.trim();
      if (service && flight) {
        requestForInput.value = `Request For ${service} in ${flight}`;
      } else {
        requestForInput.value = "";
      }
    }

    serviceInput.addEventListener("input", updateRequestFor);
    flightSelect.addEventListener("change", updateRequestFor);
  });
</script>

    <!-- OTP modal START -->
      <div class="modal fade" id="otp" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Title -->
                <div class="modal-header">
                    <h5 class="modal-title">Request For OK TO BOARD</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
 
                <!-- Body -->
                <div class="modal-body p-3">
                    <p>We help you in your visa verification process, You can apply for IndiGo, SpiceJet,Air India, Air India Express, Air Arabia, Oman Air, and for more Airlines. Apply online for instant ok to board approval, then get ready for a stress-free your any Gulf or
                        middle east Countries trip!</p>
						<form id="otbForm" enctype="multipart/form-data" action="/admin/service-request/<%= booking._id%>" method="post">
                    <div class="row g-4 mb-3">
                        <div class="col-sm-6 form-group"><label class="form-label" for="passengerName">Passenger Name</label>
							<select class="form-control passenger-select" name="passengerName" required>
  								<option value="">--Select Passenger--</option>
							</select>
                        </div>
                        <div class="col-sm-6 form-group"> <label class="form-label" for="ppf"> Upload Passport
                                First Page</label>
                            <input class="form-control" type="file" name="file" id="ppf"
                                required>
                        </div>
                        <div class="col-sm-6 form-group"> <label class="form-label" for="ppl">Upload Passport
                                Last Page</label>
                            <input class="form-control" type="file" name="file" id="ppl"
                                required>
                        </div>
                        <div class="col-sm-6 form-group"><label class="form-label" for="visa">Upload Visa
                                Copy</label>
                            <input class="form-control" type="file" name="file" id="visa"
                                required>
                        </div>

                        <div class="col-sm-6 form-group"><label class="form-label" for="rat">Upload Return Air
                                Ticket</label>
                            <input class="form-control" type="file" name="file" id="rat"
                                required>
                        </div>

                        <div class="col-sm-6 form-group"><label class="form-label" for="country">Travel 
								Country</label>
  							<select id="country" name="reqContent" class="form-control" required>
  							<option value="">--Select Country--</option>
  							</select>
  						</div>    
						
						<input type="hidden" name="subject" value="Request For OK TO BOARD"/>
                    </div>
                  <div class="modal-footer bg-light mb-2">
    <button type="submit" class="btn btn-sm btn-outline-primary mb-0">Submit request</button>
  </div>
</form>
                    <h6 class="alert-heading h6">Instructions for OKTB Applications</h6>
                    <ul>
                        <li>By processing, You accept Booking <a href="/terms-and-conditions">Terms of Services</a> and <a
                                href="/privacy-policy">Policy</a></li>
                        <li>Steps: Submit Request -> Our team will forward the possibilities to OTB teams, once it is approved we will add the service cost. You have to pay the amount within the deadline. Once it is completed, OTB teams will be updated.</li>
                        <li>Indigo, Air Arabia, Spicejet: Apply at least 12 hours before your flight, during working
                            hours (09:30 AM–06:30 PM) (Urgent Charges will be applicable within 12 hours).</li>
                        <li>Air India, Air India Express: Apply in advance at least 24 to 48 hours before your flight
                            (Urgent Charges will be applicable within 24 hours).</li>
                        <li>Mandatory Requirement: When traveling with Oman Air, you must have a confirmed return ticket
                            for 'OK to Board' (OTB) updation. However, if you are traveling on a work employment visa
                            (UAE visa/Oman/Qatar/Bahrain or other countries visa) or traveling with other airlines, a
                            return ticket is not mandatory. In such cases, please use return ticket option to re-upload
                            your same ticket.</li>
                        <li>Please note that submissions made at night will not be counted as falling within the
                            less-than-24-hours or less-than-12-hours categories. The processing clock will start during
                            the next working hours.</li>
                        <li>Once your application is forwarded to the airlines and processed, we are unable to provide
                            refunds. In case your request cannot be processed by the airlines due to insufficient time,
                            a partial refund may be considered.</li>
                        <li>Once request we will generate a support Id. it shows on manage supports tab </li>
                    </ul>
                </div>
              
            </div>
        </div>
    </div>
    <!-- OTP modal END -->
  
        <!-- name correct modal START -->
    <!-- modal (HTML) -->
    <div class="modal fade" id="namecorrect" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Title -->
                <div class="modal-header">
                    <h5 class="modal-title">Name correction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form class="row g-3" id="changeNameForm" enctype="multipart/form-data" action="/admin/support-request/<%= booking._id%>" method="post">
                <!-- Body -->
                <div class="modal-body p-3">
                    <p>Name corrections are allowed as per airline policy. Complete changes are not allowed. If you opt
                        for the Name Update Protection Plan, charges will be covered. In all other cases, charges as per
                        airline policy will apply.</p>
                    <div class="row g-4 mb-3">
                        <div class="col-6 form-group"><label class="form-label" for="passengerName">Passenger Name</label>
							<select class="form-control passenger-select" name="passengerName" required>
  								<option value="">--Select Passenger--</option>
							</select>
                        </div>
                        <div class="col-sm-6">
                            <label for="formFile" class="form-label"> Passenger ID Proof</label>
                            <input class="form-control" type="file"  id="file" name="file">
                        </div>
                        <div class="col-sm-12"><label class="form-label" for="country">Correct Name of
                                Passenger</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="First name" name="firstName">
                                <input type="text" class="form-control" placeholder="Last name" name="lastName">
                            </div>
                        </div>

                    </div>
                    <input type="hidden" name="subject" value="Request For Name Correction"/>
                    <input type="hidden" name="reqContent" id="subjectInput" />

                    <button type="submit" class="btn btn-sm btn-outline-primary mb-0">Submit
                                                            request</button>
                </div>
                </form>
                    <h6 class="alert-heading h6">Instructions for Name correction</h6>
                    <ul>
                        <li>By processing, You accept Booking <a href="#">Terms of Services</a> and <a
                                href="#">Policy</a></li>
                        <li>Steps: Submit Request -> Our team will forward the request to the sales teams and once it is
                            accepted we will add the service cost. You have to pay the amount within the time. Once it
                            is completed the seller will be updated.</li>
                        <li>You should inform the correction at least 48 hours before your flight's departure. </li>
                        <li>Once request we will response a support Id. it shows on manage supports tab then please
                            confirm it. after make payment to update Names.</li>

                    </ul>
            </div>
        </div>
    </div>
    <!-- name correction modal END -->

    <script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("changeNameForm");
  const subjectInput = document.getElementById("subjectInput");

  form.addEventListener("submit", (e) => {
    const passengerSelect = form.querySelector("select[name='passengerName']");
    const firstName = form.querySelector("input[name='firstName']").value.trim();
    const lastName = form.querySelector("input[name='lastName']").value.trim();

    const currentName = passengerSelect.value.toUpperCase();
    const newName = (firstName + " " + lastName).trim().toUpperCase();

    if (!currentName || !newName) {
      e.preventDefault();
       Swal.fire({
    icon: "warning",
    title: "Missing Information",
    text: "Please select a passenger and enter the new name.",
    confirmButtonText: "OK"
  });
      return;
    }

    subjectInput.value = `I want to change my name from ${currentName} to ${newName}. Please share the possibility and charges.`;
  });
});
</script>

        <!-- Wheelchair modal START -->
    <div class="modal fade" id="Wheelchair" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Title -->
                <div class="modal-header">
                    <h5 class="modal-title">Request For Wheelchair Assistance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
 
                <!-- Body -->
                <div class="modal-body p-3">
                    <p>Book a wheelchair at least 48 hours prior to departure for a hassle-free travel.</p>
					<form id="wheelchairForm" action="/admin/service-request/<%= booking._id%>" method="post">
                    <div class="row g-4 mb-3">
                         <div class="col-sm-6 form-group"><label class="form-label" for="passengerName" >Passenger Name</label>
                            <select class="form-control passenger-select" name="passengerName" required>
  								<option value="">--Select Passenger--</option>
							</select>
                        </div>
                        
                        <div class="col-sm-6 form-group"><label class="form-label" for="reason">Reason
                                For Apply</label>
                            <select id="reason" name="reqContent" class="form-control" required>
                                <option class="opt" value="">--Select Reason--</option>
                                <option class="opt" >Unable to walk long distance</option>
                                <option class="opt">Paraplegic</option>
                            </select>
                        </div>
                        
						<input type="hidden" name="subject" value="Request For Wheelchair Assistance"/>

                    </div>
                <div class="modal-footer bg-light mb-2">
    <button type="submit" class="btn btn-sm btn-outline-primary mb-0">Submit request</button>
  </div>
</form>
                    <h6 class="alert-heading h6">Instructions for Wheelchair Assistance</h6>
                    <ul>
                        <li>By processing, You accept Booking <a href="/terms-and-conditions">Terms of Services</a> and <a
                                href="/privacy-policy">Policy</a></li>
                        <li>Steps: Submit Request -> Our team will forward the request to the sales teams and once it is accepted we will add the service cost. You have to pay the amount within the time. Once it is completed the seller will be updated.</li>
                        <li>You should book it at least 48 hours before your flight's departure. provides wheelchair assistance based on availability, so it's best to book in advance. </li>
                        <li>Some airlines not charge extra for providing wheelchair assistance. but the last moment case they will charge.</li>
                         <li>Once request we will generate a support Id. it shows on manage supports tab </li>
                            
                    </ul>
                </div>
              
            </div>
        </div>
    </div>
    <!-- Wheelchair modal END -->

        <!-- seats modal START -->
    <div class="modal fade" id="seats" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Title -->
                <div class="modal-header">
                    <h5 class="modal-title">Request For Seats</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
 
                <!-- Body -->
                <div class="modal-body p-3">
                    <p>Book a seats at least 48 hours prior to departure for a hassle-free travel.</p>
					<form id="seatForm" action="/admin/service-request/<%= booking._id%>" method="post">
                    <div class="row g-4 mb-3">
                         <div class="col-sm-6 form-group">
                            <label class="form-label" for="passengerName">Passenger Name</label>
                            <select class="form-control passenger-select" name="passengerName">
  								<option value="">--Select Passenger--</option>
							</select>
                        </div>
                        
                        <div class="col-sm-6 form-group"><label class="form-label" for="seats">Explain The Seats Row</label>
                            <input id="seats" class="form-control" maxlength="50" placeholder="Type row and seat side" name="reqContent" required> 
                        </div>
                    
						<input type="hidden" name="subject" value="Request For Seats"/>

                    </div>
                <div class="modal-footer bg-light mb-2">
    <button type="submit" class="btn btn-sm btn-outline-primary mb-0">Submit request</button>
  </div>
</form>
                    <h6 class="alert-heading h6">Instructions for Seats</h6>
                    <ul>
                        <li>By processing, You accept Booking <a href="/terms-and-conditions">Terms of Services</a> and <a
                                href="/privacy-policy">Policy</a></li>
                        <li>Steps: Submit Request -> Our team will forward the request to the sales teams and once it is accepted we will add the service cost. You have to pay the amount within the time. Once it is completed the seller will be updated.</li>
                        <li>You should book it at least 48 hours before your flight's departure. provides seats assistance based on availability, so it's best to book in advance. </li>
                        <li>Please Write the <b>Seat Number and Seat side like Window seat, Middle , Aisle </b></li>
                        <li>Once request we will response a support Id. it shows on manage supports tab then please confirm it. after make payment to add seats.</li>
                         
                    </ul>
                </div>
              
            </div>
        </div>
    </div>
    <!-- seats modal END -->

          <!-- meals modal START -->
    <div class="modal fade" id="meals" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Title -->
                <div class="modal-header">
                    <h5 class="modal-title">Request For Meals</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
 
                <!-- Body -->
                <div class="modal-body p-3">
                    <p>Book a Meals at least 48 hours prior to departure for a hassle-free travel.</p>
					<form id="mealForm" action="/admin/service-request/<%= booking._id%>" method="post">
                    <div class="row g-4 mb-3">
                         <div class="col-sm-6 form-group"><label class="form-label" for="passengerName">Passenger Name</label>
                            <select class="form-control passenger-select" name="passengerName" required>
  								<option value="">--Select Passenger--</option>
							</select>
                        </div>
                        
                        <div class="col-sm-6 form-group"><label class="form-label" for="meals">Select the Meals</label>
                            <select id="meals" name="reqContent" class="form-control" required>
                                <option class="opt" value="">--Select Meals--</option>
                                <option class="opt" >Lite Veg Meals</option>
                                <option class="opt" >Lite Non Veg Meals</option> 
                                <option class="opt">Standard Veg Meal</option> 
                                <option class="opt">Standard Non Veg Meal</option>
                            </select>
                        </div>
                        
						<input type="hidden" name="subject" value="Request For Meals"/>

                    </div>
                <div class="modal-footer bg-light mb-2">
    <button type="submit" class="btn btn-sm btn-outline-primary mb-0">Submit request</button>
  </div>
</form>
                    <h6 class="alert-heading h6">Instructions for Meals</h6>
                    <ul>
                        <li>By processing, You accept Booking <a href="/terms-and-conditions">Terms of Services</a> and <a
                                href="/privacy-policy">Policy</a></li>
                        <li>Steps: Submit Request -> Our team will forward the request to the sales teams and once it is accepted we will add the service cost. You have to pay the amount within the time. Once it is completed the seller will be updated.</li>
                        <li>You should book it at least 48 hours before your flight's departure. provides Meals based on availability, so it's best to book in advance. </li>
                        <li>Once request we will response a support Id. it shows on manage supports tab then please confirm it. after make payment to add meals.</li>
                         
                    </ul>
                </div>
              
            </div>
        </div>
    </div>
    <!-- meals modal END -->
     
      <!-- Bag modal START -->
    <div class="modal fade" id="addbag" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Title -->
                <div class="modal-header">
                    <h5 class="modal-title">Request For Additional Checked In Baggage</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
 
                <!-- Body -->
                <div class="modal-body p-3">
                    <p>Book a Bag at least 48 hours prior to departure for a hassle-free travel.</p>
					<form id="baggageForm" action="/admin/service-request/<%= booking._id%>" method="post">
                    <div class="row g-4 mb-3">
                         <div class="col-sm-6 form-group"><label class="form-label" for="passengerName">Passenger Name</label>
                            <select class="form-control passenger-select" name="passengerName" required>
  								<option value="">--Select Passenger--</option>
							</select>
                        </div>
                        
                        <div class="col-sm-6 form-group"><label class="form-label" for="baggage">Select the KG</label>
                            <select id="baggage" name="reqContent" class="form-control" required="">
                                <option class="opt" value="">--Select Bag--</option>
                                <option class="opt" >Prepaid Excess Baggage 5 Kg</option>
                                <option class="opt" >Prepaid Excess Baggage 10 Kg</option> 
                                <option class="opt">Prepaid Excess Baggage 15 Kg</option> 
                                <option class="opt">Prepaid Excess Baggage 20 Kg</option>
                                <option class="opt">Prepaid Excess Baggage 30 Kg</option>
                            </select>
                        </div>

                   <input type="hidden" name="subject" value="Request For Additional Baggage"/>

                    </div>
                <div class="modal-footer bg-light mb-2">
    <button type="submit" class="btn btn-sm btn-outline-primary mb-0">Submit request</button>
  </div>
</form>
                    <h6 class="alert-heading h6">Instructions for Additional Checked In Baggage</h6>
                    <ul>
                        <li>By processing, You accept Booking <a href="/terms-and-conditions">Terms of Services</a> and <a
                                href="/privacy-policy">Policy</a></li>
                        <li>Steps: Submit Request -> Our team will forward the request to the sales teams and once it is accepted we will add the service cost. You have to pay the amount within the time. Once it is completed the seller will be updated.</li>
                        <li>You should book it at least 48 hours before your flight's departure. provides Additional Checked In Baggage based on availability, so it's best to book in advance. </li>
                        <li>Once request we will response a support Id. it shows on manage supports tab then please confirm it. after make payment to add Additional Checked In Baggage.</li>
                         
                    </ul>
                </div>
              
            </div>
        </div>
    </div>
    <!-- Bag modal END -->

<!-- select intrefundtrs modal -->
    <div class="modal fade" tabindex="-1" role="dialog" id="intrefundtrs">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="title m-4">Customer Refund Add in to Accounts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
                </div>
                <form id="customerRefundForm" action="/admin/service-charge/<%= booking._id%>" method="post" class="form-validate is-alter">
                <div class="modal-body bg-white">
                        <div class="row gy-4">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="form-label" for="supplierCost">Supplier Dedicated Cost
                                    </label>
                                    <div class="form-control-wrap">
                                        <input type="text" class="form-control" id="supplierCost" name="supplierCost" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="form-label" for="customerCost">Refunded to Customer</label>
                                    <div class="form-control-wrap">
                                        <input type="text" class="form-control" id="customerCost" name="customerCost" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Used Payment Method </label>
                                <select name="paymentMethod" class="form-control" required>
                                    <option>Supplier Wallet</option>
                                    <option>Bank Accounts</option>
                                </select>
                            </div>

                            <input type="hidden" name="purpose" value="Customer Refund Add in to Accounts"/>
                        </div>
                </div>
                <div class="modal-footer bg-light">
                    <a href="#" class="btn btn-danger waves-effect waves-light" data-bs-dismiss="modal"
                        data-dismiss="modal" aria-label="Close">Close</a>
                    <button type="submit" class="btn btn-primary waves-effect waves-light">Confirm</button>
                </div>
                </form>
            </div><!-- .modal-content -->
        </div><!-- .modla-dialog -->
    </div><!-- .modal -->

            <!-- create datechange cost modal -->
        <div class="modal fade" tabindex="-1" role="dialog" id="datechange">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                      <div class="modal-header">
                    <h5 class="title m-4">Create Additional Service Charges</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
                </div>
                  
                  <form id="serviceChargeForm" action="/admin/service-charge/<%= booking._id%>" method="post">
                    <div class="modal-body bg-white">
                        <div class="row">
                            <div class="col-md-9 mb-3">
                                <label class="form-label">Transaction For</label>
                                <input autocomplete="off" list="forTransaction" type="text" name="purpose" required
                                    class="form-control" placeholder="Purpose of the charge">
                                <datalist id="forTransaction">
                                    <option>Add Date Change Panaly For <%=booking.bookingId%> & PNR: <%=booking.flight.inventoryDates[0].pnr%>
                                    <option>Add Food For <%=booking.bookingId%> & PNR:  <%=booking.flight.inventoryDates[0].pnr%>
                                    <option>Add Additional Bag For <%=booking.bookingId%> & PNR:  <%=booking.flight.inventoryDates[0].pnr%>
                                    <option>Add Dummy Ticket For <%=booking.bookingId%> & PNR:  <%=booking.flight.inventoryDates[0].pnr%>
                                    <option>Add Fare Difference For <%=booking.bookingId%> & PNR:  <%=booking.flight.inventoryDates[0].pnr%>
                                </datalist>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Customer Cost</label>
                                <input autocomplete="off" type="number" name="customerCost"
                                    onkeypress='return event.charCode >= 48 && event.charCode <= 57' required
                                    class="form-control" placeholder="Customer Charge">

                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Supplier </label>
                                <input autocomplete="off" type="text" name="supplier" class="form-control"
                                    placeholder="Supplier">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Used Payment Method </label>
                                <select name="paymentMethod" class="form-control" required>
                                    <option>Supplier Wallet</option>
                                    <option>Bank Accounts</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Supplier Cost</label>
                                <input autocomplete="off" type="number" name="supplierCost"
                                    onkeypress='return event.charCode >= 48 && event.charCode <= 57' required
                                    class="form-control" placeholder="Provider Dedicated Charge">

                            </div>
                          </div>
                        </div>
                        <div class="modal-footer bg-light">
                        <a href="#" class="btn btn-danger waves-effect waves-light" data-bs-dismiss="modal"
                        data-dismiss="modal" aria-label="Close">Close</a>
                        <button type="submit" class="btn btn-primary waves-effect waves-light">Confirm</button>
                      </div>
                    </form>

                </div><!-- .modal-content -->
            </div><!-- .modla-dialog -->
        </div><!-- .modal -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const clipboard = new ClipboardJS(".clipboard-init");

    clipboard.on("success", (e) => {
      Swal.fire({
        toast: true,
        position: "top-end",
        icon: "success",
        title: "PNR copied!",
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
      });
    });

    clipboard.on("error", () => {
      Swal.fire({
        toast: true,
        position: "top-end",
        icon: "error",
        title: "Failed to copy",
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
      });
    });
  });
</script>

<script>
  async function populateCountryDropdowns() {
    try {
      const response = await fetch("/api/countries");
      const countries = await response.json();

      const countrys = document.querySelectorAll("#country");

      countries.forEach(country => {
        const option = document.createElement("option");
        option.value = country;
        option.textContent = country;

        countrys.forEach(select => {
          select.appendChild(option.cloneNode(true));
        });
      });
    } catch (err) {
      console.error("Error fetching country list:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    setTimeout(populateCountryDropdowns, 200);
  });
</script>

<script id="passenger-data">
  const passengers = <%- JSON.stringify(booking.travelers.map(t => ({
    name: `${t.first_name} ${t.last_name}`
  }))) %>;
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".passenger-select").forEach(select => {
      passengers.forEach(p => {
        const option = document.createElement("option");
        option.value = p.name;      
        option.textContent = p.name;
        select.appendChild(option);
      });
    });
  });
</script>

<style>
  .table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

</style>

	</main>
<!-- **************** MAIN CONTENT END **************** -->

<%- include('./partials/footer') %>