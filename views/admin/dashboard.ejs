<%- include('./partials/header') %>

	<!-- **************** MAIN CONTENT START **************** -->
	<main>

		<!-- Sidebar START -->
		<%- include('./partials/sideBar') %>
			<!-- Sidebar END -->

			<!-- Page content START -->
			<div class="page-content">

				<!-- Top bar START -->
				<%- include('./partials/topBar') %>
					<!-- Top bar END -->

					<!-- Page main content START -->
					<div class="page-content-wrapper p-xxl-4">

						<!-- Title -->
						<div class="row">
							<div class="col-12 mb-4 mb-sm-5">
								<div class="d-sm-flex justify-content-between align-items-center">
									<h1 class="h4 mb-2 mb-sm-0">Dashboard</h1>
									<div class="d-grid"><a href="/admin/add-flight" class="btn btn-primary-soft mb-0"><i
												class="bi bi-plus-lg fa-fw"></i> Add New Flight</a></div>
								</div>
							</div>
						</div>

						<!-- Counter boxes START -->
					<div class="row g-4 mb-5">
						<!-- Counter item -->
						<div class="col-md-6 col-xxl-3">
							<div
								class="card card-body bg-warning bg-opacity-10 border border-warning border-opacity-25 p-4 h-100">
								<div class="d-flex justify-content-between align-items-center">
									<!-- Digit -->
									<div>
										<h4 class="mb-0"><%= bookings.length %></h4>
										<span class="h6 fw-light mb-0">Total Booking</span>
									</div>
									<!-- Icon -->
									<div class="icon-lg rounded-circle bg-warning text-white mb-0"><i
											class="fa-solid fa-ticket fa-fw"></i></div>
								</div>
							</div>
						</div>

						<!-- Counter item -->
						<div class="col-md-6 col-xxl-3">
							<div
								class="card card-body bg-success bg-opacity-10 border border-success border-opacity-25 p-4 h-100">
								<div class="d-flex justify-content-between align-items-center">
									<!-- Digit -->
									<div>
										<h4 class="mb-0"><%= flights.length %></h4>
										<span class="h6 fw-light mb-0">Total Listing</span>
									</div>
									<!-- Icon -->
									<div class="icon-lg rounded-circle bg-success text-white mb-0"><i
											class="fa-solid fa-clipboard-check fa-fw"></i></div>
								</div>
							</div>
						</div>

						<!-- Counter item -->
						<div class="col-md-6 col-xxl-3">
							<div
								class="card card-body bg-primary bg-opacity-10 border border-primary border-opacity-25 p-4 h-100">
								<div class="d-flex justify-content-between align-items-center">
									<!-- Digit -->
									<div>
										<h4 class="mb-0"><%= users.length %></h4>
										<span class="h6 fw-light mb-0">Total Customers</span>
									</div>
									<!-- Icon -->
									<div class="icon-lg rounded-circle bg-primary text-white mb-0"><i
											class="fa-solid fa-users fa-fw"></i></div>
								</div>
							</div>
						</div>

						<!-- Counter item -->
						<div class="col-md-6 col-xxl-3">
							<div
								class="card card-body bg-info bg-opacity-10 border border-info border-opacity-25 p-4 h-100">
								<div class="d-flex justify-content-between align-items-center">
									<!-- Digit -->
									<div>
										<h4 class="mb-0"><%= sellers.length %></h4>
										<span class="h6 fw-light mb-0">Total Sellers</span>
									</div>
									<!-- Icon -->
									<div class="icon-lg rounded-circle bg-info text-white mb-0"><i
											class="fa-solid fa-building-circle-check fa-fw"></i></div>
								</div>
							</div>
						</div>
					</div>
					<!-- Counter boxes END -->

						<!-- Popular Flights START -->
						<div class="row g-4 mb-5">
							<!-- Title -->
							<div class="col-12">
								<div class="d-flex justify-content-between">
									<h4 class="mb-0">Popular Flights</h4>
									<a href="/admin/popular-flights" class="btn btn-primary-soft mb-0">View All</a>
								</div>
							</div>

							<% popularFlights.forEach((flight)=> { %>
								<% if(popularFlights.length> 0 ) { %>
									<!-- Hotel item -->
									<div class="col-lg-6">
										<div class="card shadow p-3">
											<div class="row g-4">
												<!-- Card img -->
												<div class="col-md-3">
													<img src="<%= flight.image %>" class="rounded-2" alt="Card image">
												</div>

												<!-- Card body -->
												<div class="col-md-9">
													<div
														class="card-body position-relative d-flex flex-column p-0 h-100">

														<!-- Title -->
														<h5 class="card-title mb-0 me-5">
															<p>
																<%= flight.fromCity %> <i
																		class="fa-solid fa-fw fa-plane rtl-flip"> </i>
																	<%= flight.toCity %>
															</p>
														</h5>

														<!-- Price and Button -->
														<div
															class="d-sm-flex justify-content-sm-between align-items-center mt-3 mt-md-auto">
															<small>
																<%= flight.fromCode %> - <%= flight.toCode %>
															</small>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<% } else { %>
										<a href="/admin/popular-flights" class="btn btn-primary">Add Popular Flights
											Routes</a>
									<% }%>
							<% }) %>
						</div>
						<!-- Popular Flights END -->

						<!-- Widget START -->
					<div class="row g-4">
						<!-- Rooms START -->
						<div class="col-lg-6 col-xxl-6">
							<div class="card shadow h-100">
								<!-- Card header -->
								<div
									class="card-header border-bottom d-flex justify-content-between align-items-center">
									<h5 class="card-header-title">Latest Orders History</h5>
									<a href="/admin/bookings" class="btn btn-link p-0 mb-0">View all</a>
								</div>

								<!-- Card body START -->
								<div class="card-body">
									<% bookings.slice(0, 5).forEach((booking) => { %>
										<!-- Rooms item START -->
									<div class="d-flex justify-content-between align-items-center">
										<!-- Image and info -->
										<div class="d-sm-flex align-items-center mb-1 mb-sm-0">
											<!-- Avatar -->
											<div class="avatar avatar-md flex-shrink-0">
												<img class="rounded-circle"
													src="<%= booking.flight.stops[0].airlineLogo %>">
											</div>
											<!-- Info -->
											<div class="ms-sm-3 mt-2 mt-sm-0">
												<h6 class="mb-1"><%= booking.flight.fromCity %> ➝ <%= booking.flight.toCity %> on <%= booking.flight.stops[0].airline %></h6>
												<ul class="nav nav-divider small">
													<li class="nav-item">
														<%= booking.flight.departureDate %> | 
														<%= booking.travelers.length %> 
														<%= booking.travelers.length > 1 ? "Passengers" : "Passenger" %>
													  </li>
													  
													  <li class="nav-item">
														<span class="<%= booking.status === 'active' ? 'text-success' : 'text-danger' %>">
														  <%= booking.status === 'active' ? 'Confirmed' : 'Cancelled' %>
														</span>
													  </li>													  
												</ul>
											</div>
										</div>
										<!-- Button -->
										<a href="/admin/booking-detail/<%=booking._id%>"
											class="btn btn-sm btn-light flex-shrink-0 mb-0 ms-3">View</a>
									</div>
									<!-- Rooms item END -->
									<hr><!-- Divider -->
									<% }) %>
								</div>
								<!-- Card body END -->
							</div>
						</div>
						<!-- Rooms END -->

						<!-- Upcoming Arrival START -->
						<div class="col-lg-6 col-xxl-6">
							<div class="card shadow h-100">
								<!-- Card header -->
								<div
									class="card-header border-bottom d-flex justify-content-between align-items-center">
									<h5 class="card-header-title">Latest Inventory History</h5>
									<a href="/admin/inventory/active" class="btn btn-link p-0 mb-0">View all</a>
								</div>

								<!-- Card body START -->
								<div class="card-body">
									<% flights.slice(0, 5).forEach((flight) => { %>
									<!-- Rooms item START -->
									<div class="d-flex justify-content-between align-items-center">
										<!-- Image and info -->
										<div class="d-sm-flex align-items-center mb-1 mb-sm-0">
											<!-- Avatar -->
											<div class="avatar avatar-md flex-shrink-0">
												<img class="rounded-circle"
													src="<%= flight.stops[0].airlineLogo %>">
											</div>
											<!-- Info -->
											<div class="ms-sm-3 mt-2 mt-sm-0">
												<h6 class="mb-1"><%= flight.fromCity %> ➝ <%= flight.toCity %> on <%= flight.stops[0].airline %></h6>
												<ul class="nav nav-divider small">
													<li class="nav-item"><%= flight.departureDate %> | <%= flight.inventoryDates[0].seats %> Seats</li>
													<li class="nav-item">
														<span class="<%= flight.isActive ? 'text-success' : 'text-danger' %>">
														  <%= flight.isActive ? 'Active' : 'Closed' %>
														</span>
													  </li>
													  
												</ul>
											</div>
										</div>
										<!-- Button -->
										<!-- <a href="#"
											class="btn btn-sm btn-light flex-shrink-0 mb-0 ms-3">View</a> -->
									</div>
									<!-- Rooms item END -->

									<hr><!-- Divider -->
									<% }) %>
								</div>
								<!-- Card body END -->
							</div>
						</div>
						<!-- Upcoming Arrival END -->
						<!-- Booking Chart START -->
						<div class="col-xxl-8">
							<!-- Chart START -->
							<div class="card shadow h-100">
								<!-- Card header -->
								<div class="card-header border-bottom">
									<h5 class="card-header-title">Booking Activity</h5>
								</div>

								<!-- Card body -->
								<div class="card-body">
									<!-- Content -->
									<div class="d-flex gap-4 mb-3">
										<h6><span class="fw-light"><i
													class="bi bi-square-fill text-primary"></i> Confirmed:</span> 475
											Orders</h6>
										<h6><span class="fw-light"><i class="bi bi-square-fill text-info"></i>
												Completed:</span> 157 Orders</h6>
									</div>
									<!-- Apex chart -->
									<div id="ChartGuesttraffic" class="mt-2"></div>
								</div>
							</div>
							<!-- Chart END -->
						</div>
						<!-- Booking Chart END -->

						<!-- Booking graph START -->
						<div class="col-lg-6 col-xxl-4">
							<div class="card shadow h-100">
								<!-- Card header -->
								<div class="card-header border-bottom">
									<h5 class="card-header-title">Inventory Availability</h5>
								</div>

								<!-- Card body START -->
								<div class="card-body p-3">
									<!-- Chart -->
									<div class="col-sm-6 mx-auto">
										<div class="d-flex justify-content-center"
											id="ChartTrafficRooms"></div>
									</div>

									<!-- Content -->
									<ul class="list-group list-group-borderless mb-0">
										<li class="list-group-item d-flex justify-content-between">
											<span class="h6 fw-light mb-0"><i
													class="text-success fas fa-circle me-2"></i> Available</span>
											<span class="h6 fw-light mb-0">500 Seats</span>
										</li>
										<li class="list-group-item d-flex justify-content-between">
											<span class="h6 fw-light mb-0"><i
													class="text-danger fas fa-circle me-2"></i> Sold Out</span>
											<span class="h6 fw-light mb-0">480 Seats</span>
										</li>
									</ul>
								</div>
							</div>
						</div>
						<!-- Booking graph END -->

						<!-- Reviews START -->
						<div class="col-lg-6 col-xxl-6">
							<div class="card shadow h-100">
								<!-- Card header -->
								<div class="card-header border-bottom d-flex justify-content-between align-items-center p-3">
									<h5 class="card-header-title">IATA Codes</h5>
									<div class="d-flex gap-2">
										<a href="#" class="btn btn-primary mb-1" data-bs-toggle="modal" data-bs-target="#addAirportModal">
											<i class="bi bi-plus-lg fa-fw"></i> Add New Code
										  </a>
										  
									</div>
								</div>
								  
								<!-- Card body START -->
								<div class="card-body p-3">

									<div
										class="d-md-flex justify-content-between align-items-center flex-wrap mb-3">
										<!-- Content -->
										<div>
											<p>Airport Informations</p>

										</div>
										<!-- Button -->
										<!-- <div>
											<form class="d-flex" method="GET" action="/admin/">
												<input name="code" class="form-control border-1 me-1" type="text" maxlength="3" placeholder="Search Airport Code">
												<button type="submit" class="btn btn-dark btn-round mb-0"><i class="bi bi-search fa-fw"></i></button>
											</form>
										</div> -->
										<div class="d-flex" id="airportSearchForm">
											<input id="searchCode" class="form-control border-1 me-1" type="text" maxlength="3" placeholder="Search Airport Code">
											<button id="searchBtn" class="btn btn-dark btn-round mb-0" type="button">
											  <i class="bi bi-search fa-fw"></i>
											</button>
										</div> 
									</div>

									<div class="table-responsive border-0">
										<table class="table align-middle p-4 mb-0 table-hover">

											<!-- Table head -->
											<thead class="table-dark">
												<tr>
													<th scope="col" class="border-0 rounded-start">Code</th>
													<th scope="col" class="border-0">City</th>
													<th scope="col" class="border-0">Airport</th>
													<th scope="col" class="border-0 rounded-end">Action</th>
												</tr>
											</thead>

											<!-- Table body START -->
											<tbody>
												<% if (airports && airports.length > 0) { %>
												  <% airports.forEach(airport => { %>
													<tr>
													  <td><%= airport.Value %></td>
													  <td>
														<%= airport.Name ? airport.Name.split('(')[0].trim().toLowerCase().replace(/\b\w/g, c => c.toUpperCase()) : '' %>
													  </td>
													  <td><%= airport.Airport %></td>
													  <td>
														<button
														class="btn btn-sm btn-danger-soft me-1 mb-1 mb-md-0 update-airport-btn"
														data-bs-toggle="modal"
														data-bs-target="#updateAirportModal"
														data-airport='<%- JSON.stringify(airport) %>'
													    >
														Update
													  	</button>
													  </td>
													</tr>
												  <% }) %>
												<% } else { %>
												  <tr>
													<td colspan="4" class="text-center">No airports found.</td>
												  </tr>
												<% } %>
											  </tbody>											  
											<!-- Table body END -->
										</table>
									</div>
									<!-- Table END -->
								</div>
								<!-- Card body END -->
							</div>
						</div>
						<!-- Reviews END -->

						<script>
							document.getElementById("searchBtn").addEventListener("click", async () => {
							  const code = document.getElementById("searchCode").value.trim().toUpperCase();
							  if (!code) return;
						  
							  try {
								const response = await fetch(`/admin/api/airports?code=${code}`);
								const data = await response.json();
						  
								const tableBody = document.querySelector("table tbody");
								tableBody.innerHTML = "";
						  
								if (data.airports.length > 0) {
								  data.airports.forEach(airport => {
									const city = airport.Name ? airport.Name.split('(')[0].trim().toLowerCase().replace(/\b\w/g, c => c.toUpperCase()) : '';
									const row = `
									  <tr>
										<td>${airport.Value}</td>
										<td>${city}</td>
										<td>${airport.Airport}</td>
										<td>
										  <button class="btn btn-sm btn-danger-soft me-1 mb-1 mb-md-0 update-airport-btn"
												  data-bs-toggle="modal"
												  data-bs-target="#updateAirportModal"
												  data-airport='${JSON.stringify(airport)}'>
											Update
										  </button>
										</td>
									  </tr>
									`;
									tableBody.insertAdjacentHTML("beforeend", row);
								  });
								} else {
								  tableBody.innerHTML = `<tr><td colspan="4" class="text-center">No airports found.</td></tr>`;
								}
							  } catch (error) {
								console.error("Search failed:", error);
							  }
							});
						  </script>
						  
						<!-- Reviews START -->
<div class="col-lg-6 col-xxl-6">
  <div class="card shadow h-100">
    <!-- Card header -->
    <div class="card-header border-bottom d-flex justify-content-between align-items-center p-3">
      <h5 class="card-header-title">Support Task</h5>
      <div class="d-flex">
        <input id="support-search" class="form-control border-1 me-1" type="text" maxlength="20" placeholder="Search Support ID">
        <button type="button" class="btn btn-dark btn-round mb-0 flex-shrink-0" id="search-btn">
          <i class="bi bi-search fa-fw"></i>
        </button>
      </div>
    </div>

    <!-- Support list -->
    <div id="support-list">
      <% supports.forEach((support) => { %>
        <div class="card-body border-bottom p-3">
          <h6>
            <span class="text-body fw-light"><%= support.enquiryId %>:</span> <%= support.subject %>
          </h6>
          <p><%= support.message %></p>

          <div class="d-flex justify-content-between align-items-center">
            <div>
              <a class="btn btn-sm btn-light mb-0" data-bs-toggle="collapse"
                href="#collapseComment-<%= support._id %>" role="button" aria-expanded="false"
                aria-controls="collapseComment-<%= support._id %>">
                Reply
              </a>
            </div>
          </div>

          <div class="collapse mt-2" id="collapseComment-<%= support._id %>">
  <form class="d-flex reply-form" data-id="<%= support._id %>">
    <textarea class="form-control mb-0 reply-textarea" placeholder="Add a comment..." rows="2" required></textarea>
    <button type="submit" class="btn btn-sm btn-primary ms-2 px-4 mb-0 flex-shrink-0">
      <i class="fas fa-paper-plane fs-5"></i>
    </button>
  </form>
</div>
        </div>
      <% }) %>
    </div>
  </div>
</div>
<!-- Reviews END -->

					</div>
					<!-- Widget END -->

					</div>
					<!-- Page main content END -->
			</div>
			<!-- Page content END -->

<!-- Add Airport Modal -->
<div class="modal fade" id="addAirportModal" tabindex="-1" aria-labelledby="addAirportModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg">
	  <div class="modal-content">
		<form id="addAirportForm">
		  <div class="modal-header">
			<h5 class="modal-title" id="addAirportModalLabel">Add New Airport Code</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		  </div>
		  <div class="modal-body">
			<div class="row g-3">
			  <div class="col-md-6">
				<label class="form-label">IATA Code (Value)</label>
				<input type="text" class="form-control" name="Value" maxlength="3" required />
			  </div>
			  <div class="col-md-6">
				<label class="form-label">Type</label>
				<input type="text" class="form-control" name="Type" />
			  </div>
			  <div class="col-md-6">
				<label class="form-label">Name</label>
				<input type="text" class="form-control" name="Name" />
			  </div>
			  <div class="col-md-6">
				<label class="form-label">PopCity</label>
				<input type="text" class="form-control" name="PopCity" />
			  </div>
			  <div class="col-md-6">
				<label class="form-label">Country Code</label>
				<input type="text" class="form-control" name="CountryCode" />
			  </div>
			  <div class="col-md-6">
				<label class="form-label">Currency Code</label>
				<input type="text" class="form-control" name="CurrencyCode" />
			  </div>
			  <div class="col-md-6">
				<label class="form-label">Airport</label>
				<input type="text" class="form-control" name="Airport" />
			  </div>
			  <div class="col-md-6">
				<label class="form-label">Country Name</label>
				<input type="text" class="form-control" name="CountryName" />
			  </div>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="submit" class="btn btn-primary">Add Airport</button>
		  </div>
		</form>
	  </div>
	</div>
  </div>
  
  <script>
	document.getElementById("addAirportForm").addEventListener("submit", async function (e) {
	  e.preventDefault();
  
	  const formData = new FormData(this);
	  const airportData = Object.fromEntries(formData.entries());
  
	  try {
		const response = await fetch("/admin/add-airport", {
		  method: "POST",
		  headers: {
			"Content-Type": "application/json"
		  },
		  body: JSON.stringify(airportData)
		});
  
		const result = await response.json();
  
		if (response.ok) {
  Swal.fire({
    icon: 'success',
    title: 'Success',
    text: 'Airport added successfully!',
    confirmButtonText: 'OK'
  }).then(() => location.reload());
} else {
  Swal.fire({
    icon: 'error',
    title: 'Failed',
    text: result.error || "Something went wrong.",
    confirmButtonText: 'OK'
  });
}
	  } catch (error) {
		console.error("Error adding airport:", error);
Swal.fire({
  icon: 'error',
  title: 'Error',
  text: 'Failed to add airport.',
  confirmButtonText: 'OK'
});
	  }
	});
  </script>

  <!-- Update Airport Modal -->
<div class="modal fade" id="updateAirportModal" tabindex="-1" aria-labelledby="updateAirportModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg">
	  <div class="modal-content">
		<form id="updateAirportForm">
		  <div class="modal-header">
			<h5 class="modal-title" id="updateAirportModalLabel">Update Airport Code</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		  </div>
		  <div class="modal-body">
			<input type="hidden" name="_id" />
			<div class="row g-3">
			  <!-- Reuse the same fields from Add Modal -->
			  <div class="col-md-6"><label class="form-label">IATA Code (Value)</label><input type="text" class="form-control" name="Value" maxlength="3" required /></div>
			  <div class="col-md-6"><label class="form-label">Type</label><input type="text" class="form-control" name="Type" /></div>
			  <div class="col-md-6"><label class="form-label">Name</label><input type="text" class="form-control" name="Name" /></div>
			  <div class="col-md-6"><label class="form-label">PopCity</label><input type="text" class="form-control" name="PopCity" /></div>
			  <div class="col-md-6"><label class="form-label">Country Code</label><input type="text" class="form-control" name="CountryCode" /></div>
			  <div class="col-md-6"><label class="form-label">Currency Code</label><input type="text" class="form-control" name="CurrencyCode" /></div>
			  <div class="col-md-6"><label class="form-label">Airport</label><input type="text" class="form-control" name="Airport" /></div>
			  <div class="col-md-6"><label class="form-label">Country Name</label><input type="text" class="form-control" name="CountryName" /></div>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="submit" class="btn btn-primary">Update Airport</button>
		  </div>
		</form>
	  </div>
	</div>
  </div>

  <script>
	// Prefill update modal
	document.addEventListener("click", function (e) {
  if (e.target.classList.contains("update-airport-btn") || e.target.closest(".update-airport-btn")) {
    const btn = e.target.closest(".update-airport-btn");
    const airport = JSON.parse(btn.dataset.airport);
    const form = document.getElementById("updateAirportForm");

    Object.keys(airport).forEach((key) => {
      if (form.elements[key]) {
        form.elements[key].value = airport[key];
      }
    });
  }
});
  
	// Handle update form submission
	document.getElementById("updateAirportForm").addEventListener("submit", async function (e) {
	  e.preventDefault();
  
	  const formData = new FormData(this);
	  const updatedAirport = Object.fromEntries(formData.entries());
  
	  try {
		const response = await fetch("/admin/update-airport", {
		  method: "POST",
		  headers: {
			"Content-Type": "application/json"
		  },
		  body: JSON.stringify(updatedAirport)
		});
  
		const result = await response.json();
  
		if (response.ok) {
  Swal.fire({
    icon: 'success',
    title: 'Updated',
    text: 'Airport updated successfully!',
    confirmButtonText: 'OK'
  }).then(() => location.reload());
} else {
  Swal.fire({
    icon: 'error',
    title: 'Update Failed',
    text: result.error || "Something went wrong.",
    confirmButtonText: 'OK'
  });
}

	  } catch (error) {
		console.error("Error updating airport:", error);
		Swal.fire({
  icon: 'error',
  title: 'Error',
  text: 'Failed to update airport.',
  confirmButtonText: 'OK'
});
	  }
	});
  </script>  
  
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("support-search");
    const searchBtn = document.getElementById("search-btn");
    const supportList = document.getElementById("support-list");

    // Initial bind for existing reply forms
    bindReplyForms();

    searchBtn.addEventListener("click", async () => {
      const query = searchInput.value.trim();
      try {
        const res = await fetch(`/admin/supports/search?search=${encodeURIComponent(query)}`);
        const data = await res.json();

        supportList.innerHTML = ""; // Clear old

        if (data.success && data.supports.length > 0) {
          data.supports.forEach((support) => {
            const collapseId = `collapseComment-${support._id}`;
            supportList.innerHTML += `
              <div class="card-body border-bottom p-3">
                <h6><span class="text-body fw-light">${support.enquiryId}:</span> ${support.subject}</h6>
                <p>${support.message}</p>

                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <a class="btn btn-sm btn-light mb-0" data-bs-toggle="collapse"
                      href="#${collapseId}" role="button" aria-expanded="false" aria-controls="${collapseId}">
                      Reply
                    </a>
                  </div>
                </div>

                <div class="collapse mt-2" id="${collapseId}">
                  <form class="d-flex reply-form" data-id="${support._id}">
                    <textarea class="form-control mb-0 reply-textarea" placeholder="Add a comment..." rows="2" required></textarea>
                    <button type="submit" class="btn btn-sm btn-primary ms-2 px-4 mb-0 flex-shrink-0">
                      <i class="fas fa-paper-plane fs-5"></i>
                    </button>
                  </form>
                </div>
              </div>
            `;
          });

          // 🟢 Re-bind the reply form listeners after search
          bindReplyForms();

        } else {
          supportList.innerHTML = `<p class="text-muted p-3">No support tasks found for ID "${query}".</p>`;
        }
      } catch (error) {
        console.error("Error fetching supports:", error);
        supportList.innerHTML = `<p class="text-danger p-3">Error loading support data. Try again.</p>`;
      }
    });

    // Function to bind reply form submit listeners
    function bindReplyForms() {
      document.querySelectorAll(".reply-form").forEach(form => {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const messageId = form.getAttribute("data-id");
          const textarea = form.querySelector(".reply-textarea");
          const reply = textarea.value.trim();

          if (!reply) return;

          try {
            const res = await fetch("/admin/send-response", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ messageId, reply })
            });

            const data = await res.json();

            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: 'Reply Sent',
                text: 'Your response has been sent to the user.',
                confirmButtonText: 'OK'
              });

              textarea.value = ""; // Clear textarea
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Failed',
                text: data.message || "Something went wrong.",
                confirmButtonText: 'OK'
              });
            }
          } catch (err) {
            console.error("Error sending reply:", err);
            Swal.fire({
              icon: 'error',
              title: 'Server Error',
              text: "Could not send reply. Try again later.",
              confirmButtonText: 'OK'
            });
          }
        });
      });
    }
  });
</script>

	</main>
	<!-- **************** MAIN CONTENT END **************** -->

	<%- include('./partials/footer') %>