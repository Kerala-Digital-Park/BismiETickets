<%- include('./partials/header') %>

<!-- **************** MAIN CONTENT START **************** -->
<main>
	
	<!-- Sidebar START -->
	<%- include('./partials/sideBar') %>
	<!-- Sidebar END -->
	
	<!-- Page content START -->
	<div class="page-content">
	
		<!-- Top bar START -->
		<%- include('./partials/topBar') %>
		<!-- Top bar END -->
	
		<!-- Page main content START -->
		<div class="page-content-wrapper p-xxl-4">

			<!-- Title -->
			<div class="row">
				<div class="col-12 mb-5">
					<div class="d-sm-flex justify-content-between align-items-center">
						<h1 class="h4 mb-2 mb-sm-0">Bookings</h1>
						<div class="d-grid"><a href="/" class="btn btn-primary-soft mb-0"><i class="bi bi-plus-lg fa-fw"></i>New Booking</a></div>					
					</div>
				</div>
			</div>

			<!-- Counter START -->
			<div class="row g-4 mb-5">
				<!-- Counter item -->
				<div class="col-md-6 col-xxl-3">
					<div class="card card-body shadow p-4">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<!-- Number -->
							<div class="me-2">
								<span>Total <br>Bookings</span>
								<h3 class="mb-0 mt-2"><%= totalBookings %></h3>
							</div>
							<!-- Icon -->
							<div class="icon-lg rounded-circle flex-shrink-0 bg-primary bg-opacity-10 text-primary mb-0">
								<i class="bi bi-airplane fa-fw"></i>
							</div>
						</div>
						<!-- Progress bar -->
						<!-- <div class="progress progress-xs bg-primary bg-opacity-10 mb-2">
							<div class="progress-bar bg-primary" role="progressbar" style="width: 100%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
							</div>
						</div>
						<span><span class="text-primary">10 new flights booked</span> today</span> -->
					</div>	
				</div>

				<!-- Counter item -->
				<div class="col-md-6 col-xxl-3">
					<div class="card card-body shadow p-4">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<!-- Number -->
							<div class="me-2">
								<span>Cancelled Bookings</span>
								<h3 class="mb-0 mt-2"><%= cancelledBookings %></h3>
							</div>
							<!-- Icon -->
							<div class="icon-lg rounded-circle flex-shrink-0 bg-danger bg-opacity-10 text-danger mb-0">
								<i class="bi bi-x-circle fa-fw"></i>
							</div>
						</div>
						<!-- Progress bar -->
						<!-- <div class="progress progress-xs bg-danger bg-opacity-10 mb-2">
							<div class="progress-bar bg-danger" role="progressbar" style="width: 100%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
							</div>
						</div>
						<span><span class="text-danger">1 canceled flights</span> today</span> -->
					</div>	
				</div>

				<!-- Counter item -->latest
				<div class="col-md-6 col-xxl-3">
					<div class="card card-body shadow p-4">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<!-- Number -->
							<div class="me-2">
								<span>Upcoming Bookings</span>
								<h3 class="mb-0 mt-2"><%= upcomingBookings %></h3>
							</div>
							<!-- Icon -->
							<div class="icon-lg rounded-circle flex-shrink-0 bg-success bg-opacity-10 text-success mb-0">
								<i class="bi bi-box-arrow-in-right fa-fw"></i>
							</div>
						</div>
						<!-- Progress bar -->
						<!-- <div class="progress progress-xs bg-success bg-opacity-10 mb-2">
							<div class="progress-bar bg-success" role="progressbar" style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
							</div>
						</div>
						<span><span class="text-success">1 canceled flights</span> today</span> -->
					</div>	
				</div>

				<!-- Counter item -->
				<div class="col-md-6 col-xxl-3">
					<div class="card card-body shadow p-4">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<!-- Number -->
							<div class="me-2">
								<span>Completed Bookings</span>
								<h3 class="mb-0 mt-2"><%= completedBookings %></h3>
							</div>
							<!-- Icon -->
							<div class="icon-lg rounded-circle flex-shrink-0 bg-orange bg-opacity-10 text-orange mb-0">
								<i class="bi bi-box-arrow-right fa-fw"></i>
							</div>
						</div>
						<!-- Progress bar -->
						<!-- <div class="progress progress-xs bg-orange bg-opacity-10 mb-2">
							<div class="progress-bar bg-orange" role="progressbar" style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
							</div>
						</div>
						<span><span class="text-orange">30 reservation</span> outgoing</span> -->
					</div>	
				</div>
			</div>
			<!-- Counter END -->

			<!-- Tabs and search START -->
			<div class="row align-items-center">
				<div class="col-lg-12 col-xxl-12">
					<div class="d-sm-flex gap-4 justify-content-center">
						<!-- Search -->
						<div class="col-xxl-5 mb-3">
							<form class="rounded position-relative" method="get" action="/admin/bookings">
								<input class="form-control bg-transparent pe-5" type="search" name="search"
									placeholder="Search" aria-label="Search" value="<%= search %>">
								<button
									class="bg-transparent p-2 position-absolute top-50 end-0 translate-middle-y border-0 text-primary-hover "
									type="submit">
									<i class="fas fa-search fs-6"></i>
								</button>
							</form>						  
						</div>
					</div>
				</div>
			</div>
			<!-- Tabs and search END -->

	
					<div class="card shadow">
						<!-- Card body START -->
						<div class="card-body">
							<!-- Table head -->
							<div class="bg-light rounded p-3 d-none d-xxl-block">
								<div class="row row-cols-6 g-4">
									<div class="col"><h6 class="mb-0">Booking Id</h6></div>
									<div class="col"><h6 class="mb-0">Flight</h6></div>
									<div class="col"><h6 class="mb-0">User Id</h6></div>
									<div class="col"><h6 class="mb-0">Number of Travelers</h6></div>
									<div class="col"><h6 class="mb-0">Amount</h6></div>
									<div class="col"><h6 class="mb-0">Action</h6></div>
								</div>
							</div>
		
							<!-- Table data -->
							<% bookings.forEach((booking) => { %>
								<% if(bookings.length > 0 ) { %>
							<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 row-cols-xxl-6 g-2 g-sm-4 align-items-md-center border-bottom px-2 py-4">
								<!-- Data item -->
								<%
								function formatDate(date) {
								  const d = new Date(date);
								  const day = String(d.getDate()).padStart(2, '0');
								  const month = String(d.getMonth() + 1).padStart(2, '0');
								  const year = String(d.getFullYear()).slice(-2);
								  return `${day}/${month}/${year}`;
								}
							  %>
								<div class="col">
									<small class="d-block d-xxl-none">Booking Id:</small>
									<h6 class="mb-0"><%= booking.bookingId %></h6>
								  </div>
							
								  <!-- Flight Info -->
								  <div class="col">
									<small class="d-block d-xxl-none">Flight:</small>
									<h6 class="mb-0"><%= booking.flightData?.from %> - <%= booking.flightData?.to %></h6>
									<small class="mb-0">  <%= formatDate(booking.flightData?.departureDate) %> - <%= formatDate(booking.flightData?.arrivalDate) %>
									</small>
									<h6 class="mb-0"><%= booking.flightData?.stops[0].airlineCode %> - <%= booking.flightData?.stops[0].flightNumber %></h6>
								  </div>
							
								  <!-- User Name -->
								  <div class="col">
									<small class="d-block d-xxl-none">User Id:</small>
									<h6 class="mb-0"><%= booking.userData.userId %></h6>
								  </div>
							
								  <!-- Number of Travelers -->
								  <div class="col">
									<small class="d-block d-xxl-none">Travelers:</small>
									<h6 class="mb-0"><%= booking.travelers.length %></h6>
								  </div>
							
								  <!-- Amount -->
								  <div class="col">
									<small class="d-block d-xxl-none">Amount:</small>
									<h6 class="text-success mb-0">â‚¹<%= booking.amount.toFixed(2) %></h6>
								  </div>
							
								  <!-- Action -->
								  <div class="col">
									<a href="/admin/booking-detail/<%= booking._id %>" class="btn btn-sm btn-light mb-0">View</a>
								  
									<button
									  class="btn btn-sm btn-light mb-0 open-cancel-modal"
									  data-bs-toggle="modal"
									  data-bs-target="#cancelBookingModal"
									  data-id="<%= booking._id %>"
									  data-booking-code="<%= booking.bookingId %>">
									  Cancel
									</button>
								  </div>
								  
							</div>
							<% } else { %>
								<div class="col">
									<h6 class="mb-0 fw-normal">No bookings</h6>
								</div>
							<% } %>
							<% }); %>
						</div>
						<!-- Card body END -->
		
						<!-- Card footer START -->
						<div class="card-footer pt-0">
							<!-- Pagination and content -->
							<div class="d-sm-flex justify-content-sm-between align-items-sm-center">
								<p class="mb-sm-0 text-center text-sm-start">
								  Showing <%= (currentPage - 1) * limit + 1 %> to
								  <%= Math.min(currentPage * limit, totalCount) %> of
								  <%= totalCount %> entries
								</p>
								<nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
								  <ul class="pagination pagination-sm pagination-primary-soft mb-0">
									<li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
									  <a class="page-link" href="?search=<%= search %>&page=<%= currentPage - 1 %>">Prev</a>
									</li>
							  
									<% for (let i = 1; i <= totalPages; i++) { %>
									  <li class="page-item <%= i === currentPage ? 'active' : '' %>">
										<a class="page-link" href="?search=<%= search %>&page=<%= i %>"><%= i %></a>
									  </li>
									<% } %>
							  
									<li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
									  <a class="page-link" href="?search=<%= search %>&page=<%= currentPage + 1 %>">Next</a>
									</li>
								  </ul>
								</nav>
							</div>								  
						</div>
						<!-- Card footer END -->
					</div>

		</div>
		<!-- Page main content END -->
	</div>
	<!-- Page content END -->
	
	<!-- Modal -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1" aria-labelledby="cancelBookingModalLabel" aria-hidden="true">
	<div class="modal-dialog">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="modal-title" id="cancelBookingModalLabel">Cancel Booking</h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
  
		<div class="modal-body">
		  <input type="hidden" id="cancelBookingId">
		  <div class="mb-3">
			<label class="form-label">Reason for cancellation</label>
			<input type="text" class="form-control" id="cancelReason" placeholder="Enter reason" required>
		  </div>
		</div>
  
		<div class="modal-footer">
		  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		  <button type="button" class="btn btn-danger" id="submitCancel">Submit</button>
		</div>
	  </div>
	</div>
  </div>

  <script>
	document.addEventListener("DOMContentLoaded", () => {
	  const cancelBookingIdInput = document.getElementById("cancelBookingId");
	  const cancelReasonInput = document.getElementById("cancelReason");
  
	  // Populate modal when "Cancel" is clicked
	  document.querySelectorAll(".open-cancel-modal").forEach(button => {
		button.addEventListener("click", () => {
		  const bookingId = button.getAttribute("data-id");
		  const bookingCode = button.getAttribute("data-booking-code");
  
		  cancelBookingIdInput.value = bookingId;
		  document.getElementById("cancelBookingModalLabel").textContent =
			`Cancel Booking (${bookingCode})`;
		  cancelReasonInput.value = ""; // Clear input
		});
	  });
  
	  // Handle submission
	  document.getElementById("submitCancel").addEventListener("click", async () => {
		const bookingId = cancelBookingIdInput.value;
		const reason = cancelReasonInput.value.trim();
  
		if (!reason) {
        Swal.fire({
          icon: 'warning',
          title: 'Missing Reason',
          text: 'Please enter a reason for cancellation.',
          confirmButtonText: 'OK'
        });
        return;
      }
  
		try {
		  const res = await fetch("/admin/cancel-booking", {
			method: "POST",
			headers: {
			  "Content-Type": "application/json"
			},
			body: JSON.stringify({ bookingId, reason })
		  });
  
		   if (res.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Booking Cancelled',
            text: 'Booking was successfully cancelled.',
            confirmButtonText: 'OK'
          }).then(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById("cancelBookingModal"));
            modal.hide();
            location.reload(); // Optional: refresh page
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Failed',
            text: 'Failed to cancel booking.',
            confirmButtonText: 'OK'
          });
        }
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'An error occurred while cancelling the booking.',
          confirmButtonText: 'OK'
        });
      }
	  });
	});
  </script>
  
	</main>
<!-- **************** MAIN CONTENT END **************** -->

<%- include('./partials/footer') %>