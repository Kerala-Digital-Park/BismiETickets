<%- include('./partials/header') %>

<!-- **************** MAIN CONTENT START **************** -->

<main>

	<!-- Sidebar START -->
	<%- include('./partials/sideBar') %>
	<!-- Sidebar END -->
	
	<!-- Page content START -->
	<div class="page-content">
	
		<!-- Top bar START -->
		<%- include('./partials/topBar') %>
		<!-- Top bar END -->

        <!-- Page main content START -->
        <div class="page-content-wrapper p-xxl-4">

                <!-- Title -->
                <div class="row">
                    <div class="col-12 mb-4 mb-sm-5">
                        <div class="d-sm-flex justify-content-between align-items-center">
                            <div class="card-body text-dark">
                                <!-- Title -->
                                <h1 class="m-0 h3 card-title"><%= flight.fromCity %> ➝ <%= flight.toCity %> on <%= new Date(flight.departureDate).toLocaleDateString('en-GB', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric'}) %></h1>
                                <!-- Breadcrumb -->
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb breadcrumb-dots mb-0">
                                        <li class="breadcrumb-item">User ID: <%= seller.userId %></li>
                                        <% 
  const createdAt = new Date(flight.createdAt);
  const formattedDate = createdAt.toLocaleDateString('en-GB', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
    weekday: 'short'
  });

  const formattedTime = createdAt.toLocaleTimeString('en-US', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  }).toLowerCase(); // to get "am"/"pm" in lowercase

  const parts = formattedDate.split(', ');
  const date = parts[0]; // e.g., "Fri"
  const rest = parts[1]; // e.g., "30 May 2025"
%>
                                        <li class="breadcrumb-item">Booked At: <%= `${rest}, ${date} ${formattedTime}` %></li>
                                        <%
                                            const status = flight.isActive ? 'Confirmed' : 'Cancelled';
                                            let statusClass = '';
                                            if (status === 'Confirmed') {
                                                statusClass = 'text-success';
                                            } else if (status === 'Cancelled') {
                                                statusClass = 'text-danger';
                                            } else {
                                                statusClass = 'text-warning';
                                            }
                                        %>
                                        <li class="breadcrumb-item active <%=statusClass%>"><%=status%></li>
                                    </ol>
                                </nav>

                            </div>
<a href="https://www.google.com/search?q=<%= flight.stops[0].airlineCode %> airline" 
   target="_blank" 
   class="btn btn-info-soft text-nowrap mb-0 me-2" 
   title="Search Airline">
    <i class="bi bi-airplane-fill"></i>
</a>

                            <a href="#" class="btn btn-primary-soft text-nowrap mb-0 me-2" title="Remainder"><i
                                    class="bi bi-bell"></i></a>
                            <!-- <a href="/admin/block-inventory/<%=flight._id%>" class="btn btn-danger-soft text-nowrap mb-0 me-2"
                                title="Admin block Sales"><i class="bi bi-ban"></i>Ban</a>
                            <a href="/admin/unblock-inventory/<%=flight._id%>" class="btn btn-success-soft text-nowrap mb-0 me-2"
                                title="Admin unblock Sales"><i class="bi bi-check2-circle"></i> Show</a> -->
<button class="btn <%= flight.banned ? 'btn-success-soft' : 'btn-danger-soft' %> text-nowrap mb-0 me-2 toggle-inventory-btn"
        data-id="<%= flight._id %>" 
        data-banned="<%= flight.banned %>"
        title="Admin <%= flight.banned ? 'unblock' : 'block' %> Sales">
    <i class="bi <%= flight.banned ? 'bi-check2-circle' : 'bi-ban' %>"></i> <%= flight.banned ? 'Show' : 'Ban' %>
</button>

                        </div>
                    </div>
                </div>

                <!-- Booking detail START -->
                <div class="row g-3 g-xl-4">
                    <!-- Image -->
                    <!-- Content -->
                    <div class="col-xxl-9">
                        <!-- Flight information START -->
                        <div class="card border">

                            <!-- Card body START -->
                            <div class="card-body p-2">
                                <!-- Card list START -->
                                <!-- Card header -->
                                <!-- Card header -->
                                <div class="card-header">
                                    <div class="d-sm-flex justify-content-sm-between align-items-center">
                                        <!-- Airline Name -->
                                        <div class="d-flex mb-2 mb-sm-0">
                                            <img src="<%= flight.stops[0].airlineLogo %>" class="w-40px me-2"
                                                alt="">
                                            <h6 class="fw-normal mb-0"><%= flight.stops[0].airline %> (<%= flight.stops[0].airlineCode %> - <%= flight.stops[0].flightNumber %>)
                                            </h6>
                                        </div>
                                        <h6 class="fw-normal mb-0"><span class="text-body">Booking
                                                PNR:</span> <%= flight.inventoryDates[0].pnr %></h6>
                                    </div>
                                </div>

                                <!-- Card body START -->
                                <div class="card-body p-4">
                                    <!-- Ticket item START -->
                                    <div class="row g-4">
                                        <!-- Airport detail -->
                                        <div class="col-sm-4">
                                            <!-- Title -->
                                            <h4><%= flight.from %></h4>
                                            <h6 class="mb-0"><%= flight.departureTime %></h6>
                                            <p class="mb-0"><%= flight.departureName %>, <%= flight.fromCity %>, <%= flight.fromCountry %></p>
                                        </div>

                                        <!-- Time -->
                                        <div class="col-sm-4 my-sm-auto text-center">
                                            <!-- Time -->
                                            <h5><%= flight.duration %></h5>

                                            <div class="position-relative my-4">
                                                <!-- Line -->
                                                <hr class="bg-primary opacity-5 position-relative">
                                                <!-- Icon -->
                                                <div
                                                    class="icon-md bg-primary text-white rounded-circle position-absolute top-50 start-50 translate-middle">
                                                    <i class="fa-solid fa-fw fa-plane rtl-flip"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Airport detail -->
                                        <div class="col-sm-4">
                                            <!-- Title -->
                                            <h4><%= flight.to %></h4>
                                            <h6 class="mb-0"><%= flight.arrivalTime %></h6>
                                            <p class="mb-0"><%= flight.arrivalName %>, <%= flight.toCity %>, <%= flight.toCountry %></p>
                                        </div>
                                    </div>
                                    <!-- Ticket item END -->

                                </div>
                                <!-- Card body END -->
                                <!-- Card footer -->
                                <div class="card-footer pt-4">
                                    <ul class="list-inline bg-light rounded-2 d-sm-flex text-center justify-content-sm-between mb-0 px-4 py-2">
                                        <%
                                            refundableClass = flight.refundable ? 'text-success' : 'text-danger';
                                            refundableText = flight.refundable ? 'Refundable' : 'Non-Refundable';
                                        %>
                                        <li class="list-inline-item <%= refundableClass %>"><%= refundableText %></li>
                                        <li class="list-inline-item text-dark">Checked baggage : <%= flight.baggage.adult.checkIn.weightPerPiece %> kg
                                        </li>
                                        <li class="list-inline-item text-dark">Carry-on baggage : <%= flight.baggage.adult.cabin.weightPerPiece %> Kg
                                        </li>

                                    </ul>
                                </div>

                                <!-- Card body -->
                            </div>
                            <!-- Card body END -->
                        </div>
                        <!-- Flight information END -->
                    </div>
                    <div class="col-xxl-3">
                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-2 me-3">
                            <label class="form-check-label ps-0 pe-4" for="inventoryno">Inventory Number</label>
                            <%= flight.inventoryId %>
                        </div>

                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="inventoryuser">Inventory User</label>
                            <%= seller.name %>
                        </div>
                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="saleStatus">Sales Status</label>
                            <input class="form-check-input flex-shrink-0" type="checkbox" id="saleStatus" data-id="<%= flight._id %>" <%= flight.saleStatus ? "checked" : "" %>>
                        </div>
                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="halfDaySale" >Enable 12 hrs before
                                departure</label>
                            <input class="form-check-input flex-shrink-0" type="checkbox" id="halfDaySale" data-id="<%= flight._id %>" <%= flight.halfDaySale ? "checked" : "" %>>
                        </div>
                        <!-- Booking info -->
                        <div
                            class="bg-light border border-secondary border-opacity-25 p-3 rounded d-inline-block">
                            <h6 class="small">Real Time Seats Information:</h6>
                            <!-- Avatar -->
                            <!-- Info -->
                            <div class="hstack gap-2 gap-md-5 flex-wrap mt-2 ">
                                <div>
                                    <small>Total Seats</small>
                                    <h6 class="fw-normal mb-0"><%=flight.inventoryDates[0].seats%> Seats</h6>
                                </div>
                                <div>
                                    <small>Sold Seats</small>
                                    <h6 class="fw-normal mb-0"><%=flight.inventoryDates[0].seatsBooked%> Seats</h6>
                                </div>
                                <div>
                                    <small>Hold Seats</small>
                                    <h6 class="fw-normal mb-0"><%= flight.inventoryDates[0].seatsHold.reduce((sum, hold) => sum + hold.seats, 0) %> Seats</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Booking detail END -->

 
                    <ul class="nav nav-tabs nav-justified mb-3">
                        <li class="nav-item "> <a class="nav-link text-primary mb-0 active" data-bs-toggle="tab" href="#tab-1"><i
                                    class="bi bi-bookmark-heart fa-fw me-1"></i> Booking
                                Details</a> </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab" href="#tab-2"><i
                                    class="bi bi-receipt"></i>
                                Transactions</a> </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab" href="#tab-5"><i
                                    class="bi bi-paypal"></i>
                                Payments</a> </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab" href="#tab-4"><i
                                    class="bi bi-card-checklist"></i> Booking Activities</a>
                        </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab" href="#tab-3"><i
                                    class="bi bi-patch-question"></i> Help Desk</a> </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-primary" href="#" id="dropdoanMenu"
                                title="Please inactive Inventory For Edit options" data-bs-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">
                                <i class="bi bi-list-ul fa-fw me-1"></i>Booking Actions
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="dropdoanMenu">
                                <!-- Dropdown menu -->
                                <li> <a class="dropdown-item" href="#"><i class="bi bi-card-checklist"></i>
                                        Edit Inventory Details</a>
                                </li>
                                <li> <a class="dropdown-item" href="#"><i class="bi bi-airplane"></i>
                                        Edit Flight Details</a></li>
                                <li> <a class="dropdown-item" href="#"><i class="bi bi-luggage-fill"></i> Edit
                                        Baggage Details</a></li>
                                <li> <a class="dropdown-item" href="#"><i class="bi bi-cart-check-fill"></i>
                                        Utility Service Details</a>
                                </li>
                            </ul>
                        </li>

                    </ul>
                    <div class="tab-content">
                        <!-- Tab content 1 START -->
                        <div class="tab-pane show active" id="tab-1">
                            <div class="row g-3 ">
                                <div class="col-12"> <!-- Booking table START -->
                                    <div class="card border">
                                        <!-- Card header START -->
                                        <div class="card-header border-bottom d-md-flex justify-content-md-between">
                                            <h5 class="card-header-title"><i class="bi bi-passport"></i> Passengers
                                            </h5>
                                            <form class="rounded position-relative">
                                                <input class="form-control pe-5" type="search" placeholder="Search"
                                                    aria-label="Search">
                                                <button
                                                    class="btn border-0 px-3 py-0 position-absolute top-50 end-0 translate-middle-y"
                                                    type="submit"><i class="fas fa-search fs-6"></i></button>
                                            </form>
                                        </div>
                                        <!-- Card header END -->
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <!-- Table head -->
                                            <div class="table-responsive">
                                                <table class="datatable-init-export nowrap table"
                                                    data-export-title="Export">
                                                    <thead>

                                                        <tr>
                                                            <th>No</th>
                                                            <th>Booking ID </th>
                                                            <th>Title</th>
                                                            <th>First Name</th>
                                                            <th>Last Name</th>
                                                            <th>Email </th>
                                                            <th>Mobile </th>
                                                            <th>Actions</th>

                                                        </tr>

                                                    </thead>

                                                    <tbody>
                                                        <% if(bookings.length > 0) { %>
                                                            <% bookings.forEach((booking, index) => { %>
                                                        <tr>
                                                            <td><%= index+1 %></td>
                                                            <td><%= booking.bookingId %></td>
                                                            <td><%= booking.travelers[0].title %></td>
                                                            <td><%= booking.travelers[0].first_name %></td>
                                                            <td><%= booking.travelers[0].last_name %></td>
                                                            <td><%= booking.email %></td>
                                                            <td><%= booking.mobile_number %></td>


                                                            <td>
                                                                <a href="/admin/booking-detail/<%= booking._id %>" class="btn btn-sm btn-outline-info mb-0 me-2"
                                                                    title="Booking Details"><i
                                                                        class="bi bi-eye-fill"></i></a>
                                                                <!-- <button class="btn btn-sm btn-outline-dark mb-0 me-2"
                                                                    title="Ticket Details"><i
                                                                        class="bi bi-ticket-perforated-fill"></i></button>
                                                                <button
                                                                    class="btn btn-sm btn-outline-primary mb-0 me-2"
                                                                    title="Payment Details"><i
                                                                        class="bi bi-credit-card"></i></button>
                                                                <button class="btn btn-sm btn-outline-danger mb-0 me-2"
                                                                    title="Help & Support"><i
                                                                        class="bi bi-life-preserver"></i></button> -->

                                                            </td>
                                                        
                                                        </tr>
                                                        <% }) %>
                                                        <% } else { %>
                                                            <tr>
                                                                <td colspan="8" class="text-center">No bookings found.</td>
                                                            </tr>
                                                        <% } %>
                                                    </tbody>
                                                </table>
                                            </div>

                                        </div>
                                        <!-- Card body END -->

                                        <!-- Card footer START -->
                                        <div class="card-footer pt-1">
  <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
    <p class="mb-sm-0 text-center text-sm-start">
      Showing <%= (bookingPagination.page - 1) * bookingPagination.limit + 1 %>
      to <%= Math.min(bookingPagination.page * bookingPagination.limit, bookingPagination.total) %>
      of <%= bookingPagination.total %> entries
    </p>
    <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
      <ul class="pagination pagination-sm pagination-primary-soft mb-0">
        <% for(let i=1; i<=Math.ceil(bookingPagination.total / bookingPagination.limit); i++) { %>
          <li class="page-item <%= bookingPagination.page === i ? 'active' : '' %>">
            <a class="page-link" href="?id=<%= flight._id %>&page=<%= i %>#tab-2"><%= i %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>
                                        <!-- Card footer END -->
                                    </div>
                                </div>
                            </div> <!-- Booking table END -->
                        </div>
                        <!-- Tab content 2 START -->
                        <div class="tab-pane show  " id="tab-2">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header -->
                                        <div class="card-header border-bottom">
                                            <h5 class="card-header-title">Booking Transactions</h5>
                                        </div>
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <div class="table-responsive">

                                            <table class="table">

                                                <thead>
                                                    
                                                    <tr>

                                                        <th>Booking Id</th>
                                                        <th>Booking date</th>
                                                        <th>Particulars</th>
                                                        <th>Booking Amount</th>
                                                        <th>C.Fee</th>
                                                        <th>Paid Amount</th>
                                                        <th>Pay Status</th>
                                                        <th>Actions</th>

                                                    </tr>

                                                </thead>

                                                <tbody>
                                                    <%
                                                    if(!transactions || transactions.length === 0) { %>
                                                        <tr>
                                                            <td colspan="8" class="text-center">No transactions found.</td>
                                                        </tr>
                                                    <% } else { %>
                                                        <% transactions.forEach((transaction) => { %>
                                                            <% const flight = transaction.bookingId.flight %>
                                                    <tr>

                                                        <td scope="1"> <%= transaction.bookingId.bookingId %> </td>
                                                        <td><%= new Date(transaction.bookingId.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-') %></td>
                                                        <!-- <%
                                                            let stopType;
                                                            const stops = flight.stops.length;
                                                            if(stops === 1){
                                                                stopType = 'Non Stop';
                                                            }
                                                            else if(stops === 2) {
                                                                stopType = 1 + ' Stop';
                                                            } 
                                                            else {
                                                                stopType = stops + ' Stops';
                                                            }
                                                        %> -->
                                                        <td>
                                                            (<%= flight.inventoryDates[0].pnr %>): <%= flight.departureDate.toUpperCase() %> <%= flight.from %> <%= flight.to %> <%= flight.stops[0].airlineCode %>-<%= flight.stops[0].flightNumber %>
                                                        </td>
                                                        <td>₹ <%= transaction.totalAmount %></td>
                                                        <td>₹ <%= transaction.discount %></td>
                                                        <td>₹ <%= transaction.totalAmount %></td>
                                                        <td><%= transaction.paymentStatus %> </td>
                                                        <td><a href="/admin/booking-detail/<%= transaction.bookingId._id %>" class="btn btn-sm btn-outline-warning mb-0 me-2"
                                                                title="Booking Details"><i
                                                                    class="bi bi-eye-fill"></i></a>
                                                            <a href="/admin/withdrawal/<%=flight._id%>/<%=seller._id%>" class="btn btn-sm btn-outline-info mb-0 me-2"
                                                                title="Supplier Transfer"><i
                                                                    class="bi bi-paypal"></i></a>
                                                        </td>

                                                    </tr>
                                                        <% }) %>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                            </div>
                                        </div>
                                        <!-- Card body END -->

                                        <!-- Card footer START -->
                                        <div class="card-footer pt-1">
  <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
    <p class="mb-sm-0 text-center text-sm-start">
      Showing <%= (transactionPagination.page - 1) * transactionPagination.limit + 1 %>
      to <%= Math.min(transactionPagination.page * transactionPagination.limit, transactionPagination.total) %>
      of <%= transactionPagination.total %> entries
    </p>
    <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
      <ul class="pagination pagination-sm pagination-primary-soft mb-0">
        <% for(let i=1; i<=Math.ceil(transactionPagination.total / transactionPagination.limit); i++) { %>
          <li class="page-item <%= transactionPagination.page === i ? 'active' : '' %>">
            <a class="page-link" href="?id=<%= flight._id %>&page=<%= i %>#tab-2"><%= i %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>
                                        <!-- Card footer END -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tab content 2 START -->
                        <div class="tab-pane show  " id="tab-5">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header -->
                                        <div class="card-header border-bottom">
                                            <h5 class="card-header-title">Booking Payments</h5>
                                        </div>
                                        <!-- Card body START -->
                                        <div class="card-body">
                                        <div class="table-responsive">

                                            <table class="table">
                                                <thead>
                                                    <tr>

                                                        <!-- <th>ID</th> -->
                                                        <th>Booking ID</th>
                                                        <th>Type</th>
                                                        <th>Booking date</th>
                                                        <th>Amount</th>
                                                        <th>Transactions ID</th>
                                                        <th>Gateway</th>
                                                        <th>Method</th>
                                                        <th>Charges</th>
                                                        <th>Pay Status</th>
                                                        <th>Actions</th>

                                                    </tr>
                                                </thead>

                                                <tbody>
                                                    <% if(transactions.length > 0) { %>
                                                        <% transactions.forEach((transaction) => { %>
                                                    <tr>
                                                        <!-- <td scope="1"> GPT3272 </td> -->
                                                        <td><%= transaction.bookingId.bookingId %></td>
                                                        <td><%= transaction.type %></td>
                                                        <td>
                                                          <%= new Date(transaction.createdAt).toLocaleDateString('en-GB', {
                                                            day: '2-digit',
                                                            month: 'short',
                                                            year: 'numeric'
                                                          }).replace(/ /g, '-') %>
                                                        </td>
                                                        <td>₹ <%= transaction.totalAmount %></td>
                                                        <td><%= transaction.transactionId %> </td>
                                                        <td>HDFC BANK</td>
                                                        <td>UPI</td>
                                                        <%
                                                            const totalAmount = transaction.totalAmount;
                                                            const taxAmount = transaction.tax;
                                                            const discountAmount = transaction.discount;
                                                            const taxPercentage = Math.floor(((taxAmount / totalAmount) * 100).toFixed(2));

                                                        %>
                                                        <td><%= taxPercentage %>% (₹<%= taxAmount %>)</td>
                                                        <td><%= transaction.paymentStatus %></td>
                                                        <td>
                                                            <a href="/admin/booking-detail/<%= transaction.bookingId._id %>" class="btn btn-sm btn-outline-warning mb-0 me-2"
                                                                title="Booking Details"><i
                                                                    class="bi bi-eye-fill"></i></a>

                                                        </td>

                                                    </tr>
                                                    <!-- <tr>

                                                        <td scope="1"> GPT3272 </td>
                                                        <td>BFL00152 </td>
                                                        <td>Addon Service </td>
                                                        <td>18-Jun-2025 </td>
                                                        <td>₹ 10218</td>
                                                        <td> 161651051dfc66 </td>
                                                        <td>HDFC BANK</td>
                                                        <td>UPI</td>
                                                        <td>0% (0)</td>
                                                        <td>Under Process </td>
                                                        <td><button class="btn btn-sm btn-outline-warning mb-0 me-2"
                                                                title="Booking Details"><i
                                                                    class="bi bi-eye-fill"></i></button>

                                                        </td>

                                                    </tr> -->
                                                        <% }) %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="10" class="text-center">No payments found.</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                            
                                        </div>
                                        </div>
                                        <!-- Card body END -->

                                        <!-- Card footer START -->
                                        <div class="card-footer pt-1">
  <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
    <p class="mb-sm-0 text-center text-sm-start">
      Showing <%= (bookingPagination.page - 1) * bookingPagination.limit + 1 %>
      to <%= Math.min(bookingPagination.page * bookingPagination.limit, bookingPagination.total) %>
      of <%= bookingPagination.total %> entries
    </p>
    <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
      <ul class="pagination pagination-sm pagination-primary-soft mb-0">
        <% for(let i=1; i<=Math.ceil(bookingPagination.total / bookingPagination.limit); i++) { %>
          <li class="page-item <%= bookingPagination.page === i ? 'active' : '' %>">
            <a class="page-link" href="?id=<%= flight._id %>&page=<%= i %>#tab-2"><%= i %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>
                                        <!-- Card footer END -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tab content 3 START -->
                        <div class="tab-pane show " id="tab-3">
  <div class="row">
    <div class="col-12 mx-auto">
      <div class="accordion accordion-icon accordion-bg-light" id="accordionExample2">

        <% if (requests && requests.length > 0) { %>
          <% requests.forEach((req, index) => { %>
            <div class="accordion-item mb-3">
              <h6 class="accordion-header font-base" id="heading-<%= index %>">
                <button class="accordion-button fw-bold rounded d-inline-block collapsed"
                  type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= index %>"
                  aria-expanded="false" aria-controls="collapse-<%= index %>">
                  Support Request Number : <%= req.requestId %>
                </button>
              </h6>
              <div id="collapse-<%= index %>" class="accordion-collapse collapse"
                aria-labelledby="heading-<%= index %>" data-bs-parent="#accordionExample2">
                <div class="accordion-body mt-3">
                  <div class="card shadow">
                    <div class="card-header border-bottom p-4">
                      <h6 class="mb-0"><%= req.subject %></h6>
                      <ul class="nav nav-divider">
                        <li class="nav-item">Last updated: <%= req.updatedAt.toLocaleDateString("en-GB") %></li>
                      </ul>
                    </div>
                    <div class="card-body p-4">
                      <div class="alert alert-warning text-right" role="alert">
                        <%= req.passengerName %> - <%= req.request %>
                      </div>
                    </div>
                    <div class="card-footer border-0 p-4 pt-0">
                      <div class="border p-3 rounded d-lg-flex align-items-center justify-content-between text-center">
                        <small class="py-3 py-lg-0 d-block">
                          We believe the problem has been resolved. Give us the rates for your satisfaction.
                        </small>
                        <div class="btn-group" role="group" aria-label="Feedback">
                          <input type="radio" class="btn-check" name="feedback-<%= index %>" id="btnradio1-<%= index %>">
                          <label class="btn btn-outline-light btn-sm mb-0" for="btnradio1-<%= index %>">
                            <i class="fa-solid fa-thumbs-up me-1"></i> Yes
                          </label>

                          <input type="radio" class="btn-check" name="feedback-<%= index %>" id="btnradio2-<%= index %>">
                          <label class="btn btn-outline-light btn-sm mb-0" for="btnradio2-<%= index %>">
                            No <i class="fa-solid fa-thumbs-down ms-1"></i>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="border p-3 rounded d-lg-flex align-items-center justify-content-between text-center">
            <small class="py-3 py-lg-0 d-block">No Request Found</small>
          </div>
        <% } %>

      </div>
    </div>
  </div>
</div>
                        <!-- Tab content 4 START -->
                        <div class="tab-pane show  " id="tab-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header -->
                                        <div class="card-header border-bottom">
                                            <h5 class="card-header-title">All Activities</h5>
                                        </div>
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <div class="table-responsive">
                                            <table class="table table-ulogs">

                                                <thead class="thead-light">

                                                    <tr>

                                                        <th>Date</th>

                                                        <th>ID</th>

                                                        <th>Content</th>

                                                        <th>User</th>

                                                    </tr>

                                                </thead>

                                                <tbody>
                                                    <%
                                                    if(userActivities.length === 0) { %>
                                                        <tr>
                                                            <td colspan="4" class="text-center">No activities found.</td>
                                                        </tr>
                                                    <% } else { %>
                                                        <% userActivities.forEach((activity) => { %>
                                                            <tr>
                                                        <td><%= moment(activity.createdAt).format("DD-MMM-YYYY HH:mm") %></td>

                                                        <td><%= activity.booking.bookingId %></td>

                                                        <td><%= activity.content %></td>


                                                        <td><%= seller.name.toUpperCase() %></td>

                                                    </tr>
                                                    <!-- <tr>
                                                        <td>18-Jun-2025 11:22 </td>
                                                        <td>BFL00152 </td>

                                                        <td>Your Group has been confirmed from the issuer id Air
                                                            India Paid Cost 22000 Amount </td>

                                                        <td>BISMI ETICKETS </td>

                                                    </tr> -->
                                                        <% }) %>
                                                    <% } %>
                                                    %>
                                                    
                                                </tbody>
                                            </table>
                                            </div>
                                        </div>
                                        <!-- Card body END -->

                                        <!-- Card footer START -->
                                        <div class="card-footer pt-1">
  <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
    <p class="mb-sm-0 text-center text-sm-start">
      Showing <%= (activityPagination.page - 1) * activityPagination.limit + 1 %>
      to <%= Math.min
    <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
(activityPagination.page * activityPagination.limit, activityPagination.total) %>
      of <%= activityPagination.total %> entries
    </p>      <ul class="pagination pagination-sm pagination-primary-soft mb-0">
        <% for(let i=1; i<=Math.ceil(activityPagination.total / activityPagination.limit); i++) { %>
          <li class="page-item <%= activityPagination.page === i ? 'active' : '' %>">
            <a class="page-link" href="?id=<%= flight._id %>&page=<%= i %>#tab-2"><%= i %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>
                                        <!-- Card footer END -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <!-- Page main content END -->
    </div>
    <!-- Page content END -->

        <!-- Wheelchair modal START -->
    <div class="modal fade" id="Wheelchair" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Title -->
                <div class="modal-header">
                    <h5 class="modal-title">Submit to Block for Sales</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Body -->
                <div class="modal-body p-3">
                    <div class="row g-4 mb-3">
                        <div class="col-sm-12 form-group"><label class="form-label" for="country">Reason For The
                                Block</label>
                            <textarea></textarea>
                        </div>



                    </div>
                    <div class="modal-footer bg-light mb-2"> <button
                            class="btn btn-sm btn-outline-primary mb-0">Submit
                            request</button> </div>
                    <h6 class="alert-heading h6">Instructions for Wheelchair Assistance</h6>
                    <ul>
                        <li>By processing, You accept Booking <a href="#">Terms of Services</a> and <a
                                href="#">Policy</a></li>
                        <li>Steps: Submit Request -> Our team will forward the request to the sales teams and once it is
                            accepted we will add the service cost. You have to pay the amount within the time. Once it
                            is completed the seller will be updated.</li>
                        <li>You should book it at least 48 hours before your flight's departure. provides wheelchair
                            assistance based on availability, so it's best to book in advance. </li>
                        <li>Some airlines not charge extra for providing wheelchair assistance. but the last moment case
                            they will charge.</li>
                        <li>Once request we will generate a support Id. it shows on manage supports tab </li>

                    </ul>
                </div>

            </div>
        </div>
    </div>
    <!-- Wheelchair modal END -->
     
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggleButtons = document.querySelectorAll('.toggle-inventory-btn');
  
  toggleButtons.forEach(button => {
    button.addEventListener('click', async () => {
      const id = button.getAttribute('data-id');
      const isBanned = button.getAttribute('data-banned') === 'true';
      const action = isBanned ? 'unblock' : 'block';

      // Show confirmation dialog using SweetAlert2
      Swal.fire({
        title: 'Are you sure?',
        text: `Do you want to ${action} this inventory?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: `Yes, ${action} it!`,
        cancelButtonText: 'No, cancel'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch(`/admin/toggle-inventory/${id}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
                // Remove CSRF token line if not configured, or add it if configured (see previous response)
              }
            });

            const data = await response.json();
            if (data.success) {
              // Update button state locally
              const newBanned = !isBanned;
              button.setAttribute('data-banned', newBanned);
              button.className = `btn ${newBanned ? 'btn-success-soft' : 'btn-danger-soft'} text-nowrap mb-0 me-2 toggle-inventory-btn`;
              button.innerHTML = `<i class="bi ${newBanned ? 'bi-check2-circle' : 'bi-ban'}"></i> ${newBanned ? 'Show' : 'Ban'}`;
              button.title = `Admin ${newBanned ? 'unblock' : 'block'} Sales`;

              // Show success message with SweetAlert2
              Swal.fire({
                icon: 'success',
                title: `Inventory ${newBanned ? 'blocked' : 'unblocked'} successfully!`,
                timer: 1500,
                showConfirmButton: false
              });
            } else {
              // Show error message with SweetAlert2
              Swal.fire({
                icon: 'error',
                title: 'Failed to toggle inventory status.',
                text: data.message || 'Please try again.'
              });
            }
          } catch (error) {
            console.error('Error toggling inventory:', error);
            Swal.fire({
              icon: 'error',
              title: 'An error occurred.',
              text: 'Please try again later.'
            });
          }
        }
      });
    });
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const saleStatusToggle = document.getElementById("saleStatus");
    const halfDaySaleToggle = document.getElementById("halfDaySale");
    const id = saleStatusToggle.getAttribute('data-id');

    // Toggle Sales Status
    saleStatusToggle.addEventListener("change", async function () {
        const isChecked = this.checked;

        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to ${isChecked ? "enable" : "disable"} Sales Status.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, confirm',
            cancelButtonText: 'Cancel'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/admin/toggle-sales-status/${id}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ saleStatus: isChecked })
                    });

                    const data = await response.json();
                    if (data.success) {
                        Swal.fire("Updated!", "Sales Status updated successfully.", "success");
                    } else {
                        Swal.fire("Failed!", "Could not update Sales Status.", "error");
                        this.checked = !isChecked; // rollback
                    }
                } catch (err) {
                    console.error("Error:", err);
                    Swal.fire("Error!", "Something went wrong!", "error");
                    this.checked = !isChecked; // rollback
                }
            } else {
                this.checked = !isChecked; // rollback if cancelled
            }
        });
    });

    // Toggle Half-Day Sale
    halfDaySaleToggle.addEventListener("change", async function () {
        const isChecked = this.checked;

        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to ${isChecked ? "enable" : "disable"} Half-Day Sale.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, confirm',
            cancelButtonText: 'Cancel'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/admin/toggle-halfday-sale/${id}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ halfDaySale: isChecked })
                    });

                    const data = await response.json();
                    if (data.success) {
                        Swal.fire("Updated!", "Half-Day Sale updated successfully.", "success");
                    } else {
                        Swal.fire("Failed!", "Could not update Half-Day Sale.", "error");
                        this.checked = !isChecked; // rollback
                    }
                } catch (err) {
                    console.error("Error:", err);
                    Swal.fire("Error!", "Something went wrong!", "error");
                    this.checked = !isChecked; // rollback
                }
            } else {
                this.checked = !isChecked; // rollback if cancelled
            }
        });
    });
});
</script>

<!-- **************** MAIN CONTENT END **************** -->

<%- include('./partials/footer') %>