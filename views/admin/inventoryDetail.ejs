<%- include('./partials/header') %>

<!-- **************** MAIN CONTENT START **************** -->

<main>

	<!-- Sidebar START -->
	<%- include('./partials/sideBar') %>
	<!-- Sidebar END -->
	
	<!-- Page content START -->
	<div class="page-content">
	
		<!-- Top bar START -->
		<%- include('./partials/topBar') %>
		<!-- Top bar END -->

        <!-- Page main content START -->
        <div class="page-content-wrapper p-xxl-4">

                <!-- Title -->
                <div class="row">
                    <div class="col-12 mb-4 mb-sm-5">
                        <div class="d-sm-flex justify-content-between align-items-center">
                            <div class="card-body text-dark">
                                <!-- Title -->
                                <h1 class="m-0 h3 card-title"><%= flight.fromCity %> ‚ûù <%= flight.toCity %> on <%= new Date(flight.departureDate).toLocaleDateString('en-GB', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric'}) %></h1>
                                <!-- Breadcrumb -->
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb breadcrumb-dots mb-0">
                                        <li class="breadcrumb-item">User ID: <%= seller.userId %></li>
                                        <% 
  const createdAt = new Date(flight.createdAt);
  const formattedDate = createdAt.toLocaleDateString('en-GB', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
    weekday: 'short'
  });

  const formattedTime = createdAt.toLocaleTimeString('en-US', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  }).toLowerCase(); // to get "am"/"pm" in lowercase

  const parts = formattedDate.split(', ');
  const date = parts[0]; // e.g., "Fri"
  const rest = parts[1]; // e.g., "30 May 2025"
%>
                                        <li class="breadcrumb-item">Booked At: <%= `${rest}, ${date} ${formattedTime}` %></li>
                                        <%
                                            const status = flight.isActive ? 'Confirmed' : 'Cancelled';
                                            let statusClass = '';
                                            if (status === 'Confirmed') {
                                                statusClass = 'text-success';
                                            } else if (status === 'Cancelled') {
                                                statusClass = 'text-danger';
                                            } else {
                                                statusClass = 'text-warning';
                                            }
                                        %>
                                        <li class="breadcrumb-item active <%=statusClass%>"><%=status%></li>
                                    </ol>
                                </nav>

                            </div>
<a href="https://www.google.com/search?q=<%= flight.stops[0].airlineCode %>-<%= flight.stops[0].flightNumber %> airline" 
   target="_blank" 
   class="btn btn-info-soft text-nowrap mb-0 me-2" 
   title="Search Airline">
    <i class="bi bi-airplane-fill"></i>
</a>

                            <a href="/admin/notifications/<%=flight._id%>" class="btn btn-primary-soft text-nowrap mb-0 me-2" title="Remainder"><i
                                    class="bi bi-bell"></i></a>
<button class="btn <%= flight.banned ? 'btn-success-soft' : 'btn-danger-soft' %> text-nowrap mb-0 me-2 toggle-inventory-btn"
        data-id="<%= flight._id %>" 
        data-banned="<%= flight.banned %>"
        title="Admin <%= flight.banned ? 'unblock' : 'block' %> Sales">
    <i class="bi <%= flight.banned ? 'bi-check2-circle' : 'bi-ban' %>"></i> <%= flight.banned ? 'Show' : 'Ban' %>
</button>

                        </div>
                    </div>
                </div>

                <!-- Booking detail START -->
                <div class="row g-3 g-xl-4">
                    <!-- Image -->
                    <!-- Content -->
                    <div class="col-xxl-9">
                        <!-- Flight information START -->
                        <div class="card border">

                            <!-- Card body START -->
                            <div class="card-body p-2">
                                <!-- Card list START -->
                                <!-- Card header -->
                                <!-- Card header -->
                                <div class="card-header">
                                    <div class="d-sm-flex justify-content-sm-between align-items-center">
                                        <!-- Airline Name -->
                                        <div class="d-flex mb-2 mb-sm-0">
                                            <img src="<%= flight.stops[0].airlineLogo %>" class="w-40px me-2"
                                                alt="">
                                            <h6 class="fw-normal mb-0"><%= flight.stops[0].airline %> (<%= flight.stops[0].airlineCode %> - <%= flight.stops[0].flightNumber %>)
                                            </h6>
                                        </div>
                                        <h6 class="fw-normal mb-0"><span class="text-body">Booking
                                                PNR:</span> <%= flight.inventoryDates[0].pnr %></h6>
                                    </div>
                                </div>

                                <!-- Card body START -->
                                <div class="card-body p-4">
                                    <!-- Ticket item START -->
                                    <div class="row g-4">
                                        <!-- Airport detail -->
                                        <div class="col-sm-4">
                                            <!-- Title -->
                                            <h4><%= flight.from %></h4>
                                            <h6 class="mb-0"><%= flight.departureTime %></h6>
                                            <p class="mb-0"><%= flight.departureName %>, <%= flight.fromCity %>, <%= flight.fromCountry %></p>
                                        </div>

                                        <!-- Time -->
                                        <div class="col-sm-4 my-sm-auto text-center">
                                            <!-- Time -->
                                            <h5><%= flight.duration %></h5>

                                            <div class="position-relative my-4">
                                                <!-- Line -->
                                                <hr class="bg-primary opacity-5 position-relative">
                                                <!-- Icon -->
                                                <div
                                                    class="icon-md bg-primary text-white rounded-circle position-absolute top-50 start-50 translate-middle">
                                                    <i class="fa-solid fa-fw fa-plane rtl-flip"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Airport detail -->
                                        <div class="col-sm-4">
                                            <!-- Title -->
                                            <h4><%= flight.to %></h4>
                                            <h6 class="mb-0"><%= flight.arrivalTime %></h6>
                                            <p class="mb-0"><%= flight.arrivalName %>, <%= flight.toCity %>, <%= flight.toCountry %></p>
                                        </div>
                                    </div>
                                    <!-- Ticket item END -->

                                </div>
                                <!-- Card body END -->
                                <!-- Card footer -->
                                <div class="card-footer pt-4">
                                    <ul class="list-inline bg-light rounded-2 d-sm-flex text-center justify-content-sm-between mb-0 px-4 py-2">
                                        <%
                                            refundableClass = flight.refundable ? 'text-success' : 'text-danger';
                                            refundableText = flight.refundable ? 'Refundable' : 'Non-Refundable';
                                        %>
                                        <li class="list-inline-item <%= refundableClass %>"><%= refundableText %></li>
                                        <li class="list-inline-item text-dark">Checked baggage : <%= flight.baggage.adult.checkIn.weightPerPiece %> kg
                                        </li>
                                        <li class="list-inline-item text-dark">Carry-on baggage : <%= flight.baggage.adult.cabin.weightPerPiece %> Kg
                                        </li>

                                    </ul>
                                </div>

                                <!-- Card body -->
                            </div>
                            <!-- Card body END -->
                        </div>
                        <!-- Flight information END -->
                    </div>
                    <div class="col-xxl-3">
                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-2 me-3">
                            <label class="form-check-label ps-0 pe-4" for="inventoryno">Inventory Number</label>
                            <%= flight.inventoryId %>
                        </div>

                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="inventoryuser">Inventory User</label>
                            <%= seller.name %>
                        </div>
                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="saleStatus">Sales Status</label>
                            <input class="form-check-input flex-shrink-0" type="checkbox" id="saleStatus" data-id="<%= flight._id %>" <%= flight.saleStatus ? "checked" : "" %>>
                        </div>
                        <div class="form-check form-switch form-check-md d-flex justify-content-between mb-3 me-3">
                            <label class="form-check-label ps-0 pe-4" for="halfDaySale" >Enable 12 hrs before
                                departure</label>
                            <input class="form-check-input flex-shrink-0" type="checkbox" id="halfDaySale" data-id="<%= flight._id %>" <%= flight.halfDaySale ? "checked" : "" %>>
                        </div>
                        <!-- Booking info -->
                        <div
                            class="bg-light border border-secondary border-opacity-25 p-3 rounded d-inline-block">
                            <h6 class="small">Real Time Seats Information:</h6>
                            <!-- Avatar -->
                            <!-- Info -->
                            <div class="hstack gap-2 gap-md-5 flex-wrap mt-2 ">
                                <div>
                                    <small>Total Seats</small>
                                    <h6 class="fw-normal mb-0"><%=flight.inventoryDates[0].seats%> Seats</h6>
                                </div>
                                <div>
                                    <small>Sold Seats</small>
                                    <h6 class="fw-normal mb-0"><%=flight.inventoryDates[0].seatsBooked%> Seats</h6>
                                </div>
                                <div>
                                    <small>Hold Seats</small>
                                    <h6 class="fw-normal mb-0"><%= flight.inventoryDates[0].seatsHold.reduce((sum, hold) => sum + hold.seats, 0) %> Seats</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Booking detail END -->

 
                    <ul class="nav nav-tabs nav-justified mb-3">
                        <li class="nav-item "> <a class="nav-link text-primary mb-0 active" data-bs-toggle="tab" href="#tab-1"><i
                                    class="bi bi-bookmark-heart fa-fw me-1"></i> Booking
                                Details</a> </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab" href="#tab-2"><i
                                    class="bi bi-receipt"></i>
                                Transactions</a> </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab" href="#tab-5"><i
                                    class="bi bi-paypal"></i>
                                Payments</a> </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab" href="#tab-4"><i
                                    class="bi bi-card-checklist"></i> Booking Activities</a>
                        </li>
                        <li class="nav-item"> <a class="nav-link text-primary mb-0" data-bs-toggle="tab" href="#tab-3"><i
                                    class="bi bi-patch-question"></i> Help Desk</a> </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-primary" href="#" id="dropdoanMenu"
                                title="Please inactive Inventory For Edit options" data-bs-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">
                                <i class="bi bi-list-ul fa-fw me-1"></i>Booking Actions
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="dropdoanMenu">
                                <!-- Dropdown menu -->
                                <li> <a class="dropdown-item" href="#" 
                                  data-bs-toggle="modal"
																		data-bs-target="#dateModal"
																		data-flight="<%= JSON.stringify(flight) %>">
                                    <i class="bi bi-card-checklist"></i>
                                        Edit Inventory Details</a>
                                </li>
                                <li> <a class="dropdown-item" href="#" 
                                    data-bs-toggle="modal"
																		data-bs-target="#seatModal"
																		data-flight="<%= JSON.stringify(flight) %>">
                                    <i class="bi bi-airplane"></i>
                                        Edit Flight Details</a>
                                </li>
                                <li> <a class="dropdown-item" href="#"
                                  data-bs-toggle="modal"
																		data-bs-target="#baggageModal"
																		data-flight="<%= JSON.stringify(flight) %>">
                                  <i class="bi bi-luggage-fill"></i> Edit
                                        Baggage Details</a>
                                </li>
                                <li> <a class="dropdown-item" href="#"
                                  data-bs-toggle="modal"
																		data-bs-target="#flightModal"
																		data-flight="<%= JSON.stringify(flight) %>">
                                  <i class="bi bi-cart-check-fill"></i>
                                        Utility Service Details</a>
                                </li>
                            </ul>
                        </li>

                    </ul>

				<div class="modal fade" id="flightModal" tabindex="-1" aria-labelledby="flightModalLabel"
					aria-hidden="true">
					<div class="modal-dialog modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="flightModalLabel">Update Flight</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"
									aria-label="Close"></button>
							</div>

							<div class="modal-body">
								<form id="flightForm">
									<input type="hidden" name="flightId" id="flightId">
									<div class="row g-3">
										<!-- Row 1 -->
										<div class="col-md-3">
											<label class="form-label">Inventory ID</label>
											<input type="text" class="form-control" id="inventoryId">
										</div>

										<div class="col-md-4">
											<label class="form-label">From</label>
											<input type="text" class="form-control" id="from">
										</div>

										<div class="col-md-4">
											<label class="form-label">To</label>
											<input type="text" class="form-control" id="to">
										</div>

										<div class="col-md-3">
											<label class="form-label">From Code</label>
											<input type="text" class="form-control" id="fromCode">
										</div>

										<div class="col-md-3">
											<label class="form-label">To Code</label>
											<input type="text" class="form-control" id="toCode">
										</div>

										<div class="col-md-3">
											<label class="form-label">Departure Date</label>
											<input type="text" class="form-control dateInput" id="departureDate">
										</div>

										<div class="col-md-3">
											<label class="form-label">Arrival Date</label>
											<input type="text" class="form-control dateInput" id="arrivalDate">
										</div>

										<div class="col-md-3">
											<label class="form-label">Departure Time</label>
											<input type="time" class="form-control" id="departureTime">
										</div>

										<div class="col-md-3">
											<label class="form-label">Arrival Time</label>
											<input type="time" class="form-control" id="arrivalTime">
										</div>

										<div class="col-md-3">
											<label class="form-label">Duration(in sec)</label>
											<input type="text" class="form-control" id="duration">
										</div>

										<div class="col-md-3">
											<label class="form-label">From City</label>
											<input type="text" class="form-control" id="fromCity">
										</div>

										<div class="col-md-3">
											<label class="form-label">To City</label>
											<input type="text" class="form-control" id="toCity">
										</div>

										<div class="col-md-3">
											<label class="form-label">From Country</label>
											<input type="text" class="form-control" id="fromCountry">
										</div>

										<div class="col-md-3">
											<label class="form-label">To Country</label>
											<input type="text" class="form-control" id="toCountry">
										</div>

										<!-- Row 2 -->

										<div id="stopsContainer" class="row g-3 stop-block"></div>

										<!-- Row 3 -->
										<div class="col-md-3">
											<label class="form-label">PNR</label>
											<input type="text" class="form-control" id="pnr">
										</div>

										<div class="col-md-3">
											<label class="form-label">Seats</label>
											<input type="number" class="form-control" id="seats">
										</div>

										<div class="col-md-3">
											<label class="form-label">Adults ‚Çπ</label>
											<input type="number" class="form-control" id="adults">
										</div>

										<div class="col-md-3">
											<label class="form-label">Infants ‚Çπ</label>
											<input type="number" class="form-control" id="infants">
										</div>

										<div class="col-md-3">
											<label class="form-label">Cabin Weight</label>
											<input type="text" class="form-control" id="cab">
										</div>

										<div class="col-md-3">
											<label class="form-label">CheckIn Weight</label>
											<input type="text" class="form-control" id="checkin">
										</div>

										<div class="col-md-3">
											<label class="form-label">Status</label>
											<select class="form-select" id="status">
												<option value="active">Active</option>
												<option value="inactive">Inactive</option>
											</select>
										</div>

									</div>
								</form>
							</div>

							<div class="modal-footer">
								<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
								<button type="submit" id="updateFlightBtn" class="btn btn-primary">Update</button>
							</div>
						</div>
					</div>
				</div>

        <div class="modal fade" id="baggageModal" tabindex="-1" aria-labelledby="baggageModalLabel"
					aria-hidden="true">
					<div class="modal-dialog modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="baggageModalLabel">Update Baggage Details</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"
									aria-label="Close"></button>
							</div>

							<div class="modal-body">
								<form id="baggageForm">
                  <input type="hidden" name="flightId" id="flightId">
									<div class="row g-3">
										<div class="col-md-3">
											<strong class="align-items-center">Adult</strong>
										</div>

										<div class="col-md-3">
											<label class="form-label">Cabin Weight</label>
											<input type="text" class="form-control" id="adult-cab">
										</div>

										<div class="col-md-3">
											<label class="form-label">CheckIn Weight</label>
											<input type="text" class="form-control" id="adult-checkin">
										</div>

									</div>

                  <div class="row g-3">
										<div class="col-md-3">
											<strong class="align-items-center">Children</strong>
										</div>

										<div class="col-md-3">
											<label class="form-label">Cabin Weight</label>
											<input type="text" class="form-control" id="children-cab">
										</div>

										<div class="col-md-3">
											<label class="form-label">CheckIn Weight</label>
											<input type="text" class="form-control" id="children-checkin">
										</div>

									</div>

                  <div class="row g-3">
										<div class="col-md-3">
											<strong class="align-items-center">Infant</strong>
										</div>

										<div class="col-md-3">
											<label class="form-label">Cabin Weight</label>
											<input type="text" class="form-control" id="infant-cab">
										</div>

										<div class="col-md-3">
											<label class="form-label">CheckIn Weight</label>
											<input type="text" class="form-control" id="infant-checkin">
										</div>

									</div>
								</form>
							</div>

							<div class="modal-footer">
								<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
								<button type="submit" id="updateBaggageBtn" class="btn btn-primary">Update</button>
							</div>
						</div>
					</div>
				</div>

				<div class="modal fade" id="seatModal" tabindex="-1" aria-labelledby="seatModalLabel"
					aria-hidden="true">
					<div class="modal-dialog modal-lg">
						<div class="modal-content">

							<div class="modal-header">
								<h5 class="modal-title" id="seatModalLabel">Update Seats on <span id="seatfrom"></span>
									- <span id="seatto"></span> & PNR: <span id="seatpnr"></span></h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"
									aria-label="Close"></button>
							</div>

							<div class="modal-body" style="padding: 0;">
								<form id="seatForm">
									<input type="hidden" name="inventoryId" id="inventoryId">
									<div class="table-responsive">
										<table class="table custom-border text-center p-0" style="font-size: 0.9em;">
											<thead class="table-light">
												<tr>
													<th>Travel Date</th>
													<th>Seats Booked</th>
													<th>Total Seats</th>
													<th>Fare Amount Adults(12y+)</th>
													<th>Fare-Infants(Below 2y)</th>
													<th>ACTION</th>
												</tr>
											</thead>
											<tbody class="table-light">
												<tr>
													<td><input type="text"
															class="form-control-plaintext text-center text-dark"
															id="travelDate" disabled></td>
													<td><input type="text"
															class="form-control-plaintext text-center text-dark"
															id="seatsBooked" readonly></td>
													<td><input type="text"
															class="form-control border-0 text-center text-dark"
															id="totalSeats" required
															onkeypress='return event.charCode >= 48 && event.charCode <= 57'>
													</td>
													<td><input type="text"
															class="form-control border-0 text-center text-dark"
															id="fareAdults" required
															onkeypress='return event.charCode >= 48 && event.charCode <= 57'>
													</td>
													<td><input type="text"
															class="form-control border-0 text-center text-dark"
															id="fareInfants" required
															onkeypress='return event.charCode >= 48 && event.charCode <= 57'>
													</td>
													<td><button type="submit" id="updateSeatBtn"
															class="btn text-primary">Save</button></td>
												</tr>
											</tbody>
										</table>
									</div>

								</form>
							</div>

						</div>
					</div>
				</div>

				<div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel"
					aria-hidden="true">
					<div class="modal-dialog modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="dateModalLabel">Schedule Update Details</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"
									aria-label="Close"></button>
							</div>

							<div class="modal-body">
								<form id="flightForm">
									<input type="hidden" name="flightId" id="flightId">
									<div class="row g-3">

										<div>
											<h5><span id="displayFromCode"></span> ‚Üí <span id="displayToCode"></span> -
												<span id="displayDepartureDate"></span>
											</h5>
											<p>Sector: <span id="displayFrom"></span> - <span id="displayTo"></span> ‚Ä¢
												<span id="displayAirline"></span> : <span
													id="displayAirlineCode"></span> - <span
													id="displayFlightNumber"></span>
												‚Ä¢ Total Seats : <span id="displaySeats"></span> ‚Ä¢ <span
													class="text-success">Sold Seats : <span
														id="displaySoldSeats"></span></span>
											</p>
											<p>Departure & Arrival Time : <span id="displayDepartureTime"></span> -
												<span id="displayArrivalTime"></span></p>
											<p>Travel Date : <span class="fw-bold" id="displaydepartureDate"></span></p>
										</div>

										<div class="position-relative">
											<hr />
											<h6 class="position-absolute top-50 translate-middle start-0 bg-mode px-2 text-muted"
												style="left: 95px !important;">
												Edit Inventory Details
											</h6>

										</div>
										<!-- Row 1 -->
										<div class="col-md-4">
											<label class="form-label">Airline</label>
											<input type="text" class="form-control" id="inputAirline" disabled>
										</div>

										<div class="col-md-4">
											<label class="form-label">Flight Number</label>
											<input type="text" class="form-control" id="inputFlightNumber" disabled>
										</div>

										<div class="col-md-4">
											<label class="form-label">Travel Date</label>
											<input type="text" class="form-control dateInput" id="inputDepartureDate">
										</div>

										<div class="col-md-4">
											<label class="form-label">Departure Time</label>
											<input type="time" class="form-control" id="inputDepartureTime">
										</div>

										<div class="col-md-4">
											<label class="form-label">Arrival Date</label>
											<input type="text" class="form-control dateInput" id="inputArrivalDate">
										</div>

										<div class="col-md-4">
											<label class="form-label">Arrival Time</label>
											<input type="time" class="form-control" id="inputArrivalTime">
										</div>
									</div>
								</form>
							</div>

							<div class="modal-footer">
								<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
								<button type="submit" id="updateDateBtn" class="btn btn-primary">Save Inventory
									Details</button>
							</div>
						</div>
					</div>
				</div>

				<script>
					const seatModal = document.getElementById('seatModal');

					seatModal.addEventListener('show.bs.modal', async function (event) {
						const button = event.relatedTarget;
						const flightData = JSON.parse(button.getAttribute('data-flight'));
						console.log(flightData);

						const invDate = flightData.inventoryDates?.[0] || {};

						document.getElementById('inventoryId').value = flightData._id || '';
						document.getElementById('travelDate').value = flightData.departureDate || '';
						document.getElementById('seatpnr').textContent = invDate.pnr || '';
						document.getElementById('seatsBooked').value = `${invDate.seatsBooked || 0}/${invDate.seats || 0}`;
						document.getElementById('totalSeats').value = invDate.seats || '';
						document.getElementById('fareAdults').value = invDate.fare?.adults || '';
						document.getElementById('fareInfants').value = invDate.fare?.infants || '';
						document.getElementById('seatfrom').textContent = flightData.from || '';
						document.getElementById('seatto').textContent = flightData.to || '';
					});

				</script>

				<script>
					document.getElementById('updateSeatBtn').addEventListener('click', async function (e) {
						e.preventDefault(); // stop form from submitting normally

						const inventoryId = document.getElementById('inventoryId').value;

						const updatedData = {
							// departureDate: document.getElementById('travelDate').value,
							inventoryDates: [{
								seats: document.getElementById('totalSeats').value,
								fare: {
									adults: document.getElementById('fareAdults').value,
									infants: document.getElementById('fareInfants').value
								}
							}],
							// disableBeforeDeparture: document.getElementById('disableBeforeDeparture').value,
							// status: document.getElementById('status').value
						};

						try {
							const response = await fetch(`/admin/update-seats?id=${inventoryId}`, {
								method: 'PUT',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify(updatedData)
							});

							if (!response.ok) {
								throw new Error('Failed to update flight');
							}

							const result = await response.json();
Swal.fire({
  icon: 'success',
  title: 'Success',
  text: 'Flight updated successfully!',
  confirmButtonText: 'OK'
}).then(() => window.location.reload());

						} catch (error) {
							console.error('Error:', error);
Swal.fire({
  icon: 'error',
  title: 'Update Failed',
  text: 'Error updating flight.',
  confirmButtonText: 'OK'
});
						}
					});

				</script>

				<script>
					const dateModal = document.getElementById('dateModal');

					dateModal.addEventListener('show.bs.modal', function (event) {
						const button = event.relatedTarget;
						const flightData = JSON.parse(button.getAttribute('data-flight'));

						// Fill the header fields
						document.getElementById('flightId').value = flightData._id || '';
						document.getElementById('displayFromCode').textContent = flightData.from || '';
						document.getElementById('displayToCode').textContent = flightData.to || '';
						document.getElementById('displayDepartureDate').textContent = flightData.departureDate || '';
						document.getElementById('displayAirline').textContent = flightData.stops[0]?.airline || '';
						document.getElementById('displayAirlineCode').textContent = flightData.stops[0]?.airlineCode || '';
						document.getElementById('displayFlightNumber').textContent = flightData.stops[0]?.flightNumber || '';
						document.getElementById('displaySeats').textContent = flightData.inventoryDates?.[0]?.seats || '';
						document.getElementById('displayDepartureTime').textContent = flightData.departureTime || '';
						document.getElementById('displayArrivalTime').textContent = flightData.arrivalTime || '';
						document.getElementById('displaydepartureDate').textContent = flightData.departureDate || '';
						document.getElementById('displayFrom').textContent = flightData.from || '';
						document.getElementById('displayTo').textContent = flightData.to || '';
						document.getElementById('displaySoldSeats').textContent = flightData.inventoryDates?.[0]?.seatsBooked || 0;

						// Fill form inputs
						document.getElementById('inputAirline').value = flightData.stops[0]?.airline || '';
						document.getElementById('inputFlightNumber').value = flightData.stops[0]?.flightNumber || '';
						document.getElementById('inputDepartureDate').value = flightData.departureDate || '';
						document.getElementById('inputDepartureTime').value = flightData.departureTime || '';
						document.getElementById('inputArrivalDate').value = flightData.arrivalDate || '';
						document.getElementById('inputArrivalTime').value = flightData.arrivalTime || '';
					});

				</script>

				<script>
					document.getElementById('updateDateBtn').addEventListener('click', async function (e) {
						e.preventDefault(); // prevent form from submitting normally

						const flightId = document.getElementById('flightId').value;

						const updatedData = {
							departureDate: document.getElementById('inputDepartureDate').value,
							departureTime: document.getElementById('inputDepartureTime').value,
							arrivalDate: document.getElementById('inputArrivalDate').value,
							arrivalTime: document.getElementById('inputArrivalTime').value,
						};

						try {
							const response = await fetch(`/admin/update-dates?id=${flightId}`, {
								method: 'PUT',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify(updatedData)
							});

							if (!response.ok) {
								throw new Error('Failed to update flight');
							}

							const result = await response.json();
Swal.fire({
  icon: 'success',
  title: 'Success',
  text: 'Flight updated successfully!',
  confirmButtonText: 'OK'
}).then(() => window.location.reload());
						} catch (error) {
							console.error('Error:', error);
Swal.fire({
  icon: 'error',
  title: 'Update Failed',
  text: 'Error updating flight.',
  confirmButtonText: 'OK'
});						}
					});

				</script>

				<script>
					const baggageModal = document.getElementById('baggageModal');

					baggageModal.addEventListener('show.bs.modal', function (event) {
						const button = event.relatedTarget;
						const flightData = JSON.parse(button.getAttribute('data-flight'));

            document.getElementById('flightId').value = flightData._id || 0;
						document.getElementById('adult-cab').value = flightData.baggage?.adult?.cabin?.weightPerPiece || 0;
						document.getElementById('adult-checkin').value = flightData.baggage?.adult?.checkIn?.weightPerPiece || 0;
            document.getElementById('children-cab').value = flightData.baggage?.child?.cabin?.weightPerPiece || 0;
            document.getElementById('children-checkin').value = flightData.baggage?.child?.checkIn?.weightPerPiece || 0;
            document.getElementById('infant-cab').value = flightData.baggage?.infant?.cabin?.weightPerPiece || 0;
            document.getElementById('infant-checkin').value = flightData.baggage?.infant?.checkIn?.weightPerPiece || 0;
          
					});
				</script>

				<script>
					document.getElementById('updateBaggageBtn').addEventListener('click', async function () {
						const form = document.getElementById('baggageForm');
						const flightId = document.getElementById('flightId').value;

						const updatedData = {
							baggage: {
								adult: {
									cabin: { weightPerPiece: document.getElementById('adult-cab').value },
									checkIn: { weightPerPiece: document.getElementById('adult-checkin').value }
								},
                child: {
                  cabin: { weightPerPiece: document.getElementById('children-cab').value },
                  checkIn: { weightPerPiece: document.getElementById('children-checkin').value }
                },  
                infant: {
                  cabin: { weightPerPiece: document.getElementById('infant-cab').value },
                  checkIn: { weightPerPiece: document.getElementById('infant-checkin').value }
                },
							},
						};

						try {
							const response = await fetch(`/admin/update-baggage?id=${flightId}`, {
								method: 'PUT',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify(updatedData)
							});

							if (!response.ok) {
								throw new Error('Failed to update baggage details');
							}

							const result = await response.json();
							Swal.fire({
  icon: 'success',
  title: 'Success',
  text: 'Baggage details updated successfully!',
  confirmButtonText: 'OK'
}).then(() => window.location.reload());
						} catch (error) {
							console.error('Error:', error);
Swal.fire({
  icon: 'error',
  title: 'Update Failed',
  text: 'Error updating baggage details.',
  confirmButtonText: 'OK'
});
						}
					});
				</script>

        <script>
					const flightModal = document.getElementById('flightModal');

					flightModal.addEventListener('show.bs.modal', function (event) {
						const button = event.relatedTarget;
						const flightData = JSON.parse(button.getAttribute('data-flight'));

						// Main flight details
						document.getElementById('flightId').value = flightData._id;
						document.getElementById('inventoryId').value = flightData.inventoryId || '';
						document.getElementById('from').value = flightData.departureName || '';
						document.getElementById('to').value = flightData.arrivalName || '';
						document.getElementById('fromCode').value = flightData.from || '';
						document.getElementById('toCode').value = flightData.to || '';
						document.getElementById('departureDate').value = flightData.departureDate || '';
						document.getElementById('arrivalDate').value = flightData.arrivalDate || '';
						document.getElementById('departureTime').value = flightData.departureTime || '';
						document.getElementById('arrivalTime').value = flightData.arrivalTime || '';
						document.getElementById('duration').value = flightData.duration || '';
						document.getElementById('fromCity').value = flightData.fromCity || '';
						document.getElementById('toCity').value = flightData.toCity || '';
						document.getElementById('fromCountry').value = flightData.fromCountry || '';
						document.getElementById('toCountry').value = flightData.toCountry || '';

						// Clear existing stops if any
						const stopsContainer = document.getElementById('stopsContainer');
						stopsContainer.innerHTML = '';

						// Add stops dynamically
						if (flightData.stops && flightData.stops.length > 0) {
							flightData.stops.forEach((stop, index) => {
								const stopHTML = `
				<div class="col-12"><hr><strong>Stop ${index}</strong></div>
				<div class="col-md-4">
				  <label class="form-label">From</label>
				  <input type="text" class="form-control stop-from" value="${stop.from || ''}" >
				</div>
				<div class="col-md-4">
				  <label class="form-label">To</label>
				  <input type="text" class="form-control stop-from" value="${stop.to || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">From Code</label>
				  <input type="text" class="form-control stop-from-code" value="${stop.fromCode || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">To Code</label>
				  <input type="text" class="form-control stop-to-code" value="${stop.toCode || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">From Terminal</label>
				  <input type="text" class="form-control stop-from-terminal" value="${stop.fromTerminal || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">To Terminal</label>
				  <input type="text" class="form-control stop-to-terminal" value="${stop.toTerminal || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Flight Number</label>
				  <input type="text" class="form-control stop-flight-number" value="${stop.flightNumber || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Airline</label>
				  <input type="text" class="form-control stop-airline" value="${stop.airline || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Departure Date</label>
				  <input type="text" class="form-control stop-departure-day dateInput" value="${stop.departureDay || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Arrival Date</label>
				  <input type="text" class="form-control stop-arrival-day dateInput" value="${stop.arrivalDay || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Departure Time</label>
				  <input type="time" class="form-control stop-departure-time" value="${stop.departureTime || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Arrival Time</label>
				  <input type="time" class="form-control stop-arrival-time" value="${stop.arrivalTime || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Stop Duration (in sec)</label>
				  <input type="text" class="form-control stop-duration" value="${stop.stopDuration || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Departure City</label>
				  <input type="text" class="form-control stop-departure-city" value="${stop.departureCity || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Arrival City</label>
				  <input type="text" class="form-control stop-arrival-city" value="${stop.arrivalCity || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Airline Code</label>
				  <input type="text" class="form-control stop-airline-code" value="${stop.airlineCode || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Airline Logo</label>
				  <input type="text" class="form-control stop-airline-logo" value="${stop.airlineLogo || ''}" >
				</div>
			  `;
								stopsContainer.insertAdjacentHTML('beforeend', stopHTML);
							});
						}

						// Pricing and baggage
						const invDate = flightData.inventoryDates?.[0] || {};
						document.getElementById('pnr').value = invDate.pnr || '';
						document.getElementById('seats').value = invDate.seats || '';
						document.getElementById('adults').value = invDate.fare?.adults || '';
						document.getElementById('infants').value = invDate.fare?.infants || '';
						document.getElementById('cab').value = flightData.baggage?.adult?.cabin?.weightPerPiece || '';
						document.getElementById('checkin').value = flightData.baggage?.adult?.checkIn?.weightPerPiece || '';

						// Status
						document.getElementById('status').value = flightData.status || 'inactive';
					});
				</script>

				<script>
					document.getElementById('updateFlightBtn').addEventListener('click', async function () {
						const form = document.getElementById('flightForm');

						const getValue = (id) => document.getElementById(id)?.value || '';
						const flightId = getValue('flightId');

						const stopBlocks = document.querySelectorAll('.stop-block');
						const stops = [];

						stopBlocks.forEach((block, index) => {
							stops.push({
								from: block.querySelector('.stop-from')?.value || '',
								to: block.querySelector('.stop-to')?.value || '',
								fromCode: block.querySelector('.stop-from-code')?.value || '',
								toCode: block.querySelector('.stop-to-code')?.value || '',
								fromTerminal: block.querySelector('.stop-from-terminal')?.value || '',
								toTerminal: block.querySelector('.stop-to-terminal')?.value || '',
								flightNumber: block.querySelector('.stop-flight-number')?.value || '',
								airline: block.querySelector('.stop-airline')?.value || '',
								departureDay: block.querySelector('.stop-departure-day')?.value || '',
								arrivalDay: block.querySelector('.stop-arrival-day')?.value || '',
								departureTime: block.querySelector('.stop-departure-time')?.value || '',
								arrivalTime: block.querySelector('.stop-arrival-time')?.value || '',
								stopDuration: block.querySelector('.stop-duration')?.value || '',
								departureCity: block.querySelector('.stop-departure-city')?.value || '',
								arrivalCity: block.querySelector('.stop-arrival-city')?.value || '',
								airlineCode: block.querySelector('.stop-airline-code')?.value || '',
								airlineLogo: block.querySelector('.stop-airline-logo')?.value || ''
							});
						});

						const flightData = {
							flightId: getValue('flightId'),
							inventoryId: getValue('inventoryId'),
							from: getValue('fromCode'),
							to: getValue('toCode'),
							departureName: getValue('from'),
							arrivalName: getValue('to'),
							departureDate: getValue('departureDate'),
							arrivalDate: getValue('arrivalDate'),
							departureTime: getValue('departureTime'),
							arrivalTime: getValue('arrivalTime'),
							duration: getValue('duration'),
							fromCity: getValue('fromCity'),
							toCity: getValue('toCity'),
							fromCountry: getValue('fromCountry'),
							toCountry: getValue('toCountry'),
							stops: stops,
							inventoryDates: [{
								pnr: getValue('pnr'),
								seats: getValue('seats'),
								fare: {
									adults: getValue('adults'),
									infants: getValue('infants'),
								}
							}],
							baggage: {
								adult: {
									cabin: { weightPerPiece: getValue('cab') },
									checkIn: { weightPerPiece: getValue('checkin') }
								}
							},
							status: getValue('status'),
						};

						try {
							const response = await fetch(`/admin/update-listing?id=${flightId}`, {
								method: 'PUT',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify(flightData)
							});

							if (!response.ok) {
								throw new Error('Failed to update flight');
							}

							const result = await response.json();
							Swal.fire({
  icon: 'success',
  title: 'Success',
  text: 'Flight updated successfully!',
  confirmButtonText: 'OK'
}).then(() => window.location.reload());
						} catch (error) {
							console.error('Error:', error);
Swal.fire({
  icon: 'error',
  title: 'Update Failed',
  text: 'Error updating flight.',
  confirmButtonText: 'OK'
});
						}
					});
				</script>

                    <div class="tab-content">
                        <!-- Tab content 1 START -->
                        <div class="tab-pane show active" id="tab-1">
                            <div class="row g-3 ">
                                <div class="col-12"> <!-- Booking table START -->
                                    <div class="card border">
                                        <!-- Card header START -->
                                        <div class="card-header border-bottom d-md-flex justify-content-md-between">
                                            <h5 class="card-header-title"><i class="bi bi-passport"></i> Passengers
                                            </h5>
                                            <!-- <form class="rounded position-relative">
                                                <input class="form-control pe-5" type="search" placeholder="Search"
                                                    aria-label="Search">
                                                <button
                                                    class="btn border-0 px-3 py-0 position-absolute top-50 end-0 translate-middle-y"
                                                    type="submit"><i class="fas fa-search fs-6"></i></button>
                                            </form> -->
                                        </div>
                                        <!-- Card header END -->
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <!-- Table head -->
                                            <div class="table-responsive">
                                                <table class="datatable-init-export nowrap table"
                                                    data-export-title="Export">
                                                    <thead>

                                                        <tr>
                                                            <th>No</th>
                                                            <th>Booking ID </th>
                                                            <th>Title</th>
                                                            <th>First Name</th>
                                                            <th>Last Name</th>
                                                            <th>Email </th>
                                                            <th>Mobile </th>
                                                            <th>Actions</th>

                                                        </tr>

                                                    </thead>

                                                    <tbody>
                                                        <% if(bookings.length > 0) { %>
                                                            <% bookings.forEach((booking, index) => { %>
                                                        <tr>
                                                            <td><%= index+1 %></td>
                                                            <td><%= booking.bookingId %></td>
                                                            <td><%= booking.travelers[0].title %></td>
                                                            <td><%= booking.travelers[0].first_name %></td>
                                                            <td><%= booking.travelers[0].last_name %></td>
                                                            <td><%= booking.email %></td>
                                                            <td><%= booking.mobile_number %></td>


                                                            <td>
                                                                <a href="/admin/booking-detail/<%= booking._id %>" class="btn btn-sm btn-outline-info mb-0 me-2"
                                                                    title="Booking Details"><i
                                                                        class="bi bi-eye-fill"></i></a>
                                                                <!-- <button class="btn btn-sm btn-outline-dark mb-0 me-2"
                                                                    title="Ticket Details"><i
                                                                        class="bi bi-ticket-perforated-fill"></i></button>
                                                                <button
                                                                    class="btn btn-sm btn-outline-primary mb-0 me-2"
                                                                    title="Payment Details"><i
                                                                        class="bi bi-credit-card"></i></button>
                                                                <button class="btn btn-sm btn-outline-danger mb-0 me-2"
                                                                    title="Help & Support"><i
                                                                        class="bi bi-life-preserver"></i></button> -->

                                                            </td>
                                                        
                                                        </tr>
                                                        <% }) %>
                                                        <% } else { %>
                                                            <tr>
                                                                <td colspan="8" class="text-center">No bookings found.</td>
                                                            </tr>
                                                        <% } %>
                                                    </tbody>
                                                </table>
                                            </div>

                                        </div>
                                        <!-- Card body END -->

                                        <!-- Card footer START -->
                                        <div class="card-footer pt-1">
  <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
    <p class="mb-sm-0 text-center text-sm-start">
      Showing <%= (bookingPagination.page - 1) * bookingPagination.limit + 1 %>
      to <%= Math.min(bookingPagination.page * bookingPagination.limit, bookingPagination.total) %>
      of <%= bookingPagination.total %> entries
    </p>
    <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
      <ul class="pagination pagination-sm pagination-primary-soft mb-0">
        <% for(let i=1; i<=Math.ceil(bookingPagination.total / bookingPagination.limit); i++) { %>
          <li class="page-item <%= bookingPagination.page === i ? 'active' : '' %>">
            <!-- <a class="page-link" href="?id=<%= flight._id %>&page=<%= i %>#tab-2"><%= i %></a> -->
             <a class="page-link" href="?id=<%= flight._id %>&bookingPage=<%= i %>#tab-1"><%= i %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>
                                        <!-- Card footer END -->
                                    </div>
                                </div>
                            </div> <!-- Booking table END -->
                        </div>
                        <!-- Tab content 2 START -->
                        <div class="tab-pane show  " id="tab-2">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header -->
                                        <div class="card-header border-bottom">
                                            <h5 class="card-header-title">Booking Transactions</h5>
                                        </div>
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <div class="table-responsive">

                                            <table class="table">

                                                <thead>
                                                    
                                                    <tr>

                                                        <th>Booking Id</th>
                                                        <th>Booking date</th>
                                                        <th>Particulars</th>
                                                        <th>Booking Amount</th>
                                                        <th>C.Fee</th>
                                                        <th>Paid Amount</th>
                                                        <th>Pay Status</th>
                                                        <th>Actions</th>

                                                    </tr>

                                                </thead>

                                                <tbody>
                                                    <%
                                                    if(!transactions || transactions.length === 0) { %>
                                                        <tr>
                                                            <td colspan="8" class="text-center">No transactions found.</td>
                                                        </tr>
                                                    <% } else { %>
                                                        <% transactions.forEach((transaction) => { %>
                                                            <% const flight = transaction.bookingId.flight %>
                                                    <tr>

                                                        <td scope="1"> <%= transaction.bookingId.bookingId %> </td>
                                                        <td><%= new Date(transaction.bookingId.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-') %></td>
                                                        <%
                                                            let stopType;
                                                            const stops = flight.stops.length;
                                                            if(stops === 1){
                                                                stopType = 'Non Stop';
                                                            }
                                                            else if(stops === 2) {
                                                                stopType = 1 + ' Stop';
                                                            } 
                                                            else {
                                                                stopType = stops + ' Stops';
                                                            }
                                                        %>
                                                        <td>
                                                            (<%= flight.inventoryDates[0].pnr %>): <%= flight.departureDate.toUpperCase() %> <%= flight.from %> <%= flight.to %> <%= flight.stops[0].airlineCode %>-<%= flight.stops[0].flightNumber %> <%= stopType %>
                                                        </td>
                                                        <td>‚Çπ <%= transaction.totalAmount %></td>
                                                        <td>‚Çπ <%= transaction.discount %></td>
                                                        <td>‚Çπ <%= transaction.totalAmount %></td>
                                                        <td><%= transaction.paymentStatus %> </td>
                                                        <td><a href="/admin/booking-detail/<%= transaction.bookingId._id %>" class="btn btn-sm btn-outline-warning mb-0 me-2"
                                                                title="Booking Details"><i
                                                                    class="bi bi-eye-fill"></i></a>
                                                            <a href="/admin/withdrawal/<%=flight._id%>/<%=seller._id%>" class="btn btn-sm btn-outline-info mb-0 me-2"
                                                                title="Supplier Transfer"><i
                                                                    class="bi bi-paypal"></i></a>
                                                        </td>

                                                    </tr>
                                                        <% }) %>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                            </div>
                                        </div>
                                        <!-- Card body END -->

                                        <!-- Card footer START -->
                                        <div class="card-footer pt-1">
  <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
    <p class="mb-sm-0 text-center text-sm-start">
      Showing <%= (transactionPagination.page - 1) * transactionPagination.limit + 1 %>
      to <%= Math.min(transactionPagination.page * transactionPagination.limit, transactionPagination.total) %>
      of <%= transactionPagination.total %> entries
    </p>
    <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
      <ul class="pagination pagination-sm pagination-primary-soft mb-0">
        <% for(let i=1; i<=Math.ceil(transactionPagination.total / transactionPagination.limit); i++) { %>
          <li class="page-item <%= transactionPagination.page === i ? 'active' : '' %>">
            <!-- <a class="page-link" href="?id=<%= flight._id %>&page=<%= i %>#tab-2"><%= i %></a> -->
             <a class="page-link" href="?id=<%= flight._id %>&transactionPage=<%= i %>#tab-2"><%= i %></a>

          </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>
                                        <!-- Card footer END -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tab content 2 START -->
                        <div class="tab-pane show  " id="tab-5">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header -->
                                        <div class="card-header border-bottom">
                                            <h5 class="card-header-title">Booking Payments</h5>
                                        </div>
                                        <!-- Card body START -->
                                        <div class="card-body">
                                        <div class="table-responsive">

                                            <table class="table">
                                                <thead>
                                                    <tr>

                                                        <!-- <th>ID</th> -->
                                                        <th>Booking ID</th>
                                                        <th>Type</th>
                                                        <th>Booking date</th>
                                                        <th>Amount</th>
                                                        <th>Transactions ID</th>
                                                        <th>Gateway</th>
                                                        <th>Method</th>
                                                        <th>Charges</th>
                                                        <th>Pay Status</th>
                                                        <th>Actions</th>

                                                    </tr>
                                                </thead>

                                                <tbody>
                                                    <% if(transactions.length > 0) { %>
                                                        <% transactions.forEach((transaction) => { %>
                                                    <tr>
                                                        <!-- <td scope="1"> GPT3272 </td> -->
                                                        <td><%= transaction.bookingId.bookingId %></td>
                                                        <td><%= transaction.type %></td>
                                                        <td>
                                                          <%= new Date(transaction.createdAt).toLocaleDateString('en-GB', {
                                                            day: '2-digit',
                                                            month: 'short',
                                                            year: 'numeric'
                                                          }).replace(/ /g, '-') %>
                                                        </td>
                                                        <td>‚Çπ <%= transaction.totalAmount %></td>
                                                        <td><%= transaction.transactionId %> </td>
                                                        <td>HDFC BANK</td>
                                                        <td>UPI</td>
                                                        <%
                                                            const totalAmount = transaction.totalAmount;
                                                            const taxAmount = transaction.tax;
                                                            const discountAmount = transaction.discount;
                                                            const taxPercentage = Math.floor(((taxAmount / totalAmount) * 100).toFixed(2));

                                                        %>
                                                        <td><%= taxPercentage %>% (‚Çπ<%= taxAmount %>)</td>
                                                        <td><%= transaction.paymentStatus %></td>
                                                        <td>
                                                            <a href="/admin/booking-detail/<%= transaction.bookingId._id %>" class="btn btn-sm btn-outline-warning mb-0 me-2"
                                                                title="Booking Details"><i
                                                                    class="bi bi-eye-fill"></i></a>

                                                        </td>

                                                    </tr>
                                                    <!-- <tr>

                                                        <td scope="1"> GPT3272 </td>
                                                        <td>BFL00152 </td>
                                                        <td>Addon Service </td>
                                                        <td>18-Jun-2025 </td>
                                                        <td>‚Çπ 10218</td>
                                                        <td> 161651051dfc66 </td>
                                                        <td>HDFC BANK</td>
                                                        <td>UPI</td>
                                                        <td>0% (0)</td>
                                                        <td>Under Process </td>
                                                        <td><button class="btn btn-sm btn-outline-warning mb-0 me-2"
                                                                title="Booking Details"><i
                                                                    class="bi bi-eye-fill"></i></button>

                                                        </td>

                                                    </tr> -->
                                                        <% }) %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="10" class="text-center">No payments found.</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                            
                                        </div>
                                        </div>
                                        <!-- Card body END -->

                                        <!-- Card footer START -->
                                        <div class="card-footer pt-1">
  <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
    <p class="mb-sm-0 text-center text-sm-start">
      Showing <%= (bookingPagination.page - 1) * bookingPagination.limit + 1 %>
      to <%= Math.min(bookingPagination.page * bookingPagination.limit, bookingPagination.total) %>
      of <%= bookingPagination.total %> entries
    </p>
    <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
      <ul class="pagination pagination-sm pagination-primary-soft mb-0">
        <% for(let i=1; i<=Math.ceil(bookingPagination.total / bookingPagination.limit); i++) { %>
          <li class="page-item <%= bookingPagination.page === i ? 'active' : '' %>">
            <!-- <a class="page-link" href="?id=<%= flight._id %>&page=<%= i %>#tab-2"><%= i %></a> -->
             <a class="page-link" href="?id=<%= flight._id %>&transactionPage=<%= i %>#tab-5"><%= i %></a>

          </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>
                                        <!-- Card footer END -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tab content 3 START -->
                        <div class="tab-pane show " id="tab-3">
  <div class="row">
    <div class="col-12 mx-auto">
      <div class="accordion accordion-icon accordion-bg-light" id="accordionExample2">

        <% if (requests && requests.length > 0) { %>
          <% requests.forEach((req, index) => { %>
            <div class="accordion-item mb-3">
              <h6 class="accordion-header font-base" id="heading-<%= index %>">
                <button class="accordion-button fw-bold rounded d-inline-block collapsed"
                  type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= index %>"
                  aria-expanded="false" aria-controls="collapse-<%= index %>">
                  Support Request Number : <%= req.requestId %>
                </button>
              </h6>
              <div id="collapse-<%= index %>" class="accordion-collapse collapse"
                aria-labelledby="heading-<%= index %>" data-bs-parent="#accordionExample2">
                <div class="accordion-body mt-3">
                  <div class="card shadow">
                    <div class="card-header border-bottom p-4">
                      <h6 class="mb-0"><%= req.subject %></h6>
                      <ul class="nav nav-divider">
                        <li class="nav-item">Last updated: <%= req.updatedAt.toLocaleDateString("en-GB") %></li>
                      </ul>
                    </div>
                    <div class="card-body p-4">
                      <div class="alert alert-warning text-right" role="alert">
                        <%= req.passengerName %> - <%= req.request %>
                      </div>
                    
                      <div class="replies mb-3 ">
                        <% if (req.reply && req.reply.length > 0) { %>
                          <% req.reply.forEach(r => { %>
                            <div class="border rounded mb-3">
                              <p><strong><%= r.sender %>:</strong> <%= r.message %></p>
                              <% if (r.amount) { %>
                                <div class="d-flex align-items-center gap-2">
                                  <span class="badge bg-info">Amount: ‚Çπ<%= r.amount %></span>
                                  <span class="badge <%= r.paymentStatus === 'Paid' ? 'bg-success' : 'bg-warning' %>">
                                    <%= r.paymentStatus || "Unpaid" %>
                                  </span>
                                </div>
                              <% } %>
                              <small class="text-muted"><%= r.date.toLocaleString("en-GB") %></small>
                            </div>
                          <% }) %>
                        <% } %>
                      </div>

                      <form class="send-reply-form" data-id="<%= req._id %>">
                        <div class="mb-2">
                          <textarea name="message" class="form-control" placeholder="Enter message" required></textarea>
                        </div>
                        <div class="mb-2">
                          <input type="number" name="amount" class="form-control" placeholder="Enter amount (optional)">
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">Send</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="border p-3 rounded d-lg-flex align-items-center justify-content-between text-center">
            <small class="py-3 py-lg-0 d-block">No Request Found</small>
          </div>
        <% } %>

      </div>
    </div>
  </div>
</div>

<script>
document.querySelectorAll(".send-reply-form").forEach(form => {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const requestId = form.dataset.id;
    const message = form.querySelector("[name='message']").value.trim();
    const amount = form.querySelector("[name='amount']").value;

    try {
      const res = await fetch(`/admin/send-reply/${requestId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, amount })
      });
      const data = await res.json();

      if (data.success) {
        Swal.fire("Success", data.message, "success");

        // append new reply above form
        const repliesDiv = form.closest(".accordion-body").querySelector(".replies");
        const newReply = document.createElement("div");
        newReply.className = "border rounded p-2 mb-2";
        newReply.innerHTML = `
          <p><strong>admin:</strong> ${data.reply.message}</p>
          ${data.reply.amount ? `
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-info">Amount: ‚Çπ${data.reply.amount}</span>
              <span class="badge ${data.reply.paymentStatus === "Paid" ? "bg-success" : "bg-warning"}">
                ${data.reply.paymentStatus}
              </span>
            </div>` : ""}
          <small class="text-muted">${new Date(data.reply.date).toLocaleString("en-GB")}</small>
        `;
        repliesDiv.appendChild(newReply);

        // reset form
        form.reset();
      } else {
        Swal.fire("Error", data.message, "error");
      }
    } catch (err) {
      Swal.fire("Error", "Something went wrong!", "error");
    }
  });
});
</script>

                        <!-- Tab content 4 START -->
                        <div class="tab-pane show  " id="tab-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border">
                                        <!-- Card header -->
                                        <div class="card-header border-bottom">
                                            <h5 class="card-header-title">All Activities</h5>
                                        </div>
                                        <!-- Card body START -->
                                        <div class="card-body">
                                            <div class="table-responsive">
                                            <table class="table table-ulogs">

                                                <thead class="thead-light">

                                                    <tr>

                                                        <th>Date</th>

                                                        <th>ID</th>

                                                        <th>Content</th>

                                                        <th>User</th>

                                                    </tr>

                                                </thead>

                                                <tbody>
                                                    <%
                                                    if(userActivities.length === 0) { %>
                                                        <tr>
                                                            <td colspan="4" class="text-center">No activities found.</td>
                                                        </tr>
                                                    <% } else { %>
                                                        <% userActivities.forEach((activity) => { %>
                                                            <tr>
                                                        <td><%= moment(activity.createdAt).format("DD-MMM-YYYY HH:mm") %></td>

                                                        <td><%= activity.booking.bookingId %></td>

                                                        <td><%= activity.content %></td>


                                                        <td><%= seller.name.toUpperCase() %></td>

                                                    </tr>
                                                        <% }) %>
                                                    <% } %>
                                                    %>
                                                    
                                                </tbody>
                                            </table>
                                            </div>
                                        </div>
                                        <!-- Card body END -->

                                        <!-- Card footer START -->
<div class="card-footer pt-1">
  <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
    <p class="mb-sm-0 text-center text-sm-start">
      Showing <%= (activityPagination.page - 1) * activityPagination.limit + 1 %>
      to <%= Math.min(activityPagination.page * activityPagination.limit, activityPagination.total) %>
      of <%= activityPagination.total %> entries
    </p>
    <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
      <ul class="pagination pagination-sm pagination-primary-soft mb-0">
        <% for(let i=1; i<=Math.ceil(activityPagination.total / activityPagination.limit); i++) { %>
          <li class="page-item <%= activityPagination.page === i ? 'active' : '' %>">
            <!-- <a class="page-link" href="?id=<%= flight._id %>&page=<%= i %>#tab-4"><%= i %></a> -->
             <a class="page-link" href="?id=<%= flight._id %>&activityPage=<%= i %>#tab-4"><%= i %></a>

          </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>
                                        <!-- Card footer END -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <!-- Page main content END -->
    </div>
    <!-- Page content END -->

        <!-- Wheelchair modal START -->
    <div class="modal fade" id="Wheelchair" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Title -->
                <div class="modal-header">
                    <h5 class="modal-title">Submit to Block for Sales</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Body -->
                <div class="modal-body p-3">
                    <div class="row g-4 mb-3">
                        <div class="col-sm-12 form-group"><label class="form-label" for="country">Reason For The
                                Block</label>
                            <textarea></textarea>
                        </div>



                    </div>
                    <div class="modal-footer bg-light mb-2"> <button
                            class="btn btn-sm btn-outline-primary mb-0">Submit
                            request</button> </div>
                    <h6 class="alert-heading h6">Instructions for Wheelchair Assistance</h6>
                    <ul>
                        <li>By processing, You accept Booking <a href="#">Terms of Services</a> and <a
                                href="#">Policy</a></li>
                        <li>Steps: Submit Request -> Our team will forward the request to the sales teams and once it is
                            accepted we will add the service cost. You have to pay the amount within the time. Once it
                            is completed the seller will be updated.</li>
                        <li>You should book it at least 48 hours before your flight's departure. provides wheelchair
                            assistance based on availability, so it's best to book in advance. </li>
                        <li>Some airlines not charge extra for providing wheelchair assistance. but the last moment case
                            they will charge.</li>
                        <li>Once request we will generate a support Id. it shows on manage supports tab </li>

                    </ul>
                </div>

            </div>
        </div>
    </div>
    <!-- Wheelchair modal END -->
     
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggleButtons = document.querySelectorAll('.toggle-inventory-btn');
  
  toggleButtons.forEach(button => {
    button.addEventListener('click', async () => {
      const id = button.getAttribute('data-id');
      const isBanned = button.getAttribute('data-banned') === 'true';
      const action = isBanned ? 'unblock' : 'block';

      // Show confirmation dialog using SweetAlert2
      Swal.fire({
        title: 'Are you sure?',
        text: `Do you want to ${action} this inventory?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: `Yes, ${action} it!`,
        cancelButtonText: 'No, cancel'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch(`/admin/toggle-inventory/${id}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
                // Remove CSRF token line if not configured, or add it if configured (see previous response)
              }
            });

            const data = await response.json();
            if (data.success) {
              // Update button state locally
              const newBanned = !isBanned;
              button.setAttribute('data-banned', newBanned);
              button.className = `btn ${newBanned ? 'btn-success-soft' : 'btn-danger-soft'} text-nowrap mb-0 me-2 toggle-inventory-btn`;
              button.innerHTML = `<i class="bi ${newBanned ? 'bi-check2-circle' : 'bi-ban'}"></i> ${newBanned ? 'Show' : 'Ban'}`;
              button.title = `Admin ${newBanned ? 'unblock' : 'block'} Sales`;

              // Show success message with SweetAlert2
              Swal.fire({
                icon: 'success',
                title: `Inventory ${newBanned ? 'blocked' : 'unblocked'} successfully!`,
                timer: 1500,
                showConfirmButton: false
              });
            } else {
              // Show error message with SweetAlert2
              Swal.fire({
                icon: 'error',
                title: 'Failed to toggle inventory status.',
                text: data.message || 'Please try again.'
              });
            }
          } catch (error) {
            console.error('Error toggling inventory:', error);
            Swal.fire({
              icon: 'error',
              title: 'An error occurred.',
              text: 'Please try again later.'
            });
          }
        }
      });
    });
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const saleStatusToggle = document.getElementById("saleStatus");
    const halfDaySaleToggle = document.getElementById("halfDaySale");
    const id = saleStatusToggle.getAttribute('data-id');

    // Toggle Sales Status
    saleStatusToggle.addEventListener("change", async function () {
        const isChecked = this.checked;

        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to ${isChecked ? "enable" : "disable"} Sales Status.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, confirm',
            cancelButtonText: 'Cancel'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/admin/toggle-sales-status/${id}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ saleStatus: isChecked })
                    });

                    const data = await response.json();
                    if (data.success) {
                        Swal.fire("Updated!", "Sales Status updated successfully.", "success");
                    } else {
                        Swal.fire("Failed!", "Could not update Sales Status.", "error");
                        this.checked = !isChecked; // rollback
                    }
                } catch (err) {
                    console.error("Error:", err);
                    Swal.fire("Error!", "Something went wrong!", "error");
                    this.checked = !isChecked; // rollback
                }
            } else {
                this.checked = !isChecked; // rollback if cancelled
            }
        });
    });

    // Toggle Half-Day Sale
    halfDaySaleToggle.addEventListener("change", async function () {
        const isChecked = this.checked;

        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to ${isChecked ? "enable" : "disable"} Half-Day Sale.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, confirm',
            cancelButtonText: 'Cancel'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/admin/toggle-halfday-sale/${id}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ halfDaySale: isChecked })
                    });

                    const data = await response.json();
                    if (data.success) {
                        Swal.fire("Updated!", "Half-Day Sale updated successfully.", "success");
                    } else {
                        Swal.fire("Failed!", "Could not update Half-Day Sale.", "error");
                        this.checked = !isChecked; // rollback
                    }
                } catch (err) {
                    console.error("Error:", err);
                    Swal.fire("Error!", "Something went wrong!", "error");
                    this.checked = !isChecked; // rollback
                }
            } else {
                this.checked = !isChecked; // rollback if cancelled
            }
        });
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const hash = window.location.hash;
  if (hash) {
    const tabTrigger = document.querySelector(`a[href="${hash}"]`);
    if (tabTrigger) {
      const tab = new bootstrap.Tab(tabTrigger);
      tab.show();
    }
  }

  // update hash when tab changes
  document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(link => {
    link.addEventListener("shown.bs.tab", e => {
      history.replaceState(null, null, e.target.getAttribute("href"));
    });
  });
});
</script>

<!-- **************** MAIN CONTENT END **************** -->

<%- include('./partials/footer') %>