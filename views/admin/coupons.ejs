<%- include('./partials/header') %>  
<main>   
  <!-- Sidebar START -->   
  <%- include('./partials/sideBar') %>   
  <!-- Sidebar END -->    

  <!-- Page content START -->   
  <div class="page-content">     
    <!-- Top bar START -->     
    <%- include('./partials/topBar') %>     
    <!-- Top bar END -->      

    <div class="page-content-wrapper p-xxl-4">
      
<script>
  const successMsg = "<%= success ? success : '' %>";
  const errorMsg = "<%= error ? error : '' %>";

  if (successMsg) {
    Swal.fire({
      icon: "success",
      title: "Success",
      text: successMsg,
      confirmButtonColor: "#198754"
    });
  }

  if (errorMsg) {
    Swal.fire({
      icon: "error",
      title: "Error",
      text: errorMsg,
      confirmButtonColor: "#d33"
    });
  }
</script>

      <!-- Create Coupon Section -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Create New Coupon</h4>
          <button class="btn btn-light btn-sm" id="toggleCreateBtn">+</button>
        </div>
        <div id="createCouponSection" style="display: none;" class="mt-3">
          <form action="/admin/add-coupon" method="POST">
            <div class="mb-3">
              <label>Coupon Name</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label>Coupon Code</label>
              <input type="text" name="code" class="form-control" required>
            </div>
            <div class="mb-3">
              <label>Discount (%)</label>
              <input type="number" name="discount" class="form-control" required>
            </div>
            <div class="mb-3">
              <label>Expiry Date</label>
              <input type="date" name="expiry" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-success">Create Coupon</button>
          </form>
        </div>
      </div>

      <hr>

      <!-- Coupons List Section -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">All Coupons</h4>
          <button class="btn btn-light btn-sm" id="toggleListBtn">+</button>
        </div>
        <div id="couponListSection" style="display: none;" class="mt-3">
          <table class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Code</th>
                <th>Discount</th>
                <th>Expiry</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% coupons.forEach(coupon => { %>
                <tr>
                  <td><%= coupon.name %></td>
                  <td><%= coupon.code %></td>
                  <td><%= coupon.discount %>%</td>
                  <td><%= coupon.expiry.toDateString() %></td>
                  <td>
                    <form action="/admin/delete-coupon/<%= coupon._id %>" method="POST" style="display:inline;" onsubmit="return confirmDelete()">
                      <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>

      <hr>

      <!-- Promotions Section -->
      <div>
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Send Promotions</h4>
          <button class="btn btn-light btn-sm" id="togglePromotionBtn">+</button>
        </div>
        <div id="promotionSection" style="display: none;" class="mt-3">
          <form action="/admin/send-promotion" method="POST">
            <div class="mb-3">
              <label>Send To:</label>
              <select name="sendTo" class="form-control" required>
                <option value="all">All Users</option>
                <option value="subscribed">Subscribed Users</option>
                <option value="inactive">Inactive Users</option>
              </select>
            </div>
            <div class="mb-3">
              <label>Subject:</label>
              <input type="text" name="subject" class="form-control" required>
            </div>
            <div class="mb-3">
              <label>Message:</label>
              <textarea name="message" rows="4" class="form-control" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Send Promotion</button>
          </form>
        </div>
      </div>

    </div>   
  </div> 
</main>  

<%- include('./partials/footer') %> 

<script>
  function confirmDelete() {
    return confirm("Are you sure you want to delete this coupon?");
  }

  // Toggle Create Coupon
  const toggleCreateBtn = document.getElementById('toggleCreateBtn');
  const createCouponSection = document.getElementById('createCouponSection');
  toggleCreateBtn.addEventListener('click', () => {
    if (createCouponSection.style.display === 'none') {
      createCouponSection.style.display = 'block';
      toggleCreateBtn.textContent = '-';
    } else {
      createCouponSection.style.display = 'none';
      toggleCreateBtn.textContent = '+';
    }
  });

  // Toggle Coupons List
  const toggleListBtn = document.getElementById('toggleListBtn');
  const couponListSection = document.getElementById('couponListSection');
  toggleListBtn.addEventListener('click', () => {
    if (couponListSection.style.display === 'none') {
      couponListSection.style.display = 'block';
      toggleListBtn.textContent = '-';
    } else {
      couponListSection.style.display = 'none';
      toggleListBtn.textContent = '+';
    }
  });

  // Toggle Promotions
  const togglePromotionBtn = document.getElementById('togglePromotionBtn');
  const promotionSection = document.getElementById('promotionSection');
  togglePromotionBtn.addEventListener('click', () => {
    if (promotionSection.style.display === 'none') {
      promotionSection.style.display = 'block';
      togglePromotionBtn.textContent = '-';
    } else {
      promotionSection.style.display = 'none';
      togglePromotionBtn.textContent = '+';
    }
  });
</script>
